!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).firebase,t.firebase.INTERNAL.modularAPIs)}(this,function(Wd,Yd){"use strict";try{!(function(){function t(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var l,e=t(Wd);function n(e){const n=[];let r=0;for(let s=0;s<e.length;s++){let t=e.charCodeAt(s);t<128?n[r++]=t:(t<2048?n[r++]=t>>6|192:(55296==(64512&t)&&s+1<e.length&&56320==(64512&e.charCodeAt(s+1))?(t=65536+((1023&t)<<10)+(1023&e.charCodeAt(++s)),n[r++]=t>>18|240,n[r++]=t>>12&63|128):n[r++]=t>>12|224,n[r++]=t>>6&63|128),n[r++]=63&t|128)}return n}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(n,t){if(!Array.isArray(n))throw Error("encodeByteArray takes an array as a parameter");this.init_();var r=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const s=[];for(let u=0;u<n.length;u+=3){var i=n[u],o=u+1<n.length,a=o?n[u+1]:0,h=u+2<n.length,c=h?n[u+2]:0;let t=(15&a)<<2|c>>6,e=63&c;h||(e=64,o||(t=64)),s.push(r[i>>2],r[(3&i)<<4|a>>4],r[t],r[e])}return s.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(n(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,r=0;for(;n<t.length;){var s,i,o=t[n++];o<128?e[r++]=String.fromCharCode(o):191<o&&o<224?(s=t[n++],e[r++]=String.fromCharCode((31&o)<<6|63&s)):239<o&&o<365?(i=((7&o)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))):(s=t[n++],i=t[n++],e[r++]=String.fromCharCode((15&o)<<12|(63&s)<<6|63&i))}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let h=0;h<t.length;){var s=n[t.charAt(h++)],i=h<t.length?n[t.charAt(h)]:0;++h;var o=h<t.length?n[t.charAt(h)]:64;++h;var a=h<t.length?n[t.charAt(h)]:64;if(++h,null==s||null==i||null==o||null==a)throw Error();r.push(s<<2|i>>4),64!==o&&(r.push(i<<4&240|o>>2),64!==a&&r.push(o<<6&192|a))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},o=function(t){return t=t,e=n(t),r.encodeByteArray(e,!0).replace(/\./g,"");var e};function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function m(t){return t&&t._delegate?t._delegate:t}class i{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}(tl=l=l||{})[tl.DEBUG=0]="DEBUG",tl[tl.VERBOSE=1]="VERBOSE",tl[tl.INFO=2]="INFO",tl[tl.WARN=3]="WARN",tl[tl.ERROR=4]="ERROR",tl[tl.SILENT=5]="SILENT";const a={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},h=l.INFO,c={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},u=(t,e,...n)=>{if(!(e<t.logLevel)){var r=(new Date).toISOString(),s=c[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)}};var f,g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p={},v=g||self;function y(){}function w(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function b(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var E="closure_uid_"+(1e9*Math.random()>>>0),T=0;function I(t,e,n){return t.call.apply(t.bind,arguments)}function _(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function S(t,e,n){return(S=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?I:_).apply(null,arguments)}function N(e){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function A(t,i){function e(){}e.prototype=i.prototype,t.Z=i.prototype,t.prototype=new e,(t.prototype.constructor=t).Vb=function(t,e,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[e].apply(t,r)}}function D(){this.s=this.s,this.o=this.o}var C={};D.prototype.s=!1,D.prototype.na=function(){var t,e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,t=Object.prototype.hasOwnProperty.call(e,E)&&e[E]||(e[E]=++T),delete C[t])},D.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const x=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},k=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){var r=t.length,s="string"==typeof t?t.split(""):t;for(let i=0;i<r;i++)i in s&&e.call(n,s[i],i,t)};function R(){return Array.prototype.concat.apply([],arguments)}function L(e){var n=e.length;if(0<n){const r=Array(n);for(let t=0;t<n;t++)r[t]=e[t];return r}return[]}function O(t){return/^[\s\xa0]*$/.test(t)}var M,F=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function P(t,e){return-1!=t.indexOf(e)}function V(t,e){return t<e?-1:e<t?1:0}t:{var U=v.navigator;if(U){U=U.userAgent;if(U){M=U;break t}}M=""}function q(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function B(t){const e={};for(const n in t)e[n]=t[n];return e}var j="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function K(e){let n,r;for(let s=1;s<arguments.length;s++){for(n in r=arguments[s])e[n]=r[n];for(let t=0;t<j.length;t++)n=j[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function $(t){return $[" "](t),t}$[" "]=y;var G,H=P(M,"Opera"),z=P(M,"Trident")||P(M,"MSIE"),Q=P(M,"Edge"),W=Q||z,Y=P(M,"Gecko")&&!(P(M.toLowerCase(),"webkit")&&!P(M,"Edge"))&&!(P(M,"Trident")||P(M,"MSIE"))&&!P(M,"Edge"),X=P(M.toLowerCase(),"webkit")&&!P(M,"Edge");function J(){var t=v.document;return t?t.documentMode:void 0}t:{var Z="",tt=(tt=M,Y?/rv:([^\);]+)(\)|;)/.exec(tt):Q?/Edge\/([\d\.]+)/.exec(tt):z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(tt):X?/WebKit\/(\S+)/.exec(tt):H?/(?:Version)[ \/]?(\S+)/.exec(tt):void 0);if(tt&&(Z=tt?tt[1]:""),z){tt=J();if(null!=tt&&tt>parseFloat(Z)){G=String(tt);break t}}G=Z}var et={};function nt(){return t=function(){let t=0;var e=F(String(G)).split("."),n=F("9").split("."),r=Math.max(e.length,n.length);for(let o=0;0==t&&o<r;o++)for(var s=e[o]||"",i=n[o]||"";s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],(0!=s[0].length||0!=i[0].length)&&(t=V(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||V(0==s[2].length,0==i[2].length)||V(s[2],i[2]),s=s[3],i=i[3],0==t););return 0<=t},e=et,Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9);var t,e}var rt=v.document&&z&&(J()||parseInt(G,10))||void 0,st=function(){if(!v.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{v.addEventListener("test",y,e),v.removeEventListener("test",y,e)}catch(t){}return t}();function it(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function ot(t,e){if(it.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(Y){t:{try{$(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:at[t.pointerType]||"",this.state=t.state,(this.i=t).defaultPrevented&&ot.Z.h.call(this)}}it.prototype.h=function(){this.defaultPrevented=!0},A(ot,it);var at={2:"touch",3:"pen",4:"mouse"};ot.prototype.h=function(){ot.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ht="closure_listenable_"+(1e6*Math.random()|0),ct=0;function ut(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ia=s,this.key=++ct,this.ca=this.fa=!1}function lt(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function dt(t){this.src=t,this.g={},this.h=0}function ft(t,e){var n,r,s,i=e.type;i in t.g&&(n=t.g[i],(s=0<=(r=x(n,e)))&&Array.prototype.splice.call(n,r,1),s&&(lt(e),0==t.g[i].length&&(delete t.g[i],t.h--)))}function gt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==r)return s}return-1}dt.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=gt(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new ut(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var mt="closure_lm_"+(1e6*Math.random()|0),pt={};function yt(t,e,n,r,s){if(r&&r.once)return function t(e,n,r,s,i){if(Array.isArray(n)){for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);return null}r=_t(r);return e&&e[ht]?e.O(n,r,b(s)?!!s.capture:!!s,i):vt(e,n,r,!0,s,i)}(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)yt(t,e[i],n,r,s);return null}return n=_t(n),t&&t[ht]?t.N(e,n,b(r)?!!r.capture:!!r,s):vt(t,e,n,!1,r,s)}function vt(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o,a=b(s)?!!s.capture:!!s,h=Tt(t);if(h||(t[mt]=h=new dt(t)),(n=h.add(e,n,r,a,i)).proxy)return n;if(o=Et,r=function t(e){return o.call(t.src,t.listener,e)},(n.proxy=r).src=t,r.listener=n,t.addEventListener)void 0===(s=!st?a:s)&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(bt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function wt(t){var e,n,r;"number"!=typeof t&&t&&!t.ca&&((e=t.src)&&e[ht]?ft(e.i,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(bt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Tt(e))?(ft(n,t),0==n.h&&(n.src=null,e[mt]=null)):lt(t)))}function bt(t){return t in pt?pt[t]:pt[t]="on"+t}function Et(t,e){var n,r;return t=!!t.ca||(e=new ot(e,this),n=t.listener,r=t.ia||t.src,t.fa&&wt(t),n.call(r,e))}function Tt(t){return(t=t[mt])instanceof dt?t:null}var It="__closure_events_fn_"+(1e9*Math.random()>>>0);function _t(e){return"function"==typeof e?e:(e[It]||(e[It]=function(t){return e.handleEvent(t)}),e[It])}function St(){D.call(this),this.i=new dt(this),(this.P=this).I=null}function Nt(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e?e=new it(e,t):e instanceof it?e.target=e.target||t:(o=e,K(e=new it(r,t),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=e.g=n[s],o=At(i,r,!0,e)&&o;if(o=At(i=e.g=t,r,!0,e)&&o,o=At(i,r,!1,e)&&o,n)for(s=0;s<n.length;s++)o=At(i=e.g=n[s],r,!1,e)&&o}function At(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o,a,h=e[i];h&&!h.ca&&h.capture==n&&(o=h.listener,a=h.ia||h.src,h.fa&&ft(t.i,h),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}A(St,D),St.prototype[ht]=!0,St.prototype.removeEventListener=function(t,e,n,r){!function t(e,n,r,s,i){if(Array.isArray(n))for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);else s=b(s)?!!s.capture:!!s,r=_t(r),e&&e[ht]?(e=e.i,(n=String(n).toString())in e.g&&-1<(r=gt(o=e.g[n],r,s,i))&&(lt(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete e.g[n],e.h--))):(e=e&&Tt(e))&&(n=e.g[n.toString()],(r=(e=-1)<(e=n?gt(n,r,s,i):e)?n[e]:null)&&wt(r))}(this,t,e,n,r)},St.prototype.M=function(){if(St.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)lt(n[r]);delete e.g[t],e.h--}}this.I=null},St.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},St.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var Dt=v.JSON.stringify;var Ct,xt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}(()=>new kt,t=>t.reset());class kt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Rt(t,e){var n;Ct||(n=v.Promise.resolve(void 0),Ct=function(){n.then(Mt)}),Lt||(Ct(),Lt=!0),Ot.add(t,e)}var Lt=!1,Ot=new class{constructor(){this.h=this.g=null}add(t,e){const n=xt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Mt(){for(var t;t=function(){var t=Ot;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}();){try{t.h.call(t.g)}catch(t){!function(t){v.setTimeout(()=>{throw t},0)}(t)}var e=xt;e.j(t),e.h<100&&(e.h++,t.next=e.g,e.g=t)}Lt=!1}function Ft(t,e){St.call(this),this.h=t||1,this.g=e||v,this.j=S(this.kb,this),this.l=Date.now()}function Pt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Vt(t,e,n){if("function"==typeof t)n&&(t=S(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=S(t.handleEvent,t)}return 2147483647<Number(e)?-1:v.setTimeout(t,e||0)}A(Ft,St),(f=Ft.prototype).da=!1,f.S=null,f.kb=function(){var t;this.da&&(0<(t=Date.now()-this.l)&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Nt(this,"tick"),this.da&&(Pt(this),this.start())))},f.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},f.M=function(){Ft.Z.M.call(this),Pt(this),delete this.g};class Ut extends D{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:function t(e){e.g=Vt(()=>{e.g=null,e.i&&(e.i=!1,t(e))},e.j);var n=e.h;e.h=null,e.m.apply(null,n)}(this)}M(){super.M(),this.g&&(v.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function qt(t){D.call(this),this.h=t,this.g={}}A(qt,D);var Bt=[];function jt(t,e,n,r){Array.isArray(n)||(n&&(Bt[0]=n.toString()),n=Bt);for(var s=0;s<n.length;s++){var i=yt(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function Kt(t){q(t.g,function(t,e){this.g.hasOwnProperty(e)&&wt(t)},t),t.g={}}function $t(){this.g=!0}function Gt(t,e,n,r){t.info(function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Dt(n)}catch(t){return e}}(t,n)+(r?" "+r:"")})}qt.prototype.M=function(){qt.Z.M.call(this),Kt(this)},qt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},$t.prototype.Aa=function(){this.g=!1},$t.prototype.info=function(){};var Ht={},zt=null;function Qt(){return zt=zt||new St}function Wt(t){it.call(this,Ht.Ma,t)}function Yt(){var t=Qt();Nt(t,new Wt(t))}function Xt(t,e){it.call(this,Ht.STAT_EVENT,t),this.stat=e}function Jt(t){var e=Qt();Nt(e,new Xt(e,t))}function Zt(t,e){it.call(this,Ht.Na,t),this.size=e}function te(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return v.setTimeout(function(){t()},e)}Ht.Ma="serverreachability",A(Wt,it),Ht.STAT_EVENT="statevent",A(Xt,it),Ht.Na="timingevent",A(Zt,it);var ee={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},ne={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function re(){}function se(t){return t.h||(t.h=t.i())}function ie(){}re.prototype.h=null;g={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function oe(){it.call(this,"d")}function ae(){it.call(this,"c")}function he(){}function ce(t,e,n,r){this.l=t,this.j=e,this.m=n,this.X=r||1,this.V=new qt(this),this.P=de,this.W=new Ft(t=W?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ue}function ue(){this.i=null,this.g="",this.h=!1}A(oe,it),A(ae,it),A(he,re),he.prototype.g=function(){return new XMLHttpRequest},he.prototype.i=function(){return{}};var le=new he,de=45e3,fe={},ge={};function me(t,e,n){t.K=1,t.v=Pe(ke(e)),t.s=n,t.U=!0,pe(t,null)}function pe(t,e){t.F=Date.now(),we(t),t.A=ke(t.v);var o,a,h,c,u,l,n=t.A,r=t.X;Array.isArray(r)||(r=[String(r)]),Ye(n.h,"t",r),t.C=0,n=t.l.H,t.h=new ue,t.g=Xn(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Ut(S(t.Ia,t,t.g),t.O)),jt(t.V,t.g,"readystatechange",t.gb),e=t.H?B(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Yt(),o=t.j,a=t.u,h=t.A,c=t.m,u=t.X,l=t.s,o.info(function(){if(o.g)if(l)for(var t="",e=l.split("&"),n=0;n<e.length;n++){var r,s,i=e[n].split("=");1<i.length&&(r=i[0],i=i[1],t=2<=(s=r.split("_")).length&&"type"==s[1]?t+(r+"=")+i+"&":t+(r+"=redacted&"))}else t=null;else t=l;return"XMLHTTP REQ ("+c+") [attempt "+u+"]: "+a+"\n"+h+"\n"+t})}function ye(t){return t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function ve(t,e,n){let r=!0,s;for(;!t.I&&t.C<n.length;){if(s=(o=n,h=a=void 0,a=(i=t).C,-1==(h=o.indexOf("\n",a))?ge:(a=Number(o.substring(a,h)),isNaN(a)?fe:(h+=1)+a>o.length?ge:(o=o.substr(h,a),i.C=h+a,o))),s==ge){4==e&&(t.o=4,Jt(14),r=!1),Gt(t.j,t.m,null,"[Incomplete Response]");break}if(s==fe){t.o=4,Jt(15),Gt(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Gt(t.j,t.m,s,null),_e(t,s)}var i,o,a,h;ye(t)&&s!=ge&&s!=fe&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,Jt(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Kn(e),e.L=!0,Jt(11))):(Gt(t.j,t.m,n,"[Invalid Chunked Response]"),Ie(t),Te(t))}function we(t){t.Y=Date.now()+t.P,be(t,t.P)}function be(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=te(S(t.eb,t),e)}function Ee(t){t.B&&(v.clearTimeout(t.B),t.B=null)}function Te(t){0==t.l.G||t.I||Hn(t.l,t)}function Ie(t){Ee(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Pt(t.W),Kt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function _e(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||rn(n.i,t)))if(n.I=t.N,!t.J&&rn(n.i,t)&&3==n.G){try{var r=n.Ca.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Gn(n),On(n)}jn(n),Jt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=te(S(n.ab,n),6e3));if(nn(n.i)<=1&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Qn(n,11)}else if(!t.J&&n.g!=t||Gn(n),!O(e))for(s=n.Ca.g.parse(e),e=0;e<s.length;e++){var i=s[e];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var h,c,u,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=t.g;m&&(!(h=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(c=r.i).g&&(P(h,"spdy")||P(h,"quic")||P(h,"h2"))&&(c.j=c.l,c.g=new Set,c.h&&(sn(c,c.h),c.h=null)),!r.D||(u=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=u,Fe(r.F,r.D,u))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=t;(r=n).oa=Yn(r,r.H?r.la:null,r.W),g.J?(on(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(Ee(d),we(d)),r.g=g):Bn(r),0<n.l.length&&Pn(n)}else"stop"!=i[0]&&"close"!=i[0]||Qn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Qn(n,7):Ln(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Yt()}catch(t){}}function Se(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(w(t)||"string"==typeof t)k(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(w(t)||"string"==typeof t)for(var n=[],r=t.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,t)n[r++]=s;for(var s=(r=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(w(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}}function Ne(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Ne)for(n=t.T(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Ae(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var r=t.g[e];De(t.h,r)&&(t.g[n++]=r),e++}t.g.length=n}if(t.i!=t.g.length){for(var s={},n=e=0;e<t.g.length;)De(s,r=t.g[e])||(s[t.g[n++]=r]=1),e++;t.g.length=n}}function De(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(f=ce.prototype).setTimeout=function(t){this.P=t},f.gb=function(t){t=t.target;const e=this.L;e&&3==Dn(t)?e.l():this.Ia(t)},f.Ia=function(t){try{if(t==this.g)t:{var e=Dn(this.g),n=this.g.Da();this.g.ba();if(!(e<3)&&(3!=e||W||this.g&&(this.h.h||this.g.ga()||Cn(this.g)))){this.I||4!=e||7==n||Yt(),Ee(this);var r=this.g.ba();this.N=r;e:if(ye(this)){var s=Cn(this.g);t="";var i=s.length,o=4==Dn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ie(this),Te(this);var a="";break e}this.h.i=new v.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,t+=this.h.i.decode(s[n],{stream:o&&n==i-1});s.splice(0,i),this.h.g+=t,this.C=0,a=this.h.g}else a=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=e,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){e:{if(this.g){var h,c=this.g;if((h=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!O(h)){var u=h;break e}}u=null}if(!(r=u)){this.i=!1,this.o=3,Jt(12),Ie(this),Te(this);break t}Gt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,_e(this,r)}this.U?(ve(this,e,a),W&&this.i&&3==e&&(jt(this.V,this.W,"tick",this.fb),this.W.start())):(Gt(this.j,this.m,a,null),_e(this,a)),4==e&&Ie(this),this.i&&!this.I&&(4==e?Hn(this.l,this):(this.i=!1,we(this)))}else 400==r&&0<a.indexOf("Unknown SID")?(this.o=3,Jt(12)):(this.o=0,Jt(13)),Ie(this),Te(this)}}}catch(t){}var l,d,f,g,m,p,y},f.fb=function(){var t,e;this.g&&(t=Dn(this.g),e=this.g.ga(),this.C<e.length&&(Ee(this),ve(this,t,e),this.i&&4!=t&&we(this)))},f.cancel=function(){this.I=!0,Ie(this)},f.eb=function(){this.B=null;var t,e,n=Date.now();0<=n-this.Y?(t=this.j,e=this.A,t.info(function(){return"TIMEOUT: "+e}),2!=this.K&&(Yt(),Jt(17)),Ie(this),this.o=2,Te(this)):be(this,this.Y-n)},(f=Ne.prototype).R=function(){Ae(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},f.T=function(){return Ae(this),this.g.concat()},f.get=function(t,e){return De(this.h,t)?this.h[t]:e},f.set=function(t,e){De(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},f.forEach=function(t,e){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);t.call(e,i,s,this)}};var Ce=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function xe(t,e){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof xe?(this.g=void 0!==e?e:t.g,Re(this,t.j),this.s=t.s,Le(this,t.i),Oe(this,t.m),this.l=t.l,e=t.h,(n=new He).i=e.i,e.g&&(n.g=new Ne(e.g),n.h=e.h),Me(this,n),this.o=t.o):t&&(n=String(t).match(Ce))?(this.g=!!e,Re(this,n[1]||"",!0),this.s=Ve(n[2]||""),Le(this,n[3]||"",!0),Oe(this,n[4]),this.l=Ve(n[5]||"",!0),Me(this,n[6]||"",!0),this.o=Ve(n[7]||"")):(this.g=!!e,this.h=new He(null,this.g))}function ke(t){return new xe(t)}function Re(t,e,n){t.j=n?Ve(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Le(t,e,n){t.i=n?Ve(e,!0):e}function Oe(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Me(t,e,n){var r,s;e instanceof He?(t.h=e,r=t.h,(s=t.g)&&!r.j&&(ze(r),r.i=null,r.g.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(Qe(this,e),Ye(this,n,t))},r)),r.j=s):(n||(e=Ue(e,$e)),t.h=new He(e,t.g))}function Fe(t,e,n){t.h.set(e,n)}function Pe(t){return Fe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ve(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ue(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,qe),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function qe(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}xe.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Ue(e,Be,!0),":");var n=this.i;return!n&&"file"!=e||(t.push("//"),(e=this.s)&&t.push(Ue(e,Be,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ue(n,"/"==n.charAt(0)?Ke:je,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Ue(n,Ge)),t.join("")};var Be=/[#\/\?@]/g,je=/[#\?:]/g,Ke=/[#\?]/g,$e=/[#\?@]/g,Ge=/#/g;function He(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function ze(n){n.g||(n.g=new Ne,n.h=0,n.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],e(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function Qe(t,e){ze(t),e=Xe(t,e),De(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,De((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Ae(t)))}function We(t,e){return ze(t),e=Xe(t,e),De(t.g.h,e)}function Ye(t,e,n){Qe(t,e),0<n.length&&(t.i=null,t.g.set(Xe(t,e),L(n)),t.h+=n.length)}function Xe(t,e){return e=String(e),e=t.j?e.toLowerCase():e}(f=He.prototype).add=function(t,e){ze(this),this.i=null,t=Xe(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},f.forEach=function(n,r){ze(this),this.g.forEach(function(t,e){k(t,function(t){n.call(r,t,e,this)},this)},this)},f.T=function(){ze(this);for(var t=this.g.R(),e=this.g.T(),n=[],r=0;r<e.length;r++)for(var s=t[r],i=0;i<s.length;i++)n.push(e[r]);return n},f.R=function(t){ze(this);var e=[];if("string"==typeof t)We(this,t)&&(e=R(e,this.g.get(Xe(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=R(e,t[n])}return e},f.set=function(t,e){return ze(this),this.i=null,We(this,t=Xe(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},f.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},f.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++)for(var r=e[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),t.push(o)}return this.i=t.join("&")};var Je=class{constructor(t,e){this.h=t,this.g=e}};function Ze(t){this.l=t||10,t=v.PerformanceNavigationTiming?0<(t=v.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(v.g&&v.g.Ea&&v.g.Ea()&&v.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var tn;function en(t){return t.h||t.g&&t.g.size>=t.j}function nn(t){return t.h?1:t.g?t.g.size:0}function rn(t,e){return t.h?t.h==e:t.g&&t.g.has(e)}function sn(t,e){t.g?t.g.add(e):t.h=e}function on(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function an(e){if(null!=e.h)return e.i.concat(e.h.D);if(null==e.g||0===e.g.size)return L(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}}function hn(){}function cn(){this.g=new hn}function un(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function ln(t){this.l=t.$b||null,this.j=t.ib||!1}function dn(t,e){St.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=fn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Ze.prototype.cancel=function(){if(this.i=an(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},hn.prototype.stringify=function(t){return v.JSON.stringify(t,void 0)},hn.prototype.parse=function(t){return v.JSON.parse(t,void 0)},A(ln,re),ln.prototype.g=function(){return new dn(this.l,this.j)},ln.prototype.i=(tn={},function(){return tn}),A(dn,St);var fn=0;function gn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function mn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,pn(t)}function pn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(f=dn.prototype).open=function(t,e){if(this.readyState!=fn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,pn(this)},f.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||v).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},f.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,mn(this)),this.readyState=fn},f.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,pn(this)),this.g&&(this.readyState=3,pn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==v.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;gn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},f.Sa=function(t){var e;this.g&&(this.u&&t.value?this.response.push(t.value):this.u||(e=t.value||new Uint8Array(0),(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)),(t.done?mn:pn)(this),3==this.readyState&&gn(this))},f.Ua=function(t){this.g&&(this.response=this.responseText=t,mn(this))},f.Ta=function(t){this.g&&(this.response=t,mn(this))},f.ha=function(){this.g&&mn(this)},f.setRequestHeader=function(t,e){this.v.append(t,e)},f.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},f.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(dn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var yn=v.JSON.parse;function vn(t){St.call(this),this.headers=new Ne,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=wn,this.K=this.L=!1}A(vn,St);var wn="",bn=/^https?$/i,En=["POST","PUT"];function Tn(t){return"content-type"==t.toLowerCase()}function In(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,_n(t),Nn(t)}function _n(t){t.D||(t.D=!0,Nt(t,"complete"),Nt(t,"error"))}function Sn(t){if(t.h&&void 0!==p&&(!t.C[1]||4!=Dn(t)||2!=t.ba()))if(t.v&&4==Dn(t))Vt(t.Fa,0,t);else if(Nt(t,"readystatechange"),4==Dn(t)){t.h=!1;try{var e,n,r,s,i=t.ba();t:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break t;default:o=!1}if((e=o)||((n=0===i)&&(!(s=String(t.H).match(Ce)[1]||null)&&v.self&&v.self.location&&(s=(r=v.self.location.protocol).substr(0,r.length-1)),n=!bn.test(s?s.toLowerCase():"")),e=n),e)Nt(t,"complete"),Nt(t,"success");else{t.m=6;try{var a=2<Dn(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",_n(t)}}finally{Nn(t)}}}function Nn(t,e){if(t.g){An(t);const n=t.g,r=t.C[0]?y:null;t.g=null,t.C=null,e||Nt(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function An(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(v.clearTimeout(t.A),t.A=null)}function Dn(t){return t.g?t.g.readyState:0}function Cn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case wn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function xn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=function(t){let n="";return q(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Fe(t,e,n))}function kn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Rn(t){this.za=0,this.l=[],this.h=new $t,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=kn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=kn("baseRetryDelayMs",5e3,t),this.$a=kn("retryDelaySeedMs",1e4,t),this.Ya=kn("forwardChannelMaxRetries",2,t),this.ra=kn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new Ze(t&&t.concurrentRequestLimit),this.Ca=new cn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Ln(t){var e,n;Mn(t),3==t.G&&(e=t.V++,Fe(n=ke(t.F),"SID",t.J),Fe(n,"RID",e),Fe(n,"TYPE","terminate"),Un(t,n),(e=new ce(t,t.h,e,void 0)).K=2,e.v=Pe(ke(n)),n=!1,!(n=v.navigator&&v.navigator.sendBeacon?v.navigator.sendBeacon(e.v.toString(),""):n)&&v.Image&&((new Image).src=e.v,n=!0),n||(e.g=Xn(e.l,null),e.g.ea(e.v)),e.F=Date.now(),we(e)),Wn(t)}function On(t){t.g&&(Kn(t),t.g.cancel(),t.g=null)}function Mn(t){On(t),t.u&&(v.clearTimeout(t.u),t.u=null),Gn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&v.clearTimeout(t.m),t.m=null)}function Fn(t,e){t.l.push(new Je(t.Za++,e)),3==t.G&&Pn(t)}function Pn(t){en(t.i)||t.m||(t.m=!0,Rt(t.Ha,t),t.C=0)}function Vn(t,e){var n=e?e.m:t.V++,r=ke(t.F);Fe(r,"SID",t.J),Fe(r,"RID",n),Fe(r,"AID",t.U),Un(t,r),t.o&&t.s&&xn(r,t.o,t.s),n=new ce(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=qn(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),sn(t.i,n),me(n,r,e)}function Un(t,n){t.j&&Se({},function(t,e){Fe(n,e,t)})}function qn(t,e,r){r=Math.min(t.l.length,r);var s=t.j?S(t.j.Oa,t.j,t):null;t:{var i=t.l;let n=-1;for(;;){const h=["count="+r];-1==n?0<r?(n=i[0].h,h.push("ofs="+n)):n=0:h.push("ofs="+n);let t=!0;for(let e=0;e<r;e++){var o=i[e].h,a=i[e].g;if((o-=n)<0)n=Math.max(0,i[e].h-100),t=!1;else try{!function(t,r,e){const s=e||"";try{Se(t,function(t,e){let n=t;b(t)&&(n=Dt(t)),r.push(s+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(s+"type="+encodeURIComponent("_badmap")),t}}(a,h,"req"+o+"_")}catch(t){s&&s(a)}}if(t){s=h.join("&");break t}}}return t=t.l.splice(0,r),e.D=t,s}function Bn(t){t.g||t.u||(t.Y=1,Rt(t.Ga,t),t.A=0)}function jn(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=te(S(t.Ga,t),zn(t,t.A)),t.A++,1)}function Kn(t){null!=t.B&&(v.clearTimeout(t.B),t.B=null)}function $n(t){t.g=new ce(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=ke(t.oa);Fe(e,"RID","rpc"),Fe(e,"SID",t.J),Fe(e,"CI",t.N?"0":"1"),Fe(e,"AID",t.U),Un(t,e),Fe(e,"TYPE","xmlhttp"),t.o&&t.s&&xn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Pe(ke(e)),n.s=null,n.U=!0,pe(n,t)}function Gn(t){null!=t.v&&(v.clearTimeout(t.v),t.v=null)}function Hn(t,e){var n,r,s,i=null;if(t.g==e){Gn(t),Kn(t),t.g=null;var o=2}else{if(!rn(t.i,e))return;i=e.D,on(t.i,e),o=1}if(t.I=e.N,0!=t.G)if(e.i)1==o?(i=e.s?e.s.length:0,e=Date.now()-e.F,n=t.C,Nt(o=Qt(),new Zt(o,i)),Pn(t)):Bn(t);else if(3==(n=e.o)||0==n&&0<t.I||(1!=o||(s=e,nn((r=t).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=te(S(r.Ha,r,s),zn(r,r.C)),r.C++,0))))&&(2!=o||!jn(t)))switch(i&&0<i.length&&(e=t.i,e.i=e.i.concat(i)),n){case 1:Qn(t,5);break;case 4:Qn(t,10);break;case 3:Qn(t,6);break;default:Qn(t,2)}}function zn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Qn(t,e){var n,r;t.h.info("Error code "+e),2==e?(n=null,t.j&&(n=null),r=S(t.jb,t),n||(n=new xe("//www.google.com/images/cleardot.gif"),v.location&&"http"==v.location.protocol||Re(n,"https"),Pe(n)),function(t,e){var n=new $t;if(v.Image){const r=new Image;r.onload=N(un,n,r,"TestLoadImage: loaded",!0,e),r.onerror=N(un,n,r,"TestLoadImage: error",!1,e),r.onabort=N(un,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=N(un,n,r,"TestLoadImage: timeout",!1,e),v.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)):Jt(2),t.G=0,t.j&&t.j.va(e),Wn(t),Mn(t)}function Wn(t){t.G=0,t.I=-1,t.j&&(0==an(t.i).length&&0==t.l.length||(t.i.i.length=0,L(t.l),t.l.length=0),t.j.ua())}function Yn(t,e,n){let r=(a=n)instanceof xe?ke(a):new xe(a,void 0);var s,i,o,a,h;return""!=r.i?(e&&Le(r,e+"."+r.i),Oe(r,r.m)):(h=v.location,r=(s=h.protocol,i=e?e+"."+h.hostname:h.hostname,o=+h.port,a=n,h=new xe(null,void 0),s&&Re(h,s),i&&Le(h,i),o&&Oe(h,o),a&&(h.l=a),h)),t.aa&&q(t.aa,function(t,e){Fe(r,e,t)}),e=t.D,n=t.sa,e&&n&&Fe(r,e,n),Fe(r,"VER",t.ma),Un(t,r),r}function Xn(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new vn(new ln({ib:!0})):new vn(t.qa)).L=t.H,e}function Jn(){}function Zn(){if(z&&!(10<=Number(rt)))throw Error("Environmental error: no available transport.")}function tr(t,e){St.call(this),this.g=new Rn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!O(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!O(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new rr(this)}function er(t){oe.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function nr(){ae.call(this),this.status=1}function rr(t){this.g=t}(f=vn.prototype).ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||le).g(),this.C=this.u?se(this.u):se(le),this.g.onreadystatechange=S(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void In(this,t)}t=n||"";const s=new Ne(this.headers);r&&Se(r,function(t,e){s.set(e,t)}),r=function(e){t:{var n=Tn,r=e.length,s="string"==typeof e?e.split(""):e;for(let t=0;t<r;t++)if(t in s&&n.call(void 0,s[t],t,e)){n=t;break t}n=-1}return n<0?null:"string"==typeof e?e.charAt(n):e[n]}(s.T()),n=v.FormData&&t instanceof v.FormData,0<=x(En,e)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(t,e){this.g.setRequestHeader(e,t)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{An(this),0<this.B&&((this.K=(i=this.g,z&&nt()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=S(this.pa,this)):this.A=Vt(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){In(this,t)}var i},f.pa=function(){void 0!==p&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Nt(this,"timeout"),this.abort(8))},f.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Nt(this,"complete"),Nt(this,"abort"),Nn(this))},f.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Nn(this,!0)),vn.Z.M.call(this)},f.Fa=function(){this.s||(this.F||this.v||this.l?Sn(this):this.cb())},f.cb=function(){Sn(this)},f.ba=function(){try{return 2<Dn(this)?this.g.status:-1}catch(t){return-1}},f.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},f.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),yn(e)}},f.Da=function(){return this.m},f.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(f=Rn.prototype).ma=8,f.G=1,f.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},f.Ha=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.V=Math.floor(1e5*Math.random()),e=this.V++;const i=new ce(this,this.h,e,void 0);let t=this.s;if(this.P&&(t?(t=B(t),K(t,this.P)):t=this.P),null===this.o&&(i.H=t),this.ja)t:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break t}if(4096===n||r===this.l.length-1){n=r+1;break t}}n=1e3}else n=1e3;n=qn(this,i,n),Fe(r=ke(this.F),"RID",e),Fe(r,"CVER",22),this.D&&Fe(r,"X-HTTP-Session-Id",this.D),Un(this,r),this.o&&t&&xn(r,this.o,t),sn(this.i,i),this.Ra&&Fe(r,"TYPE","init"),this.ja?(Fe(r,"$req",n),Fe(r,"SID","null"),i.$=!0,me(i,r,null)):me(i,r,n),this.G=2}}else 3==this.G&&(e?Vn(this,e):0==this.l.length||en(this.i)||Vn(this))},f.Ga=function(){var t;this.u=null,$n(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(t=2*this.O,this.h.info("BP detection timer enabled: "+t),this.B=te(S(this.bb,this),t))},f.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,Jt(10),On(this),$n(this))},f.ab=function(){null!=this.v&&(this.v=null,On(this),jn(this),Jt(19))},f.jb=function(t){t?(this.h.info("Successfully pinged google.com"),Jt(2)):(this.h.info("Failed to ping google.com"),Jt(1))},(f=Jn.prototype).xa=function(){},f.wa=function(){},f.va=function(){},f.ua=function(){},f.Oa=function(){},Zn.prototype.g=function(t,e){return new tr(t,e)},A(tr,St),tr.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Rt(S(t.hb,t,e))),Jt(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=Yn(t,null,t.W),Pn(t)},tr.prototype.close=function(){Ln(this.g)},tr.prototype.u=function(t){var e;"string"==typeof t?((e={}).__data__=t,Fn(this.g,e)):this.v?((e={}).__data__=Dt(t),Fn(this.g,e)):Fn(this.g,t)},tr.prototype.M=function(){this.g.j=null,delete this.j,Ln(this.g),delete this.g,tr.Z.M.call(this)},A(er,oe),A(nr,ae),A(rr,Jn),rr.prototype.xa=function(){Nt(this.g,"a")},rr.prototype.wa=function(t){Nt(this.g,new er(t))},rr.prototype.va=function(t){Nt(this.g,new nr)},rr.prototype.ua=function(){Nt(this.g,"b")},Zn.prototype.createWebChannel=Zn.prototype.g,tr.prototype.send=tr.prototype.u,tr.prototype.open=tr.prototype.m,ee.NO_ERROR=0,ee.TIMEOUT=8,ee.HTTP_ERROR=6,ne.COMPLETE="complete",(ie.EventType=g).OPEN="a",g.CLOSE="b",g.ERROR="c",g.MESSAGE="d",St.prototype.listen=St.prototype.N,vn.prototype.listenOnce=vn.prototype.O,vn.prototype.getLastError=vn.prototype.La,vn.prototype.getLastErrorCode=vn.prototype.Da,vn.prototype.getStatus=vn.prototype.ba,vn.prototype.getResponseJson=vn.prototype.Qa,vn.prototype.getResponseText=vn.prototype.ga,vn.prototype.send=vn.prototype.ea;var sr,ir=Qt,or=ee,ar=ne,hr=Ht,cr=10,ur=11,lr=ln,dr=ie,fr=vn;const gr="@firebase/firestore";class mr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}mr.UNAUTHENTICATED=new mr(null),mr.GOOGLE_CREDENTIALS=new mr("google-credentials-uid"),mr.FIRST_PARTY=new mr("first-party-uid"),mr.MOCK_USER=new mr("mock-user");let pr="9.5.0";const yr=new class{constructor(t){this.name=t,this._logLevel=h,this._logHandler=u,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in l))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?a[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...t),this._logHandler(this,l.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...t),this._logHandler(this,l.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,l.INFO,...t),this._logHandler(this,l.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,l.WARN,...t),this._logHandler(this,l.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...t),this._logHandler(this,l.ERROR,...t)}}("@firebase/firestore");function vr(){return yr.logLevel}function wr(t,...e){var n;yr.logLevel<=l.DEBUG&&(n=e.map(Tr),yr.debug(`Firestore (${pr}): ${t}`,...n))}function br(t,...e){var n;yr.logLevel<=l.ERROR&&(n=e.map(Tr),yr.error(`Firestore (${pr}): ${t}`,...n))}function Er(t,...e){var n;yr.logLevel<=l.WARN&&(n=e.map(Tr),yr.warn(`Firestore (${pr}): ${t}`,...n))}function Tr(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function Ir(t="Unexpected state"){var e=`FIRESTORE (${pr}) INTERNAL ASSERTION FAILED: `+t;throw br(e),new Error(e)}function _r(t){t||Ir()}const Sr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Nr extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ar{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}class Dr{constructor(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${t}`}}class Cr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(mr.UNAUTHENTICATED))}shutdown(){}}class xr{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class kr{constructor(t){this.t=t,this.currentUser=mr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,n){let r=this.i;const s=t=>this.i!==r?(r=this.i,n(t)):Promise.resolve();let i=new Ar;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Ar,e.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const t=i;e.enqueueRetryable(async()=>{await t.promise,await s(this.currentUser)})},a=t=>{wr("FirebaseCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(t=>a(t)),setTimeout(()=>{var t;this.auth||((t=this.t.getImmediate({optional:!0}))?a(t):(wr("FirebaseCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Ar))},0),o()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(wr("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(_r("string"==typeof t.accessToken),new Dr(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var t=this.auth&&this.auth.getUid();return _r(null===t||"string"==typeof t),new mr(t)}}class Rr{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=mr.FIRST_PARTY}get authHeaders(){const t={"X-Goog-AuthUser":this.l},e=this.h.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.m&&(t["X-Goog-Iam-Authorization-Token"]=this.m),t}}class Lr{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Rr(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable(()=>e(mr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Or{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.g(t),this.p=t=>e.writeSequenceNumber(t))}g(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){var t=++this.previousValue;return this.p&&this.p(t),t}}Or.T=-1;class Mr{static I(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/e.length)*e.length;let r="";for(;r.length<20;){var s=function(e){const n="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(e);if(n&&"function"==typeof n.getRandomValues)n.getRandomValues(r);else for(let t=0;t<e;t++)r[t]=Math.floor(256*Math.random());return r}(40);for(let t=0;t<s.length;++t)r.length<20&&s[t]<n&&(r+=e.charAt(s[t]%e.length))}return r}}function Fr(t,e){return t<e?-1:e<t?1:0}function Pr(t,n,r){return t.length===n.length&&t.every((t,e)=>r(t,n[e]))}function Vr(t){return t+"\0"}class Ur{constructor(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Ur.fromMillis(Date.now())}static fromDate(t){return Ur.fromMillis(t.getTime())}static fromMillis(t){var e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Ur(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Fr(this.nanoseconds,t.nanoseconds):Fr(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class qr{constructor(t){this.timestamp=t}static fromTimestamp(t){return new qr(t)}static min(){return new qr(new Ur(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Br(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function jr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Kr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class $r{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ir(),void 0===n?n=t.length-e:n>t.length-e&&Ir(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===$r.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof $r?t.forEach(t=>{e.push(t)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return this.construct(this.segments,this.offset+(t=void 0===t?1:t),this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Gr extends $r{construct(t,e,n){return new Gr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(0<=n.indexOf("//"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(t=>0<t.length))}return new Gr(e)}static emptyPath(){return new Gr([])}}const Hr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class zr extends $r{construct(t,e,n){return new zr(t,e,n)}static isValidIdentifier(t){return Hr.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),t=!zr.isValidIdentifier(t)?"`"+t+"`":t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new zr(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new Nr(Sr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Nr(Sr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?i=!i:"."!==e||i?n+=e:s(),r++}if(s(),i)throw new Nr(Sr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new zr(e)}static emptyPath(){return new zr([])}}class Qr{constructor(t){(this.fields=t).sort(zr.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Pr(this.fields,t.fields,(t,e)=>t.isEqual(e))}}class Wr{constructor(t){this.binaryString=t}static fromBase64String(t){var e=atob(t);return new Wr(e)}static fromUint8Array(t){var e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Wr(e)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Fr(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Wr.EMPTY_BYTE_STRING=new Wr("");const Yr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Xr(e){if(_r(!!e),"string"!=typeof e)return{seconds:Jr(e.seconds),nanos:Jr(e.nanos)};{let t=0;var n=Yr.exec(e);_r(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),t=Number(n));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}}function Jr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Zr(t){return"string"==typeof t?Wr.fromBase64String(t):Wr.fromUint8Array(t)}function ts(t){var e;return"server_timestamp"===(null===(e=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===e?void 0:e.stringValue)}function es(t){var e=Xr(t.mapValue.fields.__local_write_time__.timestampValue);return new Ur(e.seconds,e.nanos)}function ns(t){return null==t}function rs(t){return 0===t&&1/t==-1/0}function ss(t){return"number"==typeof t&&Number.isInteger(t)&&!rs(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class is{constructor(t){this.path=t}static fromPath(t){return new is(Gr.fromString(t))}static fromName(t){return new is(Gr.fromString(t).popFirst(5))}hasCollectionId(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===Gr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Gr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new is(new Gr(t.slice()))}}function os(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?ts(t)?4:10:Ir()}function as(r,s){var t,e,n=os(r);if(n!==os(s))return!1;switch(n){case 0:return!0;case 1:return r.booleanValue===s.booleanValue;case 4:return es(r).isEqual(es(s));case 3:return function(t){if("string"==typeof r.timestampValue&&"string"==typeof t.timestampValue&&r.timestampValue.length===t.timestampValue.length)return r.timestampValue===t.timestampValue;var e=Xr(r.timestampValue),n=Xr(t.timestampValue);return e.seconds===n.seconds&&e.nanos===n.nanos}(s);case 5:return r.stringValue===s.stringValue;case 6:return e=s,Zr(r.bytesValue).isEqual(Zr(e.bytesValue));case 7:return r.referenceValue===s.referenceValue;case 8:return t=s,Jr((e=r).geoPointValue.latitude)===Jr(t.geoPointValue.latitude)&&Jr(e.geoPointValue.longitude)===Jr(t.geoPointValue.longitude);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Jr(t.integerValue)===Jr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){var n=Jr(t.doubleValue),r=Jr(e.doubleValue);return n===r?rs(n)===rs(r):isNaN(n)&&isNaN(r)}return!1}(r,s);case 9:return Pr(r.arrayValue.values||[],s.arrayValue.values||[],as);case 10:return function(t){const e=t.mapValue.fields||{},n=s.mapValue.fields||{};if(Br(e)!==Br(n))return!1;for(const t in e)if(e.hasOwnProperty(t)&&(void 0===n[t]||!as(e[t],n[t])))return!1;return!0}(r);default:return Ir()}}function hs(t,e){return void 0!==(t.values||[]).find(t=>as(t,e))}function cs(t,e){var n,r,s,i,o=os(t),a=os(e);if(o!==a)return Fr(o,a);switch(o){case 0:return 0;case 1:return Fr(t.booleanValue,e.booleanValue);case 2:return r=e,s=Jr(t.integerValue||t.doubleValue),i=Jr(r.integerValue||r.doubleValue),s<i?-1:i<s?1:s===i?0:isNaN(s)?isNaN(i)?0:-1:1;case 3:return us(t.timestampValue,e.timestampValue);case 4:return us(es(t),es(e));case 5:return Fr(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Zr(t),r=Zr(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){var n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=Fr(n[s],r[s]);if(0!==e)return e}return Fr(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return n=t.geoPointValue,r=e.geoPointValue,0!==(i=Fr(Jr(n.latitude),Jr(r.latitude)))?i:Fr(Jr(n.longitude),Jr(r.longitude));case 9:return function(t,e){var n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=cs(n[s],r[s]);if(e)return e}return Fr(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let a=0;a<r.length&&a<i.length;++a){const e=Fr(r[a],i[a]);if(0!==e)return e;var o=cs(n[r[a]],s[i[a]]);if(0!==o)return o}return Fr(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Ir()}}function us(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Fr(t,e);var n=Xr(t),r=Xr(e),s=Fr(n.seconds,r.seconds);return 0!==s?s:Fr(n.nanos,r.nanos)}function ls(t){return function i(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Xr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Zr(t.bytesValue).toBase64():"referenceValue"in t?(e=t.referenceValue,is.fromName(e).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=i(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${i(t.fields[s])}`;return n+"}"}(t.mapValue):Ir();var e}(t)}function ds(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function fs(t){return t&&"integerValue"in t}function gs(t){return!!t&&"arrayValue"in t}function ms(t){return t&&"nullValue"in t}function ps(t){return t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function ys(t){return t&&"mapValue"in t}function vs(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const n={mapValue:{fields:{}}};return jr(e.mapValue.fields,(t,e)=>n.mapValue.fields[t]=vs(e)),n}if(e.arrayValue){const r={arrayValue:{values:[]}};for(let t=0;t<(e.arrayValue.values||[]).length;++t)r.arrayValue.values[t]=vs(e.arrayValue.values[t]);return r}return Object.assign({},e)}class ws{constructor(t){this.value=t}static empty(){return new ws({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(t=(t.mapValue.fields||{})[n.get(e)],!ys(t))return null;return t=(t.mapValue.fields||{})[n.lastSegment()],t||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=vs(e)}setAll(t){let n=zr.emptyPath(),r={},s=[];t.forEach((t,e)=>{if(!n.isImmediateParentOf(e)){const t=this.getFieldsMap(n);this.applyChanges(t,r,s),r={},s=[],n=e.popLast()}t?r[e.lastSegment()]=vs(t):s.push(e.lastSegment())});var e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(t){const e=this.field(t.popLast());ys(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return as(this.value,t.value)}getFieldsMap(e){let n=this.value;n.mapValue.fields||(n.mapValue={fields:{}});for(let r=0;r<e.length;++r){let t=n.mapValue.fields[e.get(r)];ys(t)&&t.mapValue.fields||(t={mapValue:{fields:{}}},n.mapValue.fields[e.get(r)]=t),n=t}return n.mapValue.fields}applyChanges(n,t,e){jr(t,(t,e)=>n[t]=e);for(const t of e)delete n[t]}clone(){return new ws(vs(this.value))}}class bs{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new bs(t,0,qr.min(),ws.empty(),0)}static newFoundDocument(t,e,n){return new bs(t,1,e,n,0)}static newNoDocument(t,e){return new bs(t,2,e,ws.empty(),0)}static newUnknownDocument(t,e){return new bs(t,3,e,ws.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=ws.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=ws.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof bs&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new bs(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Es{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.A=null}}function Ts(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Es(t,e,n,r,s,i,o)}function Is(t){const e=t;if(null===e.A){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(t=>function(t){return t.field.canonicalString()+t.op.toString()+ls(t.value)}(t)).join(","),t+="|ob:",t+=e.orderBy.map(t=>function(t){return t.field.canonicalString()+t.dir}(t)).join(","),ns(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Fs(e.startAt)),e.endAt&&(t+="|ub:",t+=Fs(e.endAt)),e.A=t}return e.A}function _s(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let o=0;o<t.orderBy.length;o++)if(n=t.orderBy[o],r=e.orderBy[o],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r,s,i;if(t.filters.length!==e.filters.length)return!1;for(let a=0;a<t.filters.length;a++)if(s=t.filters[a],i=e.filters[a],s.op!==i.op||!s.field.isEqual(i.field)||!as(s.value,i.value))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Us(t.startAt,e.startAt)&&Us(t.endAt,e.endAt)}function Ss(t){return is.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Ns extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.R(t,e,n):new As(t,e,n):"array-contains"===e?new ks(t,n):"in"===e?new Rs(t,n):"not-in"===e?new Ls(t,n):"array-contains-any"===e?new Os(t,n):new Ns(t,e,n)}static R(t,e,n){return new("in"===e?Ds:Cs)(t,n)}matches(t){var e=t.data.field(this.field);return"!="===this.op?null!==e&&this.P(cs(e,this.value)):null!==e&&os(this.value)===os(e)&&this.P(cs(e,this.value))}P(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return 0<t;case">=":return 0<=t;default:return Ir()}}v(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class As extends Ns{constructor(t,e,n){super(t,e,n),this.key=is.fromName(n.referenceValue)}matches(t){var e=is.comparator(t.key,this.key);return this.P(e)}}class Ds extends Ns{constructor(t,e){super(t,"in",e),this.keys=xs(0,e)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class Cs extends Ns{constructor(t,e){super(t,"not-in",e),this.keys=xs(0,e)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function xs(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map(t=>is.fromName(t.referenceValue))}class ks extends Ns{constructor(t,e){super(t,"array-contains",e)}matches(t){var e=t.data.field(this.field);return gs(e)&&hs(e.arrayValue,this.value)}}class Rs extends Ns{constructor(t,e){super(t,"in",e)}matches(t){var e=t.data.field(this.field);return null!==e&&hs(this.value.arrayValue,e)}}class Ls extends Ns{constructor(t,e){super(t,"not-in",e)}matches(t){if(hs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var e=t.data.field(this.field);return null!==e&&!hs(this.value.arrayValue,e)}}class Os extends Ns{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!gs(e)||!e.arrayValue.values)&&e.arrayValue.values.some(t=>hs(this.value.arrayValue,t))}}class Ms{constructor(t,e){this.position=t,this.before=e}}function Fs(t){return`${t.before?"b":"a"}:${t.position.map(t=>ls(t)).join(",")}`}class Ps{constructor(t,e="asc"){this.field=t,this.dir=e}}function Vs(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?is.comparator(is.fromName(o.referenceValue),n.key):cs(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function Us(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!as(t.position[n],e.position[n]))return!1;return!0}class qs{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.V=null,this.S=null,this.startAt,this.endAt}}function Bs(t,e,n,r,s,i,o,a){return new qs(t,e,n,r,s,i,o,a)}function js(t){return new qs(t)}function Ks(t){return!ns(t.limit)&&"F"===t.limitType}function $s(t){return!ns(t.limit)&&"L"===t.limitType}function Gs(t){return 0<t.explicitOrderBy.length?t.explicitOrderBy[0].field:null}function Hs(t){for(const e of t.filters)if(e.v())return e.field;return null}function zs(t){return null!==t.collectionGroup}function Qs(e){const n=e;if(null===n.V){n.V=[];const e=Hs(n),t=Gs(n);if(null!==e&&null===t)e.isKeyField()||n.V.push(new Ps(e)),n.V.push(new Ps(zr.keyField(),"asc"));else{let t=!1;for(const r of n.explicitOrderBy)n.V.push(r),r.field.isKeyField()&&(t=!0);if(!t){const e=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.V.push(new Ps(zr.keyField(),e))}}}return n.V}function Ws(t){const e=t;if(!e.S)if("F"===e.limitType)e.S=Ts(e.path,e.collectionGroup,Qs(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const s of Qs(e)){const e="desc"===s.dir?"asc":"desc";t.push(new Ps(s.field,e))}var n=e.endAt?new Ms(e.endAt.position,!e.endAt.before):null,r=e.startAt?new Ms(e.startAt.position,!e.startAt.before):null;e.S=Ts(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.S}function Ys(t,e,n){return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Xs(t,e){return _s(Ws(t),Ws(e))&&t.limitType===e.limitType}function Js(t){return`${Is(Ws(t))}|lt:${t.limitType}`}function Zs(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),0<t.filters.length&&(e+=`, filters: [${t.filters.map(t=>{return`${(e=t).field.canonicalString()} ${e.op} ${ls(e.value)}`;var e}).join(", ")}]`),ns(t.limit)||(e+=", limit: "+t.limit),0<t.orderBy.length&&(e+=`, orderBy: [${t.orderBy.map(t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t)).join(", ")}]`),t.startAt&&(e+=", startAt: "+Fs(t.startAt)),t.endAt&&(e+=", endAt: "+Fs(t.endAt)),`Target(${e})`}(Ws(t))}; limitType=${t.limitType})`}function ti(n,t){return t.isFoundDocument()&&(e=n,s=(r=t).key.path,null!==e.collectionGroup?r.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(s):is.isDocumentKey(e.path)?e.path.isEqual(s):e.path.isImmediateParentOf(s))&&function(t){for(const e of n.explicitOrderBy)if(!e.field.isKeyField()&&null===t.data.field(e.field))return;return 1}(t)&&function(t){for(const e of n.filters)if(!e.matches(t))return;return 1}(t)&&(e=t,(!(t=n).startAt||Vs(t.startAt,Qs(t),e))&&(!t.endAt||!Vs(t.endAt,Qs(t),e)));var e,r,s}function ei(s){return(t,e)=>{let n=!1;for(const r of Qs(s)){const s=function(t,s,e){var n=t.field.isKeyField()?is.comparator(s.key,e.key):function(t,e){var n=s.data.field(t),r=e.data.field(t);return null!==n&&null!==r?cs(n,r):Ir()}(t.field,e);switch(t.dir){case"asc":return n;case"desc":return-1*n;default:return Ir()}}(r,t,e);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function ni(t,e){if(t.D){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:rs(e)?"-0":e}}function ri(t){return{integerValue:""+t}}function si(t,e){return ss(e)?ri(e):ni(t,e)}class ii{constructor(){this._=void 0}}function oi(t,e){return t instanceof di?fs(n=e)||n&&"doubleValue"in n?e:{integerValue:0}:null;var n}class ai extends ii{}class hi extends ii{constructor(t){super(),this.elements=t}}function ci(t,e){const n=gi(e);for(const e of t.elements)n.some(t=>as(t,e))||n.push(e);return{arrayValue:{values:n}}}class ui extends ii{constructor(t){super(),this.elements=t}}function li(t,e){let n=gi(e);for(const e of t.elements)n=n.filter(t=>!as(t,e));return{arrayValue:{values:n}}}class di extends ii{constructor(t,e){super(),this.N=t,this.C=e}}function fi(t){return Jr(t.integerValue||t.doubleValue)}function gi(t){return gs(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class mi{constructor(t,e){this.field=t,this.transform=e}}class pi{constructor(t,e){this.version=t,this.transformResults=e}}class yi{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new yi}static exists(t){return new yi(void 0,t)}static updateTime(t){return new yi(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function vi(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class wi{}function bi(t,e,n){t instanceof _i?function(t,e,n){const r=t.value.clone(),s=Ai(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Si?function(t,e,n){if(!vi(t.precondition,e))return e.convertToUnknownDocument(n.version);const r=Ai(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Ni(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):e.convertToNoDocument(n.version).setHasCommittedMutations()}function Ei(t,e,n){t instanceof _i?function(t,e,n){if(vi(t.precondition,e)){const r=t.value.clone(),s=Di(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(Ii(e),r).setHasLocalMutations()}}(t,e,n):t instanceof Si?function(t,e,n){if(vi(t.precondition,e)){const r=Di(t.fieldTransforms,n,e),s=e.data;s.setAll(Ni(t)),s.setAll(r),e.convertToFoundDocument(Ii(e),s).setHasLocalMutations()}}(t,e,n):(e=e,vi(t.precondition,e)&&e.convertToNoDocument(qr.min()))}function Ti(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&(n=t.fieldTransforms,r=e.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Pr(n,r,(t,e)=>function(t,e){return t.field.isEqual(e.field)&&(t=t.transform,e=e.transform,t instanceof hi&&e instanceof hi||t instanceof ui&&e instanceof ui?Pr(t.elements,e.elements,as):t instanceof di&&e instanceof di?as(t.C,e.C):t instanceof ai&&e instanceof ai)}(t,e)))&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask)));var n,r}function Ii(t){return t.isFoundDocument()?t.version:qr.min()}class _i extends wi{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Si extends wi{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Ni(n){const r=new Map;return n.fieldMask.fields.forEach(t=>{var e;t.isEmpty()||(e=n.data.field(t),r.set(t,e))}),r}function Ai(t,e,n){const r=new Map;_r(t.length===n.length);for(let u=0;u<n.length;u++){var s=t[u],i=s.transform,o=e.data.field(s.field);r.set(s.field,(a=i,h=o,c=n[u],a instanceof hi?ci(a,h):a instanceof ui?li(a,h):c))}var a,h,c;return r}function Di(t,e,n){const r=new Map;for(const c of t){const t=c.transform,u=n.data.field(c.field);r.set(c.field,(s=t,i=u,o=e,h=a=void 0,s instanceof ai?function(){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:o.seconds,nanos:o.nanoseconds}}}};return i&&(t.fields.__previous_value__=i),{mapValue:t}}():s instanceof hi?ci(s,i):s instanceof ui?li(s,i):(a=oi(s=s,i),h=fi(a)+fi(s.C),fs(a)&&fs(s.C)?ri(h):ni(s.N,h))))}var s,i,o,a,h;return r}class Ci extends wi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class xi extends wi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class ki{constructor(t){this.count=t}}function Ri(t){switch(t){default:return Ir(),0;case Sr.CANCELLED:case Sr.UNKNOWN:case Sr.DEADLINE_EXCEEDED:case Sr.RESOURCE_EXHAUSTED:case Sr.INTERNAL:case Sr.UNAVAILABLE:case Sr.UNAUTHENTICATED:return;case Sr.INVALID_ARGUMENT:case Sr.NOT_FOUND:case Sr.ALREADY_EXISTS:case Sr.PERMISSION_DENIED:case Sr.FAILED_PRECONDITION:case Sr.ABORTED:case Sr.OUT_OF_RANGE:case Sr.UNIMPLEMENTED:case Sr.DATA_LOSS:return 1}}function Li(t){if(void 0===t)return br("GRPC error has no .code"),Sr.UNKNOWN;switch(t){case sr.OK:return Sr.OK;case sr.CANCELLED:return Sr.CANCELLED;case sr.UNKNOWN:return Sr.UNKNOWN;case sr.DEADLINE_EXCEEDED:return Sr.DEADLINE_EXCEEDED;case sr.RESOURCE_EXHAUSTED:return Sr.RESOURCE_EXHAUSTED;case sr.INTERNAL:return Sr.INTERNAL;case sr.UNAVAILABLE:return Sr.UNAVAILABLE;case sr.UNAUTHENTICATED:return Sr.UNAUTHENTICATED;case sr.INVALID_ARGUMENT:return Sr.INVALID_ARGUMENT;case sr.NOT_FOUND:return Sr.NOT_FOUND;case sr.ALREADY_EXISTS:return Sr.ALREADY_EXISTS;case sr.PERMISSION_DENIED:return Sr.PERMISSION_DENIED;case sr.FAILED_PRECONDITION:return Sr.FAILED_PRECONDITION;case sr.ABORTED:return Sr.ABORTED;case sr.OUT_OF_RANGE:return Sr.OUT_OF_RANGE;case sr.UNIMPLEMENTED:return Sr.UNIMPLEMENTED;case sr.DATA_LOSS:return Sr.DATA_LOSS;default:return Ir()}}(ne=sr=sr||{})[ne.OK=0]="OK",ne[ne.CANCELLED=1]="CANCELLED",ne[ne.UNKNOWN=2]="UNKNOWN",ne[ne.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ne[ne.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ne[ne.NOT_FOUND=5]="NOT_FOUND",ne[ne.ALREADY_EXISTS=6]="ALREADY_EXISTS",ne[ne.PERMISSION_DENIED=7]="PERMISSION_DENIED",ne[ne.UNAUTHENTICATED=16]="UNAUTHENTICATED",ne[ne.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ne[ne.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ne[ne.ABORTED=10]="ABORTED",ne[ne.OUT_OF_RANGE=11]="OUT_OF_RANGE",ne[ne.UNIMPLEMENTED=12]="UNIMPLEMENTED",ne[ne.INTERNAL=13]="INTERNAL",ne[ne.UNAVAILABLE=14]="UNAVAILABLE",ne[ne.DATA_LOSS=15]="DATA_LOSS";class Oi{constructor(t,e){this.comparator=t,this.root=e||Fi.EMPTY}insert(t,e){return new Oi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Fi.BLACK,null,null))}remove(t){return new Oi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Fi.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(n){this.inorderTraversal((t,e)=>(n(t,e),!1))}toString(){const n=[];return this.inorderTraversal((t,e)=>(n.push(`${t}:${e}`),!1)),`{${n.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Mi(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Mi(this.root,t,this.comparator,!1)}getReverseIterator(){return new Mi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Mi(this.root,t,this.comparator,!0)}}class Mi{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();var e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Fi{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Fi.RED,this.left=null!=r?r:Fi.EMPTY,this.right=null!=s?s:Fi.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Fi(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;var s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Fi.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Fi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){var t=this.copy(null,null,Fi.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){var t=this.copy(null,null,Fi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){var t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ir();if(this.right.isRed())throw Ir();var t=this.left.check();if(t!==this.right.check())throw Ir();return t+(this.isRed()?0:1)}}Fi.EMPTY=null,Fi.RED=!0,Fi.BLACK=!1,Fi.EMPTY=new class{constructor(){this.size=0}get key(){throw Ir()}get value(){throw Ir()}get color(){throw Ir()}get left(){throw Ir()}get right(){throw Ir()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Fi(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Pi{constructor(t){this.comparator=t,this.data=new Oi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(n){this.data.inorderTraversal((t,e)=>(n(t),!1))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Vi(this.data.getIterator())}getIteratorFrom(t){return new Vi(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof Pi))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(t){const e=new Pi(this.comparator);return e.data=t,e}}class Vi{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Ui=new Oi(is.comparator);const qi=new Oi(is.comparator);const Bi=new Oi(is.comparator);const ji=new Pi(is.comparator);function Ki(...t){let e=ji;for(const n of t)e=e.add(n);return e}const $i=new Pi(Fr);class Gi{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Hi.createSynthesizedTargetChangeForCurrentChange(t,e)),new Gi(qr.min(),n,$i,Ui,Ki())}}class Hi{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Hi(Wr.EMPTY_BYTE_STRING,e,Ki(),Ki(),Ki())}}class zi{constructor(t,e,n,r){this.k=t,this.removedTargetIds=e,this.key=n,this.$=r}}class Qi{constructor(t,e){this.targetId=t,this.O=e}}class Wi{constructor(t,e,n=Wr.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class Yi{constructor(){this.F=0,this.M=Zi(),this.L=Wr.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(t){0<t.approximateByteSize()&&(this.U=!0,this.L=t)}W(){let n=Ki(),r=Ki(),s=Ki();return this.M.forEach((t,e)=>{switch(e){case 0:n=n.add(t);break;case 2:r=r.add(t);break;case 1:s=s.add(t);break;default:Ir()}}),new Hi(this.L,this.B,n,r,s)}G(){this.U=!1,this.M=Zi()}H(t,e){this.U=!0,this.M=this.M.insert(t,e)}J(t){this.U=!0,this.M=this.M.remove(t)}Y(){this.F+=1}X(){--this.F}Z(){this.U=!0,this.B=!0}}class Xi{constructor(t){this.tt=t,this.et=new Map,this.nt=Ui,this.st=Ji(),this.it=new Pi(Fr)}rt(t){for(const e of t.k)t.$&&t.$.isFoundDocument()?this.ot(e,t.$):this.ct(e,t.key,t.$);for(const n of t.removedTargetIds)this.ct(n,t.key,t.$)}at(n){this.forEachTarget(n,t=>{const e=this.ut(t);switch(n.state){case 0:this.ht(t)&&e.j(n.resumeToken);break;case 1:e.X(),e.q||e.G(),e.j(n.resumeToken);break;case 2:e.X(),e.q||this.removeTarget(t);break;case 3:this.ht(t)&&(e.Z(),e.j(n.resumeToken));break;case 4:this.ht(t)&&(this.lt(t),e.j(n.resumeToken));break;default:Ir()}})}forEachTarget(t,n){0<t.targetIds.length?t.targetIds.forEach(n):this.et.forEach((t,e)=>{this.ht(e)&&n(e)})}ft(t){const e=t.targetId,n=t.O.count,r=this.dt(e);if(r){const t=r.target;if(Ss(t))if(0===n){const n=new is(t.path);this.ct(e,n,bs.newNoDocument(n,qr.min()))}else _r(1===n);else this.wt(e)!==n&&(this.lt(e),this.it=this.it.add(e))}}_t(r){const s=new Map;this.et.forEach((t,e)=>{var n=this.dt(e);if(n){if(t.current&&Ss(n.target)){const s=new is(n.target.path);null!==this.nt.get(s)||this.gt(e,s)||this.ct(e,s,bs.newNoDocument(s,r))}t.K&&(s.set(e,t.W()),t.G())}});let i=Ki();this.st.forEach((t,e)=>{let n=!0;e.forEachWhile(t=>{var e=this.dt(t);return!e||2===e.purpose||(n=!1)}),n&&(i=i.add(t))});var t=new Gi(r,s,this.it,this.nt,i);return this.nt=Ui,this.st=Ji(),this.it=new Pi(Fr),t}ot(t,e){var n;this.ht(t)&&(n=this.gt(t,e.key)?2:0,this.ut(t).H(e.key,n),this.nt=this.nt.insert(e.key,e),this.st=this.st.insert(e.key,this.yt(e.key).add(t)))}ct(t,e,n){if(this.ht(t)){const r=this.ut(t);this.gt(t,e)?r.H(e,1):r.J(e),this.st=this.st.insert(e,this.yt(e).delete(t)),n&&(this.nt=this.nt.insert(e,n))}}removeTarget(t){this.et.delete(t)}wt(t){var e=this.ut(t).W();return this.tt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Y(t){this.ut(t).Y()}ut(t){let e=this.et.get(t);return e||(e=new Yi,this.et.set(t,e)),e}yt(t){let e=this.st.get(t);return e||(e=new Pi(Fr),this.st=this.st.insert(t,e)),e}ht(t){var e=null!==this.dt(t);return e||wr("WatchChangeAggregator","Detected inactive target",t),e}dt(t){var e=this.et.get(t);return e&&e.q?null:this.tt.Tt(t)}lt(e){this.et.set(e,new Yi),this.tt.getRemoteKeysForTarget(e).forEach(t=>{this.ct(e,t,null)})}gt(t,e){return this.tt.getRemoteKeysForTarget(t).has(e)}}function Ji(){return new Oi(is.comparator)}function Zi(){return new Oi(is.comparator)}const to={asc:"ASCENDING",desc:"DESCENDING"},eo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class no{constructor(t,e){this.databaseId=t,this.D=e}}function ro(t,e){return t.D?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function so(t,e){return t.D?e.toBase64():e.toUint8Array()}function io(t){return _r(!!t),qr.fromTimestamp((e=Xr(t),new Ur(e.seconds,e.nanos)));var e}function oo(t,e){return t=t,new Gr(["projects",t.projectId,"databases",t.database]).child("documents").child(e).canonicalString()}function ao(t){var e=Gr.fromString(t);return _r(Do(e)),e}function ho(t,e){return oo(t.databaseId,e.path)}function co(t,e){const n=ao(e);if(n.get(1)!==t.databaseId.projectId)throw new Nr(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Nr(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new is(go(n))}function uo(t,e){return oo(t.databaseId,e)}function lo(t){var e=ao(t);return 4===e.length?Gr.emptyPath():go(e)}function fo(t){return new Gr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function go(t){return _r(4<t.length&&"documents"===t.get(4)),t.popFirst(5)}function mo(t,e,n){return{name:ho(t,e),fields:n.value.mapValue.fields}}function po(t,e,n){const r=co(t,e.name),s=io(e.updateTime),i=new ws({mapValue:{fields:e.fields}}),o=bs.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function yo(t,e){let n;if(e instanceof _i)n={update:mo(t,e.key,e.value)};else if(e instanceof Ci)n={delete:ho(t,e.key)};else if(e instanceof Si)n={update:mo(t,e.key,e.data),updateMask:function(t){const e=[];return t.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}(e.fieldMask)};else{if(!(e instanceof xi))return Ir();n={verify:ho(t,e.key)}}return 0<e.fieldTransforms.length&&(n.updateTransforms=e.fieldTransforms.map(t=>function(t){var e=t.transform;if(e instanceof ai)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof hi)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:e.elements}};if(e instanceof ui)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:e.elements}};if(e instanceof di)return{fieldPath:t.field.canonicalString(),increment:e.C};throw Ir()}(t))),e.precondition.isNone||(n.currentDocument=void 0!==(r=e.precondition).updateTime?{updateTime:(e=r.updateTime,ro(t,e.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Ir()),n;var r}function vo(e,n){const t=n.currentDocument?void 0!==(s=n.currentDocument).updateTime?yi.updateTime(io(s.updateTime)):void 0!==s.exists?yi.exists(s.exists):yi.none():yi.none(),r=n.updateTransforms?n.updateTransforms.map(t=>function(t,e){let n=null;if("setToServerValue"in e)_r("REQUEST_TIME"===e.setToServerValue),n=new ai;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new hi(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ui(t)}else"increment"in e?n=new di(t,e.increment):Ir();var r=zr.fromServerFormat(e.fieldPath);return new mi(r,n)}(e,t)):[];var s;if(n.update){n.update.name;var i=co(e,n.update.name),o=new ws({mapValue:{fields:n.update.fields}});if(n.updateMask){const e=function(){const t=n.updateMask.fieldPaths||[];return new Qr(t.map(t=>zr.fromServerFormat(t)))}();return new Si(i,o,e,t,r)}return new _i(i,o,t,r)}if(n.delete){const r=co(e,n.delete);return new Ci(r,t)}if(n.verify){const r=co(e,n.verify);return new xi(r,t)}return Ir()}function wo(t,e){return{documents:[uo(t,e.path)]}}function bo(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=uo(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=uo(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(t){if(0!==t.length){var e=t.map(t=>function(t){if("=="===t.op){if(ps(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NAN"}};if(ms(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(ps(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NOT_NAN"}};if(ms(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:_o(t.field),op:(e=t.op,eo[e]),value:t.value}};var e}(t));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}}(e.filters);s&&(n.structuredQuery.where=s);s=function(t){if(0!==t.length)return t.map(t=>function(t){return{field:_o(t.field),direction:(t=t.dir,to[t])}}(t))}(e.orderBy);s&&(n.structuredQuery.orderBy=s);var i,s=(i=e.limit,t.D||ns(i)?i:{value:i});return null!==s&&(n.structuredQuery.limit=s),e.startAt&&(n.structuredQuery.startAt=To(e.startAt)),e.endAt&&(n.structuredQuery.endAt=To(e.endAt)),n}function Eo(t){let e=lo(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){_r(1===r);const l=n.from[0];l.allDescendants?s=l.collectionId:e=e.child(l.collectionId)}let i=[];n.where&&(i=function e(t){return t?void 0!==t.unaryFilter?[Ao(t)]:void 0!==t.fieldFilter?[No(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>e(t)).reduce((t,e)=>t.concat(e)):Ir():[]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(t=>function(t){return new Ps(So(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(t)));let a=null;var h;n.limit&&(a=(t=n.limit,ns(h="object"==typeof t?t.value:t)?null:h));let c=null;n.startAt&&(c=Io(n.startAt));let u=null;return n.endAt&&(u=Io(n.endAt)),Bs(e,s,o,i,a,"F",c,u)}function To(t){return{before:t.before,values:t.position}}function Io(t){var e=!!t.before,n=t.values||[];return new Ms(n,e)}function _o(t){return{fieldPath:t.canonicalString()}}function So(t){return zr.fromServerFormat(t.fieldPath)}function No(t){return Ns.create(So(t.fieldFilter.field),function(){switch(t.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ir()}}(),t.fieldFilter.value)}function Ao(t){switch(t.unaryFilter.op){case"IS_NAN":var e=So(t.unaryFilter.field);return Ns.create(e,"==",{doubleValue:NaN});case"IS_NULL":e=So(t.unaryFilter.field);return Ns.create(e,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=So(t.unaryFilter.field);return Ns.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=So(t.unaryFilter.field);return Ns.create(n,"!=",{nullValue:"NULL_VALUE"});default:return Ir()}}function Do(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)}function Co(t){let e="";for(let n=0;n<t.length;n++)0<e.length&&(e=xo(e)),e=function(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const r=t.charAt(s);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(n),e);return xo(e)}function xo(t){return t+""}function ko(e){const n=e.length;if(_r(2<=n),2===n)return _r(""===e.charAt(0)&&""===e.charAt(1)),Gr.emptyPath();const r=n-2,s=[];let i="";for(let o=0;o<n;){const n=e.indexOf("",o);switch((n<0||n>r)&&Ir(),e.charAt(n+1)){case"":const r=e.substring(o,n);let t;0===i.length?t=r:(i+=r,t=i,i=""),s.push(t);break;case"":i+=e.substring(o,n),i+="\0";break;case"":i+=e.substring(o,n+1);break;default:Ir()}o=n+2}return new Gr(s)}class Ro{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Lo{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}Lo.store="owner",Lo.key="owner";class Oo{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}Oo.store="mutationQueues",Oo.keyPath="userId";class Mo{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}Mo.store="mutations",Mo.keyPath="batchId",Mo.userMutationsIndex="userMutationsIndex",Mo.userMutationsKeyPath=["userId","batchId"];class Fo{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Co(e)]}static key(t,e,n){return[t,Co(e),n]}}Fo.store="documentMutations",Fo.PLACEHOLDER=new Fo;class Po{constructor(t,e){this.path=t,this.readTime=e}}class Vo{constructor(t,e){this.path=t,this.version=e}}class Uo{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}Uo.store="remoteDocuments",Uo.readTimeIndex="readTimeIndex",Uo.readTimeIndexPath="readTime",Uo.collectionReadTimeIndex="collectionReadTimeIndex",Uo.collectionReadTimeIndexPath=["parentPath","readTime"];class qo{constructor(t){this.byteSize=t}}qo.store="remoteDocumentGlobal",qo.key="remoteDocumentGlobalKey";class Bo{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}Bo.store="targets",Bo.keyPath="targetId",Bo.queryTargetsIndexName="queryTargetsIndex",Bo.queryTargetsKeyPath=["canonicalId","targetId"];class jo{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}jo.store="targetDocuments",jo.keyPath=["targetId","path"],jo.documentTargetsIndex="documentTargetsIndex",jo.documentTargetsKeyPath=["path","targetId"];class Ko{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}Ko.key="targetGlobalKey",Ko.store="targetGlobal";class $o{constructor(t,e){this.collectionId=t,this.parent=e}}$o.store="collectionParents",$o.keyPath=["collectionId","parent"];class Go{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}Go.store="clientMetadata",Go.keyPath="clientId";class Ho{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}Ho.store="bundles",Ho.keyPath="bundleId";class zo{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}zo.store="namedQueries",zo.keyPath="name";const Qo=[Oo.store,Mo.store,Fo.store,Uo.store,Bo.store,Lo.store,Ko.store,jo.store,Go.store,qo.store,$o.store,Ho.store,zo.store],Wo="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Yo{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}class Xo{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(t){return this.next(void 0,t)}next(r,s){return this.callbackAttached&&Ir(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new Xo((e,n)=>{this.nextCallback=t=>{this.wrapSuccess(r,t).next(e,n)},this.catchCallback=t=>{this.wrapFailure(s,t).next(e,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{var e=t();return e instanceof Xo?e:Xo.resolve(e)}catch(t){return Xo.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Xo.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Xo.reject(e)}static resolve(n){return new Xo((t,e)=>{t(n)})}static reject(n){return new Xo((t,e)=>{e(n)})}static waitFor(t){return new Xo((e,n)=>{let r=0,s=0,i=!1;t.forEach(t=>{++r,t.next(()=>{++s,i&&s===r&&e()},t=>n(t))}),i=!0,s===r&&e()})}static or(t){let e=Xo.resolve(!1);for(const n of t)e=e.next(t=>t?Xo.resolve(t):n());return e}static forEach(t,n){const r=[];return t.forEach((t,e)=>{r.push(n.call(this,t,e))}),this.waitFor(r)}}class Jo{constructor(n,t){this.action=n,this.transaction=t,this.aborted=!1,this.Et=new Ar,this.transaction.oncomplete=()=>{this.Et.resolve()},this.transaction.onabort=()=>{t.error?this.Et.reject(new ea(n,t.error)):this.Et.resolve()},this.transaction.onerror=t=>{var e=oa(t.target.error);this.Et.reject(new ea(n,e))}}static open(t,e,n,r){try{return new Jo(e,t.transaction(r,n))}catch(t){throw new ea(e,t)}}get It(){return this.Et.promise}abort(t){t&&this.Et.reject(t),this.aborted||(wr("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){var e=this.transaction.objectStore(t);return new ra(e)}}class Zo{constructor(t,e,n){this.name=t,this.version=e,this.At=n,12.2===Zo.Rt(d())&&br("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return wr("SimpleDb","Removing database:",t),sa(window.indexedDB.deleteDatabase(t)).toPromise()}static bt(){if("object"!=typeof indexedDB)return!1;if(Zo.Pt())return!0;const t=d(),e=Zo.Rt(t),n=0<e&&e<10,r=Zo.vt(t),s=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||s)}static Pt(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.Vt)}static St(t,e){return t.store(e)}static Rt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Dt(i){return this.db||(wr("SimpleDb","Opening database:",this.name),this.db=await new Promise((n,r)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{var e=t.target.result;n(e)},s.onblocked=()=>{r(new ea(i,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{var e=t.target.error;"VersionError"===e.name?r(new Nr(Sr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?r(new Nr(Sr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):r(new ea(i,e))},s.onupgradeneeded=t=>{wr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;this.At.Ct(e,s.transaction,t.oldVersion,this.version).next(()=>{wr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Nt&&(this.db.onversionchange=t=>this.Nt(t)),this.db}xt(e){this.Nt=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(t,e,n,r){var s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Dt(t);const e=Jo.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch(t=>(e.abort(t),Xo.reject(t))).toPromise();return i.catch(()=>{}),await e.It,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(wr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ta{constructor(t){this.kt=t,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(t){this.kt=t}done(){this.$t=!0}Mt(t){this.Ot=t}delete(){return sa(this.kt.delete())}}class ea extends Nr{constructor(t,e){super(Sr.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function na(t){return"IndexedDbTransactionError"===t.name}class ra{constructor(t){this.store=t}put(t,e){let n;return n=void 0!==e?(wr("SimpleDb","PUT",this.store.name,t,e),this.store.put(e,t)):(wr("SimpleDb","PUT",this.store.name,"<auto-key>",t),this.store.put(t)),sa(n)}add(t){return wr("SimpleDb","ADD",this.store.name,t,t),sa(this.store.add(t))}get(e){return sa(this.store.get(e)).next(t=>(wr("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t))}delete(t){return wr("SimpleDb","DELETE",this.store.name,t),sa(this.store.delete(t))}count(){return wr("SimpleDb","COUNT",this.store.name),sa(this.store.count())}Lt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Bt(n,(t,e)=>{r.push(e)}).next(()=>r)}Ut(t,e){wr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.qt=!1;var r=this.cursor(n);return this.Bt(r,(t,e,n)=>n.delete())}Kt(t,e){let n;e?n=t:(n={},e=t);var r=this.cursor(n);return this.Bt(r,e)}jt(s){const t=this.cursor({});return new Xo((n,r)=>{t.onerror=t=>{var e=oa(t.target.error);r(e)},t.onsuccess=t=>{const e=t.target.result;e?s(e.primaryKey,e.value).next(t=>{t?e.continue():n()}):n()}})}Bt(t,i){const o=[];return new Xo((s,e)=>{t.onerror=t=>{e(t.target.error)},t.onsuccess=t=>{const e=t.target.result;if(e){const n=new ta(e),r=i(e.primaryKey,e.value,n);if(r instanceof Xo){const t=r.catch(t=>(n.done(),Xo.reject(t)));o.push(t)}n.isDone?s():null===n.Ft?e.continue():e.continue(n.Ft)}else s()}}).next(()=>Xo.waitFor(o))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.qt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function sa(t){return new Xo((n,r)=>{t.onsuccess=t=>{var e=t.target.result;n(e)},t.onerror=t=>{var e=oa(t.target.error);r(e)}})}let ia=!1;function oa(t){const e=Zo.Rt(d());if(12.2<=e&&e<13){const e="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(e)){const t=new Nr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ia||(ia=!0,setTimeout(()=>{throw t},0)),t}}return t}class aa extends Yo{constructor(t,e){super(),this.Qt=t,this.currentSequenceNumber=e}}function ha(t,e){var n=t;return Zo.St(n.Qt,e)}class ca{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const s=this.mutations[r];s.key.isEqual(t.key)&&bi(s,t,n[r])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Ei(e,t,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(t.key)&&Ei(n,t,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(t=>{const e=r.get(t.key),n=e;this.applyToLocalView(n),e.isValidDocument()||n.convertToNoDocument(qr.min())})}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ki())}isEqual(t){return this.batchId===t.batchId&&Pr(this.mutations,t.mutations,(t,e)=>Ti(t,e))&&Pr(this.baseMutations,t.baseMutations,(t,e)=>Ti(t,e))}}class ua{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){_r(t.mutations.length===n.length);let r=Bi;var s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new ua(t,e,n,r)}}class la{constructor(t,e,n,r,s=qr.min(),i=qr.min(),o=Wr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new la(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new la(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new la(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class da{constructor(t){this.Wt=t}}function fa(t,e){if(e.document)return po(t.Wt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=is.fromSegments(e.noDocument.path),n=va(e.noDocument.readTime),r=bs.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=is.fromSegments(e.unknownDocument.path),s=va(e.unknownDocument.version);return bs.newUnknownDocument(t,s)}return Ir()}function ga(t,e,n){var r=ma(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const i={name:ho(n=t.Wt,(t=e).key),fields:t.data.value.mapValue.fields,updateTime:ro(n,t.version.toTimestamp())},o=e.hasCommittedMutations;return new Uo(null,null,i,o,r,s)}if(e.isNoDocument()){const a=e.key.path.toArray(),i=ya(e.version),h=e.hasCommittedMutations;return new Uo(null,new Po(a,i),null,h,r,s)}if(e.isUnknownDocument()){const a=e.key.path.toArray(),i=ya(e.version);return new Uo(new Vo(a,i),null,null,!0,r,s)}return Ir()}function ma(t){var e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function pa(t){var e=new Ur(t[0],t[1]);return qr.fromTimestamp(e)}function ya(t){var e=t.toTimestamp();return new Ro(e.seconds,e.nanoseconds)}function va(t){var e=new Ur(t.seconds,t.nanoseconds);return qr.fromTimestamp(e)}function wa(e,t){const n=(t.baseMutations||[]).map(t=>vo(e.Wt,t));for(let i=0;i<t.mutations.length-1;++i){const n=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const r=t.mutations[i+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map(t=>vo(e.Wt,t)),s=Ur.fromMillis(t.localWriteTimeMs);return new ca(t.batchId,s,n,r)}function ba(t){var e,n=va(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?va(t.lastLimboFreeSnapshotVersion):qr.min();let s;return s=void 0!==t.query.documents?(_r(1===(e=t.query).documents.length),Ws(js(lo(e.documents[0])))):Ws(Eo(t.query)),new la(s,t.targetId,0,t.lastListenSequenceNumber,n,r,Wr.fromBase64String(t.resumeToken))}function Ea(t,e){var n=ya(e.snapshotVersion),r=ya(e.lastLimboFreeSnapshotVersion),s=(Ss(e.target)?wo:bo)(t.Wt,e.target),i=e.resumeToken.toBase64();return new Bo(e.targetId,Is(e.target),n,i,e.sequenceNumber,r,s)}function Ta(t){var e=Eo({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Ys(e,e.limit,"L"):e}class Ia{getBundleMetadata(t,e){return _a(t).get(e).next(t=>{if(t)return{id:(e=t).bundleId,createTime:va(e.createTime),version:e.version};var e})}saveBundleMetadata(t,e){return _a(t).put({bundleId:(n=e).id,createTime:ya(io(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Sa(t).get(e).next(t=>{if(t)return{name:(e=t).name,query:Ta(e.bundledQuery),readTime:va(e.readTime)};var e})}saveNamedQuery(t,e){return Sa(t).put({name:(e=e).name,readTime:ya(io(e.readTime)),bundledQuery:e.bundledQuery})}}function _a(t){return ha(t,Ho.store)}function Sa(t){return ha(t,zo.store)}class Na{constructor(){this.Gt=new Aa}addToCollectionParentIndex(t,e){return this.Gt.add(e),Xo.resolve()}getCollectionParents(t,e){return Xo.resolve(this.Gt.getEntries(e))}}class Aa{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Pi(Gr.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Pi(Gr.comparator)).toArray()}}class Da{constructor(){this.zt=new Aa}addToCollectionParentIndex(t,e){if(this.zt.has(e))return Xo.resolve();var n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener(()=>{this.zt.add(e)});r={collectionId:n,parent:Co(r)};return Ca(t).put(r)}getCollectionParents(t,n){const r=[],e=IDBKeyRange.bound([n,""],[Vr(n),""],!1,!0);return Ca(t).Lt(e).next(t=>{for(const e of t){if(e.collectionId!==n)break;r.push(ko(e.parent))}return r})}}function Ca(t){return ha(t,$o.store)}const xa={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ka{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new ka(t,ka.DEFAULT_COLLECTION_PERCENTILE,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ra(t,e,n){const r=t.store(Mo.store),s=t.store(Fo.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const h=r.Kt({range:o},(t,e,n)=>(a++,n.delete()));i.push(h.next(()=>{_r(1===a)}));const c=[];for(const t of n.mutations){const r=Fo.key(e,t.key.path,n.batchId);i.push(s.delete(r)),c.push(t.key)}return Xo.waitFor(i).next(()=>c)}function La(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ir();e=t.noDocument}return JSON.stringify(e).length}ka.DEFAULT_COLLECTION_PERCENTILE=10,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ka.DEFAULT=new ka(41943040,ka.DEFAULT_COLLECTION_PERCENTILE,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ka.DISABLED=new ka(-1,0,0);class Oa{constructor(t,e,n,r){this.userId=t,this.N=e,this.Ht=n,this.referenceDelegate=r,this.Jt={}}static Yt(t,e,n,r){_r(""!==t.uid);var s=t.isAuthenticated()?t.uid:"";return new Oa(s,e,n,r)}checkEmpty(t){let r=!0;var e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Fa(t).Kt({index:Mo.userMutationsIndex,range:e},(t,e,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(u,l,d,f){const g=Pa(u),m=Fa(u);return m.add({}).next(t=>{_r("number"==typeof t);const e=new ca(t,l,d,f),n=(s=this.N,i=this.userId,o=e,a=o.baseMutations.map(t=>yo(s.Wt,t)),h=o.mutations.map(t=>yo(s.Wt,t)),new Mo(i,o.batchId,o.localWriteTime.toMillis(),a,h)),r=[];var s,i,o,a,h;let c=new Pi((t,e)=>Fr(t.canonicalString(),e.canonicalString()));for(const u of f){const l=Fo.key(this.userId,u.key.path,t);c=c.add(u.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Fo.PLACEHOLDER))}return c.forEach(t=>{r.push(this.Ht.addToCollectionParentIndex(u,t))}),u.addOnCommittedListener(()=>{this.Jt[t]=e.keys()}),Xo.waitFor(r).next(()=>e)})}lookupMutationBatch(t,e){return Fa(t).get(e).next(t=>t?(_r(t.userId===this.userId),wa(this.N,t)):null)}Xt(t,n){return this.Jt[n]?Xo.resolve(this.Jt[n]):this.lookupMutationBatch(t,n).next(t=>{if(t){var e=t.keys();return this.Jt[n]=e}return null})}getNextMutationBatchAfterBatchId(t,e){const r=e+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Fa(t).Kt({index:Mo.userMutationsIndex,range:n},(t,e,n)=>{e.userId===this.userId&&(_r(e.batchId>=r),s=wa(this.N,e)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Fa(t).Kt({index:Mo.userMutationsIndex,range:e,reverse:!0},(t,e,n)=>{r=e.batchId,n.done()}).next(()=>r)}getAllMutationBatches(t){var e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Fa(t).Lt(Mo.userMutationsIndex,e).next(t=>t.map(t=>wa(this.N,t)))}getAllMutationBatchesAffectingDocumentKey(o,a){const t=Fo.prefixForPath(this.userId,a.path),e=IDBKeyRange.lowerBound(t),h=[];return Pa(o).Kt({range:e},(t,e,n)=>{var[r,s,i]=t,s=ko(s);if(r===this.userId&&a.path.isEqual(s))return Fa(o).get(i).next(t=>{if(!t)throw Ir();_r(t.userId===this.userId),h.push(wa(this.N,t))});n.done()}).next(()=>h)}getAllMutationBatchesAffectingDocumentKeys(e,t){let a=new Pi(Fr);const n=[];return t.forEach(o=>{var t=Fo.prefixForPath(this.userId,o.path),t=IDBKeyRange.lowerBound(t),t=Pa(e).Kt({range:t},(t,e,n)=>{var[r,s,i]=t,s=ko(s);r===this.userId&&o.path.isEqual(s)?a=a.add(i):n.done()});n.push(t)}),Xo.waitFor(n).next(()=>this.Zt(e,a))}getAllMutationBatchesAffectingQuery(t,e){const o=e.path,a=o.length+1,n=Fo.prefixForPath(this.userId,o),r=IDBKeyRange.lowerBound(n);let h=new Pi(Fr);return Pa(t).Kt({range:r},(t,e,n)=>{var[r,s,i]=t,s=ko(s);r===this.userId&&o.isPrefixOf(s)?s.length===a&&(h=h.add(i)):n.done()}).next(()=>this.Zt(t,h))}Zt(e,t){const n=[],r=[];return t.forEach(t=>{r.push(Fa(e).get(t).next(t=>{if(null===t)throw Ir();_r(t.userId===this.userId),n.push(wa(this.N,t))}))}),Xo.waitFor(r).next(()=>n)}removeMutationBatch(e,n){return Ra(e.Qt,this.userId,n).next(t=>(e.addOnCommittedListener(()=>{this.te(n.batchId)}),Xo.forEach(t,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}te(t){delete this.Jt[t]}performConsistencyCheck(n){return this.checkEmpty(n).next(t=>{if(!t)return Xo.resolve();const e=IDBKeyRange.lowerBound(Fo.prefixForUser(this.userId)),r=[];return Pa(n).Kt({range:e},(t,e,n)=>{if(t[0]===this.userId){const e=ko(t[1]);r.push(e)}else n.done()}).next(()=>{_r(0===r.length)})})}containsKey(t,e){return Ma(t,this.userId,e)}ee(t){return Va(t).get(this.userId).next(t=>t||new Oo(this.userId,-1,""))}}function Ma(t,i,e){const n=Fo.prefixForPath(i,e.path),o=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return Pa(t).Kt({range:r,qt:!0},(t,e,n)=>{var[r,s]=t;r===i&&s===o&&(a=!0),n.done()}).next(()=>a)}function Fa(t){return ha(t,Mo.store)}function Pa(t){return ha(t,Fo.store)}function Va(t){return ha(t,Oo.store)}class Ua{constructor(t){this.ne=t}next(){return this.ne+=2,this.ne}static se(){return new Ua(0)}static ie(){return new Ua(-1)}}class qa{constructor(t,e){this.referenceDelegate=t,this.N=e}allocateTargetId(n){return this.re(n).next(t=>{const e=new Ua(t.highestTargetId);return t.highestTargetId=e.next(),this.oe(n,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.re(t).next(t=>qr.fromTimestamp(new Ur(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.re(t).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,n,r){return this.re(e).next(t=>(t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),this.oe(e,t)))}addTargetData(e,n){return this.ce(e,n).next(()=>this.re(e).next(t=>(t.targetCount+=1,this.ae(n,t),this.oe(e,t))))}updateTargetData(t,e){return this.ce(t,e)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Ba(e).delete(t.targetId)).next(()=>this.re(e)).next(t=>(_r(0<t.targetCount),--t.targetCount,this.oe(e,t)))}removeTargets(r,s,i){let o=0;const a=[];return Ba(r).Kt((t,e)=>{var n=ba(e);n.sequenceNumber<=s&&null===i.get(n.targetId)&&(o++,a.push(this.removeTargetData(r,n)))}).next(()=>Xo.waitFor(a)).next(()=>o)}forEachTarget(t,r){return Ba(t).Kt((t,e)=>{var n=ba(e);r(n)})}re(t){return ja(t).get(Ko.key).next(t=>(_r(null!==t),t))}oe(t,e){return ja(t).put(Ko.key,e)}ce(t,e){return Ba(t).put(Ea(this.N,e))}ae(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.re(t).next(t=>t.targetCount)}getTargetData(t,s){var e=Is(s),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]);let i=null;return Ba(t).Kt({range:e,index:Bo.queryTargetsIndexName},(t,e,n)=>{var r=ba(e);_s(s,r.target)&&(i=r,n.done())}).next(()=>i)}addMatchingKeys(n,t,r){const s=[],i=Ka(n);return t.forEach(t=>{var e=Co(t.path);s.push(i.put(new jo(r,e))),s.push(this.referenceDelegate.addReference(n,r,t))}),Xo.waitFor(s)}removeMatchingKeys(n,t,r){const s=Ka(n);return Xo.forEach(t,t=>{var e=Co(t.path);return Xo.waitFor([s.delete([r,e]),this.referenceDelegate.removeReference(n,r,t)])})}removeMatchingKeysForTargetId(t,e){const n=Ka(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=Ka(t);let s=Ki();return r.Kt({range:n,qt:!0},(t,e,n)=>{var r=ko(t[1]),r=new is(r);s=s.add(r)}).next(()=>s)}containsKey(t,e){var n=Co(e.path),n=IDBKeyRange.bound([n],[Vr(n)],!1,!0);let r=0;return Ka(t).Kt({index:jo.documentTargetsIndex,qt:!0,range:n},([t],e,n)=>{0!==t&&(r++,n.done())}).next(()=>0<r)}Tt(t,e){return Ba(t).get(e).next(t=>t?ba(t):null)}}function Ba(t){return ha(t,Bo.store)}function ja(t){return ha(t,Ko.store)}function Ka(t){return ha(t,jo.store)}async function $a(t){if(t.code!==Sr.FAILED_PRECONDITION||t.message!==Wo)throw t;wr("LocalStore","Unexpectedly lost primary lease")}function Ga([t,e],[n,r]){var s=Fr(t,n);return 0===s?Fr(e,r):s}class Ha{constructor(t){this.ue=t,this.buffer=new Pi(Ga),this.he=0}le(){return++this.he}fe(t){var e=[t,this.le()];if(this.buffer.size<this.ue)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Ga(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class za{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.de=!1,this.we=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this._e(t)}stop(){this.we&&(this.we.cancel(),this.we=null)}get started(){return null!==this.we}_e(t){var e=this.de?3e5:6e4;wr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.we=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.we=null,this.de=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){na(t)?wr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await $a(t)}await this._e(t)})}}class Qa{constructor(t,e){this.me=t,this.params=e}calculateTargetCount(t,e){return this.me.ge(t).next(t=>Math.floor(e/100*t))}nthSequenceNumber(t,e){if(0===e)return Xo.resolve(Or.T);const n=new Ha(e);return this.me.forEachTarget(t,t=>n.fe(t.sequenceNumber)).next(()=>this.me.ye(t,t=>n.fe(t))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.me.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.me.removeOrphanedDocuments(t,e)}collect(e,n){return-1===this.params.cacheSizeCollectionThreshold?(wr("LruGarbageCollector","Garbage collection skipped; disabled"),Xo.resolve(xa)):this.getCacheSize(e).next(t=>t<this.params.cacheSizeCollectionThreshold?(wr("LruGarbageCollector",`Garbage collection skipped; Cache size ${t} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),xa):this.pe(e,n))}getCacheSize(t){return this.me.getCacheSize(t)}pe(e,n){let r,s,i,o,a,h,c;const u=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(s=t>this.params.maximumSequenceNumbersToCollect?(wr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,o=Date.now(),this.nthSequenceNumber(e,s))).next(t=>(r=t,a=Date.now(),this.removeTargets(e,r,n))).next(t=>(i=t,h=Date.now(),this.removeOrphanedDocuments(e,r))).next(t=>(c=Date.now(),vr()<=l.DEBUG&&wr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-u}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${i} targets in `+(h-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-h)+"ms\n"+`Total Duration: ${c-u}ms`),Xo.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:t})))}}class Wa{constructor(t,e){this.db=t,this.garbageCollector=(t=this,e=e,new Qa(t,e))}ge(t){const n=this.Te(t);return this.db.getTargetCache().getTargetCount(t).next(e=>n.next(t=>e+t))}Te(t){let e=0;return this.ye(t,t=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ye(t,n){return this.Ee(t,(t,e)=>n(e))}addReference(t,e,n){return Ya(t,n)}removeReference(t,e,n){return Ya(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Ya(t,e)}Ie(e,n){let r=!1;return Va(e).jt(t=>Ma(e,t,n).next(t=>(t&&(r=!0),Xo.resolve(!t)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this.Ee(n,(e,t)=>{if(t<=r){const r=this.Ie(n,e).next(t=>{if(!t)return o++,s.getEntry(n,e).next(()=>(s.removeEntry(e),Ka(n).delete([0,Co(e.path)])))});i.push(r)}}).next(()=>Xo.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(t,e){var n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Ya(t,e)}Ee(t,r){const e=Ka(t);let s,i=Or.T;return e.Kt({index:jo.documentTargetsIndex},([t],{path:e,sequenceNumber:n})=>{0===t?(i!==Or.T&&r(new is(ko(s)),i),i=n,s=e):i=Or.T}).next(()=>{i!==Or.T&&r(new is(ko(s)),i)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Ya(t,e){return Ka(t).put((e=e,t=t.currentSequenceNumber,new jo(0,Co(e.path),t)))}class Xa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(e,n){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return void(r[t]=[e,n]);r.push([e,n])}else this.inner[t]=[[e,n]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(r){jr(this.inner,(t,e)=>{for(const[t,n]of e)r(t,n)})}isEmpty(){return Kr(this.inner)}}class Ja{constructor(){this.changes=new Xa(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}getReadTime(t){var e=this.changes.get(t);return e?e.readTime:qr.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:bs.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?Xo.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Za{constructor(t,e){this.N=t,this.Ht=e}addEntry(t,e,n){return nh(t).put(rh(e),n)}removeEntry(t,e){const n=nh(t),r=rh(e);return n.delete(r)}updateMetadata(e,n){return this.getMetadata(e).next(t=>(t.byteSize+=n,this.Ae(e,t)))}getEntry(t,e){return nh(t).get(rh(e)).next(t=>this.Re(e,t))}be(t,e){return nh(t).get(rh(e)).next(t=>({document:this.Re(e,t),size:La(t)}))}getEntries(t,e){let r=Ui;return this.Pe(t,e,(t,e)=>{var n=this.Re(t,e);r=r.insert(t,n)}).next(()=>r)}ve(t,e){let r=Ui,s=new Oi(is.comparator);return this.Pe(t,e,(t,e)=>{var n=this.Re(t,e);r=r.insert(t,n),s=s.insert(t,La(e))}).next(()=>({documents:r,Ve:s}))}Pe(t,e,s){if(e.isEmpty())return Xo.resolve();const n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator();let o=i.getNext();return nh(t).Kt({range:n},(t,e,n)=>{for(var r=is.fromSegments(t);o&&is.comparator(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,e),o=i.hasNext()?i.getNext():null),o?n.Mt(o.path.toArray()):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(t,s,e){let i=Ui;const o=s.path.length+1,n={};if(e.isEqual(qr.min())){const t=s.path.toArray();n.range=IDBKeyRange.lowerBound(t)}else{const t=s.path.toArray(),i=ma(e);n.range=IDBKeyRange.lowerBound([t,i],!0),n.index=Uo.collectionReadTimeIndex}return nh(t).Kt(n,(t,e,n)=>{var r;t.length===o&&(r=fa(this.N,e),s.path.isPrefixOf(r.key.path)?ti(s,r)&&(i=i.insert(r.key,r)):n.done())}).next(()=>i)}newChangeBuffer(t){return new th(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return eh(t).get(qo.key).next(t=>(_r(!!t),t))}Ae(t,e){return eh(t).put(qo.key,e)}Re(t,e){if(e){const t=fa(this.N,e);if(!t.isNoDocument()||!t.version.isEqual(qr.min()))return t}return bs.newInvalidDocument(t)}}class th extends Ja{constructor(t,e){super(),this.Se=t,this.trackRemovals=e,this.De=new Xa(t=>t.toString(),(t,e)=>t.isEqual(e))}applyChanges(i){const o=[];let a=0,h=new Pi((t,e)=>Fr(t.canonicalString(),e.canonicalString()));return this.changes.forEach((t,e)=>{var n=this.De.get(t);if(e.document.isValidDocument()){var r=ga(this.Se.N,e.document,this.getReadTime(t));h=h.add(t.path.popLast());var s=La(r);a+=s-n,o.push(this.Se.addEntry(i,t,r))}else if(a-=n,this.trackRemovals){const a=ga(this.Se.N,bs.newNoDocument(t,qr.min()),this.getReadTime(t));o.push(this.Se.addEntry(i,t,a))}else o.push(this.Se.removeEntry(i,t))}),h.forEach(t=>{o.push(this.Se.Ht.addToCollectionParentIndex(i,t))}),o.push(this.Se.updateMetadata(i,a)),Xo.waitFor(o)}getFromCache(t,e){return this.Se.be(t,e).next(t=>(this.De.set(e,t.size),t.document))}getAllFromCache(t,e){return this.Se.ve(t,e).next(({documents:t,Ve:e})=>(e.forEach((t,e)=>{this.De.set(t,e)}),t))}}function eh(t){return ha(t,qo.store)}function nh(t){return ha(t,Uo.store)}function rh(t){return t.path.toArray()}class sh{constructor(t){this.N=t}Ct(e,n,t,r){_r(t<r&&0<=t&&r<=11);const s=new Jo("createOrUpgrade",n);var i;t<1&&1<=r&&(e.createObjectStore(Lo.store),(i=e).createObjectStore(Oo.store,{keyPath:Oo.keyPath}),i.createObjectStore(Mo.store,{keyPath:Mo.keyPath,autoIncrement:!0}).createIndex(Mo.userMutationsIndex,Mo.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Fo.store),ih(e),e.createObjectStore(Uo.store));let o=Xo.resolve();return t<3&&3<=r&&(0!==t&&((i=e).deleteObjectStore(jo.store),i.deleteObjectStore(Bo.store),i.deleteObjectStore(Ko.store),ih(e)),o=o.next(()=>function(){const t=s.store(Ko.store),e=new Ko(0,0,qr.min().toTimestamp(),0);return t.put(Ko.key,e)}())),t<4&&4<=r&&(0!==t&&(o=o.next(()=>function(r,s){return s.store(Mo.store).Lt().next(t=>{r.deleteObjectStore(Mo.store),r.createObjectStore(Mo.store,{keyPath:Mo.keyPath,autoIncrement:!0}).createIndex(Mo.userMutationsIndex,Mo.userMutationsKeyPath,{unique:!0});const e=s.store(Mo.store),n=t.map(t=>e.put(t));return Xo.waitFor(n)})}(e,s))),o=o.next(()=>{e.createObjectStore(Go.store,{keyPath:Go.keyPath})})),t<5&&5<=r&&(o=o.next(()=>this.Ce(s))),t<6&&6<=r&&(o=o.next(()=>(e.createObjectStore(qo.store),this.Ne(s)))),t<7&&7<=r&&(o=o.next(()=>this.xe(s))),t<8&&8<=r&&(o=o.next(()=>this.ke(e,s))),t<9&&9<=r&&(o=o.next(()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges"),function(){const t=n.objectStore(Uo.store);t.createIndex(Uo.readTimeIndex,Uo.readTimeIndexPath,{unique:!1}),t.createIndex(Uo.collectionReadTimeIndex,Uo.collectionReadTimeIndexPath,{unique:!1})}()})),t<10&&10<=r&&(o=o.next(()=>this.$e(s))),t<11&&11<=r&&(o=o.next(()=>{e.createObjectStore(Ho.store,{keyPath:Ho.keyPath}),e.createObjectStore(zo.store,{keyPath:zo.keyPath})})),o}Ne(e){let n=0;return e.store(Uo.store).Kt((t,e)=>{n+=La(e)}).next(()=>{var t=new qo(n);return e.store(qo.store).put(qo.key,t)})}Ce(r){const t=r.store(Oo.store),e=r.store(Mo.store);return t.Lt().next(t=>Xo.forEach(t,n=>{var t=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return e.Lt(Mo.userMutationsIndex,t).next(t=>Xo.forEach(t,t=>{_r(t.userId===n.userId);var e=wa(this.N,t);return Ra(r,n.userId,e).next(()=>{})}))}))}xe(t){const o=t.store(jo.store),e=t.store(Uo.store);return t.store(Ko.store).get(Ko.key).next(s=>{const i=[];return e.Kt((t,e)=>{const n=new Gr(t),r=[0,Co(n)];i.push(o.get(r).next(t=>t?Xo.resolve():(t=>o.put(new jo(0,Co(t),s.highestListenSequenceNumber)))(n)))}).next(()=>Xo.waitFor(i))})}ke(t,e){t.createObjectStore($o.store,{keyPath:$o.keyPath});const n=e.store($o.store),r=new Aa,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Co(r)})}};return e.store(Uo.store).Kt({qt:!0},(t,e)=>{const n=new Gr(t);return s(n.popLast())}).next(()=>e.store(Fo.store).Kt({qt:!0},([,t],e)=>{const n=ko(t);return s(n.popLast())}))}$e(t){const r=t.store(Bo.store);return r.Kt((t,e)=>{var n=ba(e),n=Ea(this.N,n);return r.put(n)})}}function ih(t){t.createObjectStore(jo.store,{keyPath:jo.keyPath}).createIndex(jo.documentTargetsIndex,jo.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Bo.store,{keyPath:Bo.keyPath}).createIndex(Bo.queryTargetsIndexName,Bo.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Ko.store)}const oh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class ah{constructor(t,e,n,r,s,i,o,a,h,c){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Fe=h,this.Me=c,this.Le=null,this.Be=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ue=null,this.inForeground=!1,this.qe=null,this.Ke=null,this.je=Number.NEGATIVE_INFINITY,this.Qe=t=>Promise.resolve(),!ah.bt())throw new Nr(Sr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Wa(this,r),this.We=e+"main",this.N=new da(a),this.Ge=new Zo(this.We,11,new sh(this.N)),this.ze=new qa(this.referenceDelegate,this.N),this.Ht=new Da,this.He=(e=this.N,a=this.Ht,new Za(e,a)),this.Je=new Ia,this.window&&this.window.localStorage?this.Ye=this.window.localStorage:(this.Ye=null,!1===c&&br("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Xe().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Nr(Sr.FAILED_PRECONDITION,oh);return this.Ze(),this.tn(),this.en(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.ze.getHighestSequenceNumber(t))}).then(t=>{this.Le=new Or(t,this.Fe)}).then(()=>{this.Be=!0}).catch(t=>(this.Ge&&this.Ge.close(),Promise.reject(t)))}nn(e){return this.Qe=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ge.xt(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget(async()=>{this.started&&await this.Xe()}))}Xe(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>ch(e).put(new Go(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.sn(e).next(t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)))})}).next(()=>this.rn(e)).next(t=>this.isPrimary&&!t?this.on(e).next(()=>!1):!!t&&this.cn(e).next(()=>!0))).catch(t=>{if(na(t))return wr("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return wr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable(()=>this.Qe(t)),this.isPrimary=t})}sn(t){return hh(t).get(Lo.key).next(t=>Xo.resolve(this.an(t)))}un(t){return ch(t).delete(this.clientId)}async hn(){if(this.isPrimary&&!this.ln(this.je,18e5)){this.je=Date.now();var t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{const r=ha(t,Go.store);return r.Lt().next(t=>{const e=this.fn(t,18e5),n=t.filter(t=>-1===e.indexOf(t));return Xo.forEach(n,t=>r.delete(t.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ye)for(const e of t)this.Ye.removeItem(this.dn(e.clientId))}}en(){this.Ke=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Xe().then(()=>this.hn()).then(()=>this.en()))}an(t){return!!t&&t.ownerId===this.clientId}rn(e){return this.Me?Xo.resolve(!0):hh(e).get(Lo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)){if(this.an(t)&&this.networkEnabled)return!0;if(!this.an(t)){if(!t.allowTabSynchronization)throw new Nr(Sr.FAILED_PRECONDITION,oh);return!1}}return!(!this.networkEnabled||!this.inForeground)||ch(e).Lt().next(t=>void 0===this.fn(t,5e3).find(t=>{if(this.clientId!==t.clientId){var e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))}).next(t=>(this.isPrimary!==t&&wr("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async shutdown(){this.Be=!1,this._n(),this.Ke&&(this.Ke.cancel(),this.Ke=null),this.mn(),this.gn(),await this.Ge.runTransaction("shutdown","readwrite",[Lo.store,Go.store],t=>{const e=new aa(t,Or.T);return this.on(e).next(()=>this.un(e))}),this.Ge.close(),this.yn()}fn(t,e){return t.filter(t=>this.ln(t.updateTimeMs,e)&&!this.wn(t.clientId))}pn(){return this.runTransaction("getActiveClients","readonly",t=>ch(t).Lt().next(t=>this.fn(t,18e5).map(t=>t.clientId)))}get started(){return this.Be}getMutationQueue(t){return Oa.Yt(t,this.N,this.Ht,this.referenceDelegate)}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getIndexManager(){return this.Ht}getBundleCache(){return this.Je}runTransaction(e,n,r){wr("IndexedDbPersistence","Starting transaction:",e);let s;return this.Ge.runTransaction(e,"readonly"===n?"readonly":"readwrite",Qo,t=>(s=new aa(t,this.Le?this.Le.next():Or.T),"readwrite-primary"===n?this.sn(s).next(t=>!!t||this.rn(s)).next(t=>{if(!t)throw br(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)),new Nr(Sr.FAILED_PRECONDITION,Wo);return r(s)}).next(t=>this.cn(s).next(()=>t)):this.Tn(s).next(()=>r(s)))).then(t=>(s.raiseOnCommittedEvent(),t))}Tn(t){return hh(t).get(Lo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)&&!this.an(t)&&!(this.Me||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Nr(Sr.FAILED_PRECONDITION,oh)})}cn(t){var e=new Lo(this.clientId,this.allowTabSynchronization,Date.now());return hh(t).put(Lo.key,e)}static bt(){return Zo.bt()}on(t){const e=hh(t);return e.get(Lo.key).next(t=>this.an(t)?(wr("IndexedDbPersistence","Releasing primary lease."),e.delete(Lo.key)):Xo.resolve())}ln(t,e){var n=Date.now();return!(t<n-e||n<t&&(br(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ze(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.qe=()=>{this.Oe.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Xe()))},this.document.addEventListener("visibilitychange",this.qe),this.inForeground="visible"===this.document.visibilityState)}mn(){this.qe&&(this.document.removeEventListener("visibilitychange",this.qe),this.qe=null)}tn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ue=()=>{this._n(),s()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ue))}gn(){this.Ue&&(this.window.removeEventListener("pagehide",this.Ue),this.Ue=null)}wn(t){var e;try{var n=null!==(null===(e=this.Ye)||void 0===e?void 0:e.getItem(this.dn(t)));return wr("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return br("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}_n(){if(this.Ye)try{this.Ye.setItem(this.dn(this.clientId),String(Date.now()))}catch(t){br("Failed to set zombie client id.",t)}}yn(){if(this.Ye)try{this.Ye.removeItem(this.dn(this.clientId))}catch(t){}}dn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function hh(t){return ha(t,Lo.store)}function ch(t){return ha(t,Go.store)}function uh(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class lh{constructor(t,e){this.progress=t,this.En=e}}class dh{constructor(t,e,n){this.He=t,this.In=e,this.Ht=n}An(e,n){return this.In.getAllMutationBatchesAffectingDocumentKey(e,n).next(t=>this.Rn(e,n,t))}Rn(t,e,n){return this.He.getEntry(t,e).next(t=>{for(const e of n)e.applyToLocalView(t);return t})}bn(t,n){t.forEach((t,e)=>{for(const t of n)t.applyToLocalView(e)})}Pn(e,t){return this.He.getEntries(e,t).next(t=>this.vn(e,t).next(()=>t))}vn(t,e){return this.In.getAllMutationBatchesAffectingDocumentKeys(t,e).next(t=>this.bn(e,t))}getDocumentsMatchingQuery(t,e,n){return r=e,is.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Vn(t,e.path):zs(e)?this.Sn(t,e,n):this.Dn(t,e,n);var r}Vn(t,e){return this.An(t,new is(e)).next(t=>{let e=qi;return t.isFoundDocument()&&(e=e.insert(t.key,t)),e})}Sn(r,s,i){const o=s.collectionGroup;let a=qi;return this.Ht.getCollectionParents(r,o).next(t=>Xo.forEach(t,t=>{var e,n=(e=s,t=t.child(o),new qs(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt));return this.Dn(r,n,i).next(t=>{t.forEach((t,e)=>{a=a.insert(t,e)})})}).next(()=>a))}Dn(e,n,t){let s,i;return this.He.getDocumentsMatchingQuery(e,n,t).next(t=>(s=t,this.In.getAllMutationBatchesAffectingQuery(e,n))).next(t=>(i=t,this.Cn(e,i,s).next(e=>{s=e;for(const e of i)for(const r of e.mutations){var n=r.key;let t=s.get(n);null==t&&(t=bs.newInvalidDocument(n),s=s.insert(n,t)),Ei(r,t,e.localWriteTime),t.isFoundDocument()||(s=s.remove(n))}}))).next(()=>(s.forEach((t,e)=>{ti(n,e)||(s=s.remove(t))}),s))}Cn(t,e,n){let r=Ki();for(const t of e)for(const e of t.mutations)e instanceof Si&&null===n.get(e.key)&&(r=r.add(e.key));let s=n;return this.He.getEntries(t,r).next(t=>(t.forEach((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))}),s))}}class fh{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Nn=n,this.xn=r}static kn(t,e){let n=Ki(),r=Ki();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new fh(t,e.fromCache,n,r)}}class gh{$n(t){this.On=t}getDocumentsMatchingQuery(e,r,s,i){return 0===(t=r).filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())||s.isEqual(qr.min())?this.Fn(e,r):this.On.Pn(e,i).next(t=>{const n=this.Mn(r,t);return(Ks(r)||$s(r))&&this.Ln(r.limitType,n,i,s)?this.Fn(e,r):(vr()<=l.DEBUG&&wr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Zs(r)),this.On.getDocumentsMatchingQuery(e,r,s).next(e=>(n.forEach(t=>{e=e.insert(t.key,t)}),e)))});var t}Mn(n,t){let r=new Pi(ei(n));return t.forEach((t,e)=>{ti(n,e)&&(r=r.add(e))}),r}Ln(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Fn(t,e){return vr()<=l.DEBUG&&wr("QueryEngine","Using full collection scan to execute query:",Zs(e)),this.On.getDocumentsMatchingQuery(t,e,qr.min())}}class mh{constructor(t,e,n,r){this.persistence=t,this.Bn=e,this.N=r,this.Un=new Oi(Fr),this.qn=new Xa(t=>Is(t),_s),this.Kn=qr.min(),this.In=t.getMutationQueue(n),this.jn=t.getRemoteDocumentCache(),this.ze=t.getTargetCache(),this.Qn=new dh(this.jn,this.In,this.persistence.getIndexManager()),this.Je=t.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Un))}}function ph(t,e,n,r){return new mh(t,e,n,r)}async function yh(t,e){const n=t;let r=n.In,o=n.Qn;var s=await n.persistence.runTransaction("Handle user change","readonly",s=>{let i;return n.In.getAllMutationBatches(s).next(t=>(i=t,r=n.persistence.getMutationQueue(e),o=new dh(n.jn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(s))).next(t=>{const e=[],n=[];let r=Ki();for(const s of i){e.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}for(const s of t){n.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}return o.Pn(s,r).next(t=>({Wn:t,removedBatchIds:e,addedBatchIds:n}))})});return n.In=r,n.Qn=o,n.Bn.$n(n.Qn),s}function vh(t){const e=t;return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.ze.getLastRemoteSnapshotVersion(t))}function wh(t,n){const u=t,l=n.snapshotVersion;let d=u.Un;return u.persistence.runTransaction("Apply remote event","readwrite-primary",h=>{const t=u.jn.newChangeBuffer({trackRemovals:!0});d=u.Un;const c=[];n.targetChanges.forEach((t,e)=>{const n=d.get(e);if(n){c.push(u.ze.removeMatchingKeys(h,t.removedDocuments,e).next(()=>u.ze.addMatchingKeys(h,t.addedDocuments,e)));const a=t.resumeToken;var r,s,i,o;0<a.approximateByteSize()&&(r=n.withResumeToken(a,l).withSequenceNumber(h.currentSequenceNumber),d=d.insert(e,r),s=n,o=t,_r(0<(i=r).resumeToken.approximateByteSize()),0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)||c.push(u.ze.updateTargetData(h,r)))}});let e=Ui;if(n.documentUpdates.forEach((t,e)=>{n.resolvedLimboDocuments.has(t)&&c.push(u.persistence.referenceDelegate.updateLimboDocument(h,t))}),c.push(bh(h,t,n.documentUpdates,l,void 0).next(t=>{e=t})),!l.isEqual(qr.min())){const n=u.ze.getLastRemoteSnapshotVersion(h).next(t=>u.ze.setTargetsMetadata(h,h.currentSequenceNumber,l));c.push(n)}return Xo.waitFor(c).next(()=>t.apply(h)).next(()=>u.Qn.vn(h,e)).next(()=>e)}).then(t=>(u.Un=d,t))}function bh(t,o,e,a,h){let n=Ki();return e.forEach(t=>n=n.add(t)),o.getEntries(t,n).next(s=>{let i=Ui;return e.forEach((t,e)=>{const n=s.get(t),r=(null==h?void 0:h.get(t))||a;e.isNoDocument()&&e.version.isEqual(qr.min())?(o.removeEntry(t,r),i=i.insert(t,e)):!n.isValidDocument()||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(o.addEntry(e,r),i=i.insert(t,e)):wr("LocalStore","Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version)}),i})}function Eh(t,r){const s=t;return s.persistence.runTransaction("Allocate target","readwrite",e=>{let n;return s.ze.getTargetData(e,r).next(t=>t?(n=t,Xo.resolve(n)):s.ze.allocateTargetId(e).next(t=>(n=new la(r,t,0,e.currentSequenceNumber),s.ze.addTargetData(e,n).next(()=>n))))}).then(t=>{var e=s.Un.get(t.targetId);return(null===e||0<t.snapshotVersion.compareTo(e.snapshotVersion))&&(s.Un=s.Un.insert(t.targetId,t),s.qn.set(r,t.targetId)),t})}async function Th(t,e,n){const r=t,s=r.Un.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,t=>r.persistence.referenceDelegate.removeTarget(t,s))}catch(t){if(!na(t))throw t;wr("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Un=r.Un.remove(e),r.qn.delete(s.target)}function Ih(t,n,r){const s=t;let i=qr.min(),o=Ki();return s.persistence.runTransaction("Execute query","readonly",e=>function(t,e,n){const r=t,s=r.qn.get(n);return void 0!==s?Xo.resolve(r.Un.get(s)):r.ze.getTargetData(e,n)}(s,e,Ws(n)).next(t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,s.ze.getMatchingKeysForTargetId(e,t.targetId).next(t=>{o=t})}).next(()=>s.Bn.getDocumentsMatchingQuery(e,n,r?i:qr.min(),r?o:Ki())).next(t=>({documents:t,Gn:o})))}function _h(t,e){const n=t,r=n.ze,s=n.Un.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",t=>r.Tt(t,e).next(t=>t?t.target:null))}function Sh(t){const n=t;return n.persistence.runTransaction("Get new document changes","readonly",t=>function(t,e,n){const r=t;let s=Ui,i=ma(n);const o=nh(e),a=IDBKeyRange.lowerBound(i,!0);return o.Kt({index:Uo.readTimeIndex,range:a},(t,e)=>{var n=fa(r.N,e);s=s.insert(n.key,n),i=e.readTime}).next(()=>({En:s,readTime:pa(i)}))}(n.jn,t,n.Kn)).then(({En:t,readTime:e})=>(n.Kn=e,t))}class Nh{constructor(t){this.N=t,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return Xo.resolve(this.Yn.get(e))}saveBundleMetadata(t,e){return this.Yn.set(e.id,{id:e.id,version:e.version,createTime:io(e.createTime)}),Xo.resolve()}getNamedQuery(t,e){return Xo.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,{name:(e=e).name,query:Ta(e.bundledQuery),readTime:io(e.readTime)}),Xo.resolve()}}class Ah{constructor(){this.Zn=new Pi(Dh.ts),this.es=new Pi(Dh.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){var n=new Dh(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach(t=>this.addReference(t,e))}removeReference(t,e){this.rs(new Dh(t,e))}os(t,e){t.forEach(t=>this.removeReference(t,e))}cs(t){const e=new is(new Gr([])),n=new Dh(e,t),r=new Dh(e,t+1),s=[];return this.es.forEachInRange([n,r],t=>{this.rs(t),s.push(t.key)}),s}us(){this.Zn.forEach(t=>this.rs(t))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){var e=new is(new Gr([])),n=new Dh(e,t),e=new Dh(e,t+1);let r=Ki();return this.es.forEachInRange([n,e],t=>{r=r.add(t.key)}),r}containsKey(t){var e=new Dh(t,0),e=this.Zn.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)}}class Dh{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return is.comparator(t.key,e.key)||Fr(t.ls,e.ls)}static ns(t,e){return Fr(t.ls,e.ls)||is.comparator(t.key,e.key)}}class Ch{constructor(t,e){this.Ht=t,this.referenceDelegate=e,this.In=[],this.fs=1,this.ds=new Pi(Dh.ts)}checkEmpty(t){return Xo.resolve(0===this.In.length)}addMutationBatch(t,e,n,r){var s=this.fs;this.fs++,0<this.In.length&&this.In[this.In.length-1];var i=new ca(s,e,n,r);this.In.push(i);for(const e of r)this.ds=this.ds.add(new Dh(e.key,s)),this.Ht.addToCollectionParentIndex(t,e.key.path.popLast());return Xo.resolve(i)}lookupMutationBatch(t,e){return Xo.resolve(this.ws(e))}getNextMutationBatchAfterBatchId(t,e){var n=this._s(e+1),n=n<0?0:n;return Xo.resolve(this.In.length>n?this.In[n]:null)}getHighestUnacknowledgedBatchId(){return Xo.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(t){return Xo.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Dh(e,0),r=new Dh(e,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],t=>{var e=this.ws(t.ls);s.push(e)}),Xo.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new Pi(Fr);return e.forEach(t=>{var e=new Dh(t,0),n=new Dh(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,n],t=>{r=r.add(t.ls)})}),Xo.resolve(this.gs(r))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;is.isDocumentKey(s)||(s=s.child(""));var i=new Dh(new is(s),0);let o=new Pi(Fr);return this.ds.forEachWhile(t=>{var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.ls)),!0)},i),Xo.resolve(this.gs(o))}gs(t){const n=[];return t.forEach(t=>{var e=this.ws(t);null!==e&&n.push(e)}),n}removeMutationBatch(n,r){_r(0===this.ys(r.batchId,"removed")),this.In.shift();let s=this.ds;return Xo.forEach(r.mutations,t=>{var e=new Dh(t.key,r.batchId);return s=s.delete(e),this.referenceDelegate.markPotentiallyOrphaned(n,t.key)}).next(()=>{this.ds=s})}te(t){}containsKey(t,e){var n=new Dh(e,0),n=this.ds.firstAfterOrEqual(n);return Xo.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.In.length,Xo.resolve()}ys(t,e){return this._s(t)}_s(t){return 0===this.In.length?0:t-this.In[0].batchId}ws(t){var e=this._s(t);return e<0||e>=this.In.length?null:this.In[e]}}class xh{constructor(t,e){this.Ht=t,this.ps=e,this.docs=new Oi(is.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.ps(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Ht.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Xo.resolve(n?n.document.clone():bs.newInvalidDocument(e))}getEntries(t,e){let n=Ui;return e.forEach(t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():bs.newInvalidDocument(t))}),Xo.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=Ui;const s=new is(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||ti(e,s)&&(r=r.insert(s.key,s.clone()))}return Xo.resolve(r)}Ts(t,e){return Xo.forEach(this.docs,t=>e(t))}newChangeBuffer(t){return new kh(this)}getSize(t){return Xo.resolve(this.size)}}class kh extends Ja{constructor(t){super(),this.Se=t}applyChanges(n){const r=[];return this.changes.forEach((t,e)=>{e.document.isValidDocument()?r.push(this.Se.addEntry(n,e.document,this.getReadTime(t))):this.Se.removeEntry(t)}),Xo.waitFor(r)}getFromCache(t,e){return this.Se.getEntry(t,e)}getAllFromCache(t,e){return this.Se.getEntries(t,e)}}class Rh{constructor(t){this.persistence=t,this.Es=new Xa(t=>Is(t),_s),this.lastRemoteSnapshotVersion=qr.min(),this.highestTargetId=0,this.Is=0,this.As=new Ah,this.targetCount=0,this.Rs=Ua.se()}forEachTarget(t,n){return this.Es.forEach((t,e)=>n(e)),Xo.resolve()}getLastRemoteSnapshotVersion(t){return Xo.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Xo.resolve(this.Is)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),Xo.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Is&&(this.Is=e),Xo.resolve()}ce(t){this.Es.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.Rs=new Ua(e),this.highestTargetId=e),t.sequenceNumber>this.Is&&(this.Is=t.sequenceNumber)}addTargetData(t,e){return this.ce(e),this.targetCount+=1,Xo.resolve()}updateTargetData(t,e){return this.ce(e),Xo.resolve()}removeTargetData(t,e){return this.Es.delete(e.target),this.As.cs(e.targetId),--this.targetCount,Xo.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.Es.forEach((t,e)=>{e.sequenceNumber<=r&&null===s.get(e.targetId)&&(this.Es.delete(t),o.push(this.removeMatchingKeysForTargetId(n,e.targetId)),i++)}),Xo.waitFor(o).next(()=>i)}getTargetCount(t){return Xo.resolve(this.targetCount)}getTargetData(t,e){var n=this.Es.get(e)||null;return Xo.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),Xo.resolve()}removeMatchingKeys(e,t,n){this.As.os(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),Xo.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.As.cs(e),Xo.resolve()}getMatchingKeysForTargetId(t,e){var n=this.As.hs(e);return Xo.resolve(n)}containsKey(t,e){return Xo.resolve(this.As.containsKey(e))}}class Lh{constructor(t,e){var n;this.bs={},this.Le=new Or(0),this.Be=!1,this.Be=!0,this.referenceDelegate=t(this),this.ze=new Rh(this),this.Ht=new Na,this.He=(n=this.Ht,t=t=>this.referenceDelegate.Ps(t),new xh(n,t)),this.N=new da(e),this.Je=new Nh(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(t){let e=this.bs[t.toKey()];return e||(e=new Ch(this.Ht,this.referenceDelegate),this.bs[t.toKey()]=e),e}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(t,e,n){wr("MemoryPersistence","Starting transaction:",t);const r=new Oh(this.Le.next());return this.referenceDelegate.vs(),n(r).next(t=>this.referenceDelegate.Vs(r).next(()=>t)).toPromise().then(t=>(r.raiseOnCommittedEvent(),t))}Ss(e,n){return Xo.or(Object.values(this.bs).map(t=>()=>t.containsKey(e,n)))}}class Oh extends Yo{constructor(t){super(),this.currentSequenceNumber=t}}class Mh{constructor(t){this.persistence=t,this.Ds=new Ah,this.Cs=null}static Ns(t){return new Mh(t)}get xs(){if(this.Cs)return this.Cs;throw Ir()}addReference(t,e,n){return this.Ds.addReference(n,e),this.xs.delete(n.toString()),Xo.resolve()}removeReference(t,e,n){return this.Ds.removeReference(n,e),this.xs.add(n.toString()),Xo.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Xo.resolve()}removeTarget(t,e){this.Ds.cs(e.targetId).forEach(t=>this.xs.add(t.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(t=>{t.forEach(t=>this.xs.add(t.toString()))}).next(()=>n.removeTargetData(t,e))}vs(){this.Cs=new Set}Vs(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Xo.forEach(this.xs,t=>{const e=is.fromPath(t);return this.ks(n,e).next(t=>{t||r.removeEntry(e)})}).next(()=>(this.Cs=null,r.apply(n)))}updateLimboDocument(t,e){return this.ks(t,e).next(t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())})}Ps(t){return 0}ks(t,e){return Xo.or([()=>Xo.resolve(this.Ds.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ss(t,e)])}}function Fh(t,e){return`firestore_clients_${t}_${e}`}function Ph(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Vh(t,e){return`firestore_targets_${t}_${e}`}class Uh{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static $s(t,e,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Nr(r.error.code,r.error.message))),i?new Uh(t,e,r.state,s):(br("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class qh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static $s(t,e){var n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Nr(n.error.code,n.error.message))),s?new qh(t,n.state,r):(br("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Bh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static $s(t,e){var n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=$i;for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ss(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Bh(t,s):(br("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class jh{constructor(t,e){this.clientId=t,this.onlineState=e}static $s(t){var e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new jh(e.clientId,e.onlineState):(br("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Kh{constructor(){this.activeTargetIds=$i}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ms(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class $h{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Ls=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Bs=this.Us.bind(this),this.qs=new Oi(Fr),this.started=!1,this.Ks=[];var i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.js=Fh(this.persistenceKey,this.Ls),this.Qs=`firestore_sequence_number_${this.persistenceKey}`,this.qs=this.qs.insert(this.Ls,new Kh),this.Ws=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Gs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.zs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Hs=`firestore_online_state_${this.persistenceKey}`,this.Js=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.Bs)}static bt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.pn();for(const n of t)if(n!==this.Ls){const t=this.getItem(Fh(this.persistenceKey,n));var e;!t||(e=Bh.$s(n,t))&&(this.qs=this.qs.insert(e.clientId,e))}this.Ys();const n=this.storage.getItem(this.Hs);if(n){const t=this.Xs(n);t&&this.Zs(t)}for(const t of this.Ks)this.Us(t);this.Ks=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(t){this.setItem(this.Qs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ti(this.qs)}isActiveQueryTarget(n){let r=!1;return this.qs.forEach((t,e)=>{e.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(t){this.ei(t,"pending")}updateMutationState(t,e,n){this.ei(t,e,n),this.ni(t)}addLocalQueryTarget(t){let e="not-current";var n;return this.isActiveQueryTarget(t)&&(!(n=this.storage.getItem(Vh(this.persistenceKey,t)))||(n=qh.$s(t,n))&&(e=n.state)),this.si.Fs(t),this.Ys(),e}removeLocalQueryTarget(t){this.si.Ms(t),this.Ys()}isLocalQueryTarget(t){return this.si.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Vh(this.persistenceKey,t))}updateQueryState(t,e,n){this.ii(t,e,n)}handleUserChange(t,e,n){e.forEach(t=>{this.ni(t)}),this.currentUser=t,n.forEach(t=>{this.addPendingMutation(t)})}setOnlineState(t){this.ri(t)}notifyBundleLoaded(){this.oi()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Bs),this.removeItem(this.js),this.started=!1)}getItem(t){var e=this.storage.getItem(t);return wr("SharedClientState","READ",t,e),e}setItem(t,e){wr("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){wr("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Us(t){const r=t;r.storageArea===this.storage&&(wr("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.js?this.Oe.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Ws.test(r.key)){if(null==r.newValue){var t=this.ci(r.key);return this.ai(t,null)}t=this.ui(r.key,r.newValue);if(t)return this.ai(t.clientId,t)}else if(this.Gs.test(r.key)){if(null!==r.newValue){var e=this.hi(r.key,r.newValue);if(e)return this.li(e)}}else if(this.zs.test(r.key)){if(null!==r.newValue){e=this.fi(r.key,r.newValue);if(e)return this.di(e)}}else if(r.key===this.Hs){if(null!==r.newValue){var n=this.Xs(r.newValue);if(n)return this.Zs(n)}}else if(r.key===this.Qs){n=function(t){let e=Or.T;if(null!=t)try{var n=JSON.parse(t);_r("number"==typeof n),e=n}catch(t){br("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(r.newValue);n!==Or.T&&this.sequenceNumberHandler(n)}else if(r.key===this.Js)return this.syncEngine.wi()}else this.Ks.push(r)}):br("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get si(){return this.qs.get(this.Ls)}Ys(){this.setItem(this.js,this.si.Os())}ei(t,e,n){const r=new Uh(this.currentUser,t,e,n),s=Ph(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}ni(t){var e=Ph(this.persistenceKey,this.currentUser,t);this.removeItem(e)}ri(t){var e={clientId:this.Ls,onlineState:t};this.storage.setItem(this.Hs,JSON.stringify(e))}ii(t,e,n){const r=Vh(this.persistenceKey,t),s=new qh(t,e,n);this.setItem(r,s.Os())}oi(){this.setItem(this.Js,"value-not-used")}ci(t){var e=this.Ws.exec(t);return e?e[1]:null}ui(t,e){var n=this.ci(t);return Bh.$s(n,e)}hi(t,e){var n=this.Gs.exec(t),r=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Uh.$s(new mr(n),r,e)}fi(t,e){var n=this.zs.exec(t),n=Number(n[1]);return qh.$s(n,e)}Xs(t){return jh.$s(t)}async li(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine._i(t.batchId,t.state,t.error);wr("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}di(t){return this.syncEngine.mi(t.targetId,t.state,t.error)}ai(t,e){const n=e?this.qs.insert(t,e):this.qs.remove(t),r=this.ti(this.qs),s=this.ti(n),i=[],o=[];return s.forEach(t=>{r.has(t)||i.push(t)}),r.forEach(t=>{s.has(t)||o.push(t)}),this.syncEngine.gi(i,o).then(()=>{this.qs=n})}Zs(t){this.qs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ti(t){let n=$i;return t.forEach((t,e)=>{n=n.unionWith(e.activeTargetIds)}),n}}class Gh{constructor(){this.yi=new Kh,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.yi.Fs(t),this.pi[t]||"not-current"}updateQueryState(t,e,n){this.pi[t]=e}removeLocalQueryTarget(t){this.yi.Ms(t)}isLocalQueryTarget(t){return this.yi.activeTargetIds.has(t)}clearQueryState(t){delete this.pi[t]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(t){return this.yi.activeTargetIds.has(t)}start(){return this.yi=new Kh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class Hh{Ti(t){}shutdown(){}}class zh{constructor(){this.Ei=()=>this.Ii(),this.Ai=()=>this.Ri(),this.bi=[],this.Pi()}Ti(t){this.bi.push(t)}shutdown(){window.removeEventListener("online",this.Ei),window.removeEventListener("offline",this.Ai)}Pi(){window.addEventListener("online",this.Ei),window.addEventListener("offline",this.Ai)}Ii(){wr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.bi)t(0)}Ri(){wr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.bi)t(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Qh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Wh{constructor(t){this.vi=t.vi,this.Vi=t.Vi}Si(t){this.Di=t}Ci(t){this.Ni=t}onMessage(t){this.xi=t}close(){this.Vi()}send(t){this.vi(t)}ki(){this.Di()}$i(t){this.Ni(t)}Oi(t){this.xi(t)}}class Yh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(e,t,n,r){const s=this.Bi(e,t);wr("RestConnection","Sending: ",s,n);var i={};return this.Ui(i,r),this.qi(e,s,i,n).then(t=>(wr("RestConnection","Received: ",t),t),t=>{throw Er("RestConnection",`${e} failed with error: `,t,"url: ",s,"request:",n),t})}Ki(t,e,n,r){return this.Li(t,e,n,r)}Ui(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/"+pr,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(const n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])}Bi(t,e){var n=Qh[t];return`${this.Fi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}qi(a,e,n,r){return new Promise((s,i)=>{const o=new fr;o.listenOnce(ar.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case or.NO_ERROR:var t=o.getResponseJson();wr("Connection","XHR received:",JSON.stringify(t)),s(t);break;case or.TIMEOUT:wr("Connection",'RPC "'+a+'" timed out'),i(new Nr(Sr.DEADLINE_EXCEEDED,"Request time out"));break;case or.HTTP_ERROR:var e,n=o.getStatus();if(wr("Connection",'RPC "'+a+'" failed with status:',n,"response text:",o.getResponseText()),0<n){const a=o.getResponseJson().error;a&&a.status&&a.message?(r=a.status.toLowerCase().replace(/_/g,"-"),e=0<=Object.values(Sr).indexOf(r)?r:Sr.UNKNOWN,i(new Nr(e,a.message))):i(new Nr(Sr.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Nr(Sr.UNAVAILABLE,"Connection failed."));break;default:Ir()}}finally{wr("Connection",'RPC "'+a+'" completed.')}var r});var t=JSON.stringify(r);o.send(e,"POST",t,n,15)})}ji(t,e){const n=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=new Zn,s=ir(),i={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(i.xmlHttpFactory=new lr({})),this.Ui(i.initMessageHeaders,e),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=d().indexOf("Electron/")||function(){const t=d();return 0<=t.indexOf("MSIE ")||0<=t.indexOf("Trident/")}()||0<=d().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");wr("Connection","Creating WebChannel: "+o,i);const a=r.createWebChannel(o,i);let h=!1,c=!1;const u=new Wh({vi:t=>{c?wr("Connection","Not sending because WebChannel is closed:",t):(h||(wr("Connection","Opening WebChannel transport."),a.open(),h=!0),wr("Connection","WebChannel sending:",t),a.send(t))},Vi:()=>a.close()}),l=(t,e,n)=>{t.listen(e,t=>{try{n(t)}catch(t){setTimeout(()=>{throw t},0)}})};return l(a,dr.EventType.OPEN,()=>{c||wr("Connection","WebChannel transport opened.")}),l(a,dr.EventType.CLOSE,()=>{c||(c=!0,wr("Connection","WebChannel transport closed"),u.$i())}),l(a,dr.EventType.ERROR,t=>{c||(c=!0,Er("Connection","WebChannel transport errored:",t),u.$i(new Nr(Sr.UNAVAILABLE,"The operation could not be completed")))}),l(a,dr.EventType.MESSAGE,n=>{if(!c){var t=n.data[0];_r(!!t);var r=t.error||(null===(r=t[0])||void 0===r?void 0:r.error);if(r){wr("Connection","WebChannel received error:",r);const n=r.status;let t=function(t){var e=sr[t];if(void 0!==e)return Li(e)}(n),e=r.message;void 0===t&&(t=Sr.INTERNAL,e="Unknown error status: "+n+" with message "+r.message),c=!0,u.$i(new Nr(t,e)),a.close()}else wr("Connection","WebChannel received:",t),u.Oi(t)}}),l(s,hr.STAT_EVENT,t=>{t.stat===cr?wr("Connection","Detected buffering proxy"):t.stat===ur&&wr("Connection","Detected no buffering proxy")}),setTimeout(()=>{u.ki()},0),u}}function Xh(){return"undefined"!=typeof window?window:null}function Jh(){return"undefined"!=typeof document?document:null}function Zh(t){return new no(t,!0)}class tc{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Qi=n,this.Wi=r,this.Gi=s,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(t){this.cancel();var e=Math.floor(this.zi+this.Zi()),n=Math.max(0,Date.now()-this.Ji),r=Math.max(0,e-n);0<r&&wr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.zi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,r,()=>(this.Ji=Date.now(),t())),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-.5)*this.zi}}class ec{constructor(t,e,n,r,s,i,o){this.Oe=t,this.er=n,this.nr=r,this.sr=s,this.credentialsProvider=i,this.listener=o,this.state=0,this.ir=0,this.rr=null,this.cr=null,this.stream=null,this.ar=new tc(t,e)}ur(){return 1===this.state||5===this.state||this.hr()}hr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.lr()}async stop(){this.ur()&&await this.close(0)}dr(){this.state=0,this.ar.reset()}wr(){this.hr()&&null===this.rr&&(this.rr=this.Oe.enqueueAfterDelay(this.er,6e4,()=>this._r()))}mr(t){this.gr(),this.stream.send(t)}async _r(){if(this.hr())return this.close(0)}gr(){this.rr&&(this.rr.cancel(),this.rr=null)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(t,e){this.gr(),this.yr(),this.ar.cancel(),this.ir++,4!==t?this.ar.reset():e&&e.code===Sr.RESOURCE_EXHAUSTED?(br(e.toString()),br("Using maximum backoff delay to prevent overloading the backend."),this.ar.Yi()):e&&e.code===Sr.UNAUTHENTICATED&&3!==this.state&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.pr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ci(e)}pr(){}auth(){this.state=1;const t=this.Tr(this.ir),e=this.ir;this.credentialsProvider.getToken().then(t=>{this.ir===e&&this.Er(t)},e=>{t(()=>{var t=new Nr(Sr.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ir(t)})})}Er(t){const e=this.Tr(this.ir);this.stream=this.Ar(t),this.stream.Si(()=>{e(()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.nr,1e4,()=>(this.hr()&&(this.state=3),Promise.resolve())),this.listener.Si()))}),this.stream.Ci(t=>{e(()=>this.Ir(t))}),this.stream.onMessage(t=>{e(()=>this.onMessage(t))})}lr(){this.state=5,this.ar.Xi(async()=>{this.state=0,this.start()})}Ir(t){return wr("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Tr(e){return t=>{this.Oe.enqueueAndForget(()=>this.ir===e?t():(wr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class nc extends ec{constructor(t,e,n,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s),this.N=r}Ar(t){return this.sr.ji("Listen",t)}onMessage(t){this.ar.reset();var e=function(t,e){let n;if("targetChange"in e){e.targetChange;var r="NO_CHANGE"===(f=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Ir(),s=e.targetChange.targetIds||[],i=(f=e.targetChange.resumeToken,t.D?(_r(void 0===f||"string"==typeof f),Wr.fromBase64String(f||"")):(_r(void 0===f||f instanceof Uint8Array),Wr.fromUint8Array(f||new Uint8Array))),o=e.targetChange.cause,a=o&&(a=void 0===(f=o).code?Sr.UNKNOWN:Li(f.code),new Nr(a,f.message||""));n=new Wi(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;var h=e.documentChange;h.document,h.document.name,h.document.updateTime;var a=co(t,h.document.name),c=io(h.document.updateTime),u=new ws({mapValue:{fields:h.document.fields}}),c=bs.newFoundDocument(a,c,u),u=h.targetIds||[],h=h.removedTargetIds||[];n=new zi(u,h,c.key,c)}else if("documentDelete"in e){e.documentDelete;u=e.documentDelete;u.document;h=co(t,u.document),c=u.readTime?io(u.readTime):qr.min(),c=bs.newNoDocument(h,c),u=u.removedTargetIds||[];n=new zi([],u,c.key,c)}else if("documentRemove"in e){e.documentRemove;var l=e.documentRemove;l.document;var d=co(t,l.document),l=l.removedTargetIds||[];n=new zi([],l,d,null)}else{if(!("filter"in e))return Ir();{e.filter;const t=e.filter;t.targetId;l=t.count||0,d=new ki(l),l=t.targetId;n=new Qi(l,d)}}var a,f;return n}(this.N,t),n=function(t){if(!("targetChange"in t))return qr.min();var e=t.targetChange;return(!e.targetIds||!e.targetIds.length)&&e.readTime?io(e.readTime):qr.min()}(t);return this.listener.Rr(e,n)}br(t){const e={};e.database=fo(this.N),e.addTarget=function(t,e){let n;var r=e.target;return n=Ss(r)?{documents:wo(t,r)}:{query:bo(t,r)},n.targetId=e.targetId,0<e.resumeToken.approximateByteSize()?n.resumeToken=so(t,e.resumeToken):0<e.snapshotVersion.compareTo(qr.min())&&(n.readTime=ro(t,e.snapshotVersion.toTimestamp())),n}(this.N,t);var n,r,r=(this.N,n=t,null==(r=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ir()}}())?null:{"goog-listen-tags":r});r&&(e.labels=r),this.mr(e)}Pr(t){const e={};e.database=fo(this.N),e.removeTarget=t,this.mr(e)}}class rc extends ec{constructor(t,e,n,r,s){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s),this.N=r,this.vr=!1}get Vr(){return this.vr}start(){this.vr=!1,this.lastStreamToken=void 0,super.start()}pr(){this.vr&&this.Sr([])}Ar(t){return this.sr.ji("Write",t)}onMessage(t){if(_r(!!t.streamToken),this.lastStreamToken=t.streamToken,this.vr){this.ar.reset();var e=(r=t.writeResults,s=t.commitTime,r&&0<r.length?(_r(void 0!==s),r.map(t=>function(t,e){let n=t.updateTime?io(t.updateTime):io(e);return n.isEqual(qr.min())&&(n=io(e)),new pi(n,t.transformResults||[])}(t,s))):[]),n=io(t.commitTime);return this.listener.Dr(n,e)}var r,s;return _r(!t.writeResults||0===t.writeResults.length),this.vr=!0,this.listener.Cr()}Nr(){const t={};t.database=fo(this.N),this.mr(t)}Sr(t){var e={streamToken:this.lastStreamToken,writes:t.map(t=>yo(this.N,t))};this.mr(e)}}class sc extends class{}{constructor(t,e,n){super(),this.credentials=t,this.sr=e,this.N=n,this.kr=!1}$r(){if(this.kr)throw new Nr(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}Li(e,n,r){return this.$r(),this.credentials.getToken().then(t=>this.sr.Li(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Sr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Nr(Sr.UNKNOWN,t.toString())})}Ki(e,n,r){return this.$r(),this.credentials.getToken().then(t=>this.sr.Ki(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Sr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Nr(Sr.UNKNOWN,t.toString())})}terminate(){this.kr=!0}}class ic{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Or=0,this.Fr=null,this.Mr=!0}Lr(){0===this.Or&&(this.Br("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.Fr=null,this.Ur("Backend didn't respond within 10 seconds."),this.Br("Offline"),Promise.resolve())))}qr(t){"Online"===this.state?this.Br("Unknown"):(this.Or++,1<=this.Or&&(this.Kr(),this.Ur(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Br("Offline")))}set(t){this.Kr(),this.Or=0,"Online"===t&&(this.Mr=!1),this.Br(t)}Br(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Ur(t){var e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Mr?(br(e),this.Mr=!1):wr("OnlineStateTracker",e)}Kr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}class oc{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.jr=[],this.Qr=new Map,this.Wr=new Set,this.Gr=[],this.zr=s,this.zr.Ti(t=>{n.enqueueAndForget(async()=>{mc(this)&&(wr("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=t;e.Wr.add(4),await hc(e),e.Hr.set("Unknown"),e.Wr.delete(4),await ac(e)}(this))})}),this.Hr=new ic(n,r)}}async function ac(t){if(mc(t))for(const e of t.Gr)await e(!0)}async function hc(t){for(const e of t.Gr)await e(!1)}function cc(t,e){const n=t;n.Qr.has(e.targetId)||(n.Qr.set(e.targetId,e),gc(n)?fc(n):Ic(n).hr()&&lc(n,e))}function uc(t,e){const n=t,r=Ic(n);n.Qr.delete(e),r.hr()&&dc(n,e),0===n.Qr.size&&(r.hr()?r.wr():mc(n)&&n.Hr.set("Unknown"))}function lc(t,e){t.Jr.Y(e.targetId),Ic(t).br(e)}function dc(t,e){t.Jr.Y(e),Ic(t).Pr(e)}function fc(e){e.Jr=new Xi({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Tt:t=>e.Qr.get(t)||null}),Ic(e).start(),e.Hr.Lr()}function gc(t){return mc(t)&&!Ic(t).ur()&&0<t.Qr.size}function mc(t){return 0===t.Wr.size}function pc(t){t.Jr=void 0}async function yc(t,e,n){if(!na(e))throw e;t.Wr.add(1),await hc(t),t.Hr.set("Offline"),n=n||(()=>vh(t.localStore)),t.asyncQueue.enqueueRetryable(async()=>{wr("RemoteStore","Retrying IndexedDB access"),await n(),t.Wr.delete(1),await ac(t)})}function vc(e,n){return n().catch(t=>yc(e,t,n))}async function wc(t){const e=t,n=_c(e);let r=0<e.jr.length?e.jr[e.jr.length-1].batchId:-1;for(;mc(s=e)&&s.jr.length<10;)try{const t=await function(t,e){const n=t;return n.persistence.runTransaction("Get next mutation batch","readonly",t=>(void 0===e&&(e=-1),n.In.getNextMutationBatchAfterBatchId(t,e)))}(e.localStore,r);if(null===t){0===e.jr.length&&n.wr();break}r=t.batchId,function(t,e){t.jr.push(e);const n=_c(t);n.hr()&&n.Vr&&n.Sr(e.mutations)}(e,t)}catch(t){await yc(e,t)}var s;bc(e)&&Ec(e)}function bc(t){return mc(t)&&!_c(t).ur()&&0<t.jr.length}function Ec(t){_c(t).start()}async function Tc(t,e){const n=t;e?(n.Wr.delete(2),await ac(n)):(n.Wr.add(2),await hc(n),n.Hr.set("Unknown"))}function Ic(e){return e.Yr||(e.Yr=function(t,e,n){const r=t;return r.$r(),new nc(e,r.sr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:(async function(n){n.Qr.forEach((t,e)=>{lc(n,t)})}).bind(null,e),Ci:(async function(t,e){pc(t),gc(t)?(t.Hr.qr(e),fc(t)):t.Hr.set("Unknown")}).bind(null,e),Rr:(async function(t,r,e){if(t.Hr.set("Online"),r instanceof Wi&&2===r.state&&r.cause)try{await async function(t){var e=r.cause;for(const n of r.targetIds)t.Qr.has(n)&&(await t.remoteSyncer.rejectListen(n,e),t.Qr.delete(n),t.Jr.removeTarget(n))}(t)}catch(e){wr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),e),await yc(t,e)}else if(r instanceof zi?t.Jr.rt(r):r instanceof Qi?t.Jr.ft(r):t.Jr.at(r),!e.isEqual(qr.min()))try{const r=await vh(t.localStore);0<=e.compareTo(r)&&await function(r,s){const t=r.Jr._t(s);return t.targetChanges.forEach((t,e)=>{if(0<t.resumeToken.approximateByteSize()){const n=r.Qr.get(e);n&&r.Qr.set(e,n.withResumeToken(t.resumeToken,s))}}),t.targetMismatches.forEach(t=>{const e=r.Qr.get(t);var n;e&&(r.Qr.set(t,e.withResumeToken(Wr.EMPTY_BYTE_STRING,e.snapshotVersion)),dc(r,t),n=new la(e.target,t,1,e.sequenceNumber),lc(r,n))}),r.remoteSyncer.applyRemoteEvent(t)}(t,e)}catch(r){wr("RemoteStore","Failed to raise snapshot:",r),await yc(t,r)}}).bind(null,e)}),e.Gr.push(async t=>{t?(e.Yr.dr(),gc(e)?fc(e):e.Hr.set("Unknown")):(await e.Yr.stop(),pc(e))})),e.Yr}function _c(e){return e.Xr||(e.Xr=function(t,e,n){const r=t;return r.$r(),new rc(e,r.sr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:(async function(t){_c(t).Nr()}).bind(null,e),Ci:(async function(t,e){e&&_c(t).Vr&&await async function(t,e){if(Ri(n=e.code)&&n!==Sr.ABORTED){const n=t.jr.shift();_c(t).dr(),await vc(t,()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e)),await wc(t)}var n}(t,e),bc(t)&&Ec(t)}).bind(null,e),Cr:(async function(t){const e=_c(t);for(const n of t.jr)e.Sr(n.mutations)}).bind(null,e),Dr:(async function(t,e,n){const r=t.jr.shift(),s=ua.from(r,e,n);await vc(t,()=>t.remoteSyncer.applySuccessfulWrite(s)),await wc(t)}).bind(null,e)}),e.Gr.push(async t=>{t?(e.Xr.dr(),await wc(e)):(await e.Xr.stop(),0<e.jr.length&&(wr("RemoteStore",`Stopping write stream with ${e.jr.length} pending writes`),e.jr=[]))})),e.Xr}class Sc{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Ar,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(t=>{})}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new Sc(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Nr(Sr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Nc(t,e){if(br("AsyncQueue",`${e}: ${t}`),na(t))return new Nr(Sr.UNAVAILABLE,`${e}: ${t}`);throw t}class Ac{constructor(n){this.comparator=n?(t,e)=>n(t,e)||is.comparator(t.key,e.key):(t,e)=>is.comparator(t.key,e.key),this.keyedMap=qi,this.sortedSet=new Oi(this.comparator)}static emptySet(t){return new Ac(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){var e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((t,e)=>(n(t),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Ac))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(t,e){const n=new Ac;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Dc{constructor(){this.Zr=new Oi(is.comparator)}track(t){var e=t.doc.key,n=this.Zr.get(e);!n||0!==t.type&&3===n.type?this.Zr=this.Zr.insert(e,t):3===t.type&&1!==n.type?this.Zr=this.Zr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Zr=this.Zr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Zr=this.Zr.remove(e):1===t.type&&2===n.type?this.Zr=this.Zr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Zr=this.Zr.insert(e,{type:2,doc:t.doc}):Ir()}eo(){const n=[];return this.Zr.inorderTraversal((t,e)=>{n.push(e)}),n}}class Cc{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach(t=>{s.push({type:0,doc:t})}),new Cc(t,e,Ac.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Xs(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class xc{constructor(){this.no=void 0,this.listeners=[]}}class kc{constructor(){this.queries=new Xa(t=>Js(t),Xs),this.onlineState="Unknown",this.so=new Set}}async function Rc(t,e){const n=t,r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new xc),s)try{i.no=await n.onListen(r)}catch(t){const n=Nc(t,`Initialization of query '${Zs(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.io(n.onlineState),!i.no||e.ro(i.no)&&Oc(n)}async function Lc(t,e){const n=t,r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);0<=t&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Oc(t){t.so.forEach(t=>{t.next()})}class Mc{constructor(t,e,n){this.query=t,this.oo=e,this.co=!1,this.ao=null,this.onlineState="Unknown",this.options=n||{}}ro(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Cc(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.co?this.uo(t)&&(this.oo.next(t),e=!0):this.ho(t,this.onlineState)&&(this.lo(t),e=!0),this.ao=t,e}onError(t){this.oo.error(t)}io(t){this.onlineState=t;let e=!1;return this.ao&&!this.co&&this.ho(this.ao,t)&&(this.lo(this.ao),e=!0),e}ho(t,e){return!t.fromCache||!(this.options.fo&&"Offline"!==e||t.docs.isEmpty()&&"Offline"!==e)}uo(t){if(0<t.docChanges.length)return!0;var e=this.ao&&this.ao.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}lo(t){t=Cc.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.co=!0,this.oo.next(t)}}class Fc{constructor(t,e){this.payload=t,this.byteLength=e}wo(){return"metadata"in this.payload}}class Pc{constructor(t){this.N=t}zn(t){return co(this.N,t)}Hn(t){return t.metadata.exists?po(this.N,t.document,!1):bs.newNoDocument(this.zn(t.metadata.name),this.Jn(t.metadata.readTime))}Jn(t){return io(t)}}class Vc{constructor(t,e,n){this._o=t,this.localStore=e,this.N=n,this.queries=[],this.documents=[],this.progress=Uc(t)}mo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}yo(t){const e=new Map,n=new Pc(this.N);for(const s of t)if(s.metadata.queries){const t=n.zn(s.metadata.name);for(const n of s.metadata.queries){var r=(e.get(n)||Ki()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=t;let i=Ki(),o=Ui,a=Bi;for(const t of n){const n=e.zn(t.metadata.name);t.document&&(i=i.add(n)),o=o.insert(n,e.Hn(t)),a=a.insert(n,e.Jn(t.metadata.readTime))}const h=s.jn.newChangeBuffer({trackRemovals:!0}),c=await Eh(s,(r=r,Ws(js(Gr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>bh(e,h,o,qr.min(),a).next(t=>(h.apply(e),t)).next(t=>s.ze.removeMatchingKeysForTargetId(e,c.targetId).next(()=>s.ze.addMatchingKeys(e,i,c.targetId)).next(()=>s.Qn.vn(e,t)).next(()=>t)))}(this.localStore,new Pc(this.N),this.documents,this._o.id),e=this.yo(this.documents);for(const t of this.queries)await async function(t,n,r=Ki()){const s=await Eh(t,Ws(Ta(n.bundledQuery))),i=t;return i.persistence.runTransaction("Save named query","readwrite",t=>{var e=io(n.readTime);if(0<=s.snapshotVersion.compareTo(e))return i.Je.saveNamedQuery(t,n);e=s.withResumeToken(Wr.EMPTY_BYTE_STRING,e);return i.Un=i.Un.insert(e.targetId,e),i.ze.updateTargetData(t,e).next(()=>i.ze.removeMatchingKeysForTargetId(t,s.targetId)).next(()=>i.ze.addMatchingKeys(t,r,s.targetId)).next(()=>i.Je.saveNamedQuery(t,n))})}(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new lh(Object.assign({},this.progress),t)}}function Uc(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class qc{constructor(t){this.key=t}}class Bc{constructor(t){this.key=t}}class jc{constructor(t,e){this.query=t,this.po=e,this.To=null,this.current=!1,this.Eo=Ki(),this.mutatedKeys=Ki(),this.Io=ei(t),this.Ao=new Ac(this.Io)}get Ro(){return this.po}bo(t,e){const a=e?e.Po:new Dc,h=(e||this).Ao;let c=(e||this).mutatedKeys,u=h,l=!1;const d=Ks(this.query)&&h.size===this.query.limit?h.last():null,f=$s(this.query)&&h.size===this.query.limit?h.first():null;if(t.inorderTraversal((t,e)=>{const n=h.get(t),r=ti(this.query,e)?e:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.vo(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.Io(r,d)||f&&this.Io(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(c=r?(u=u.add(r),i?c.add(t):c.delete(t)):(u=u.delete(t),c.delete(t)))}),Ks(this.query)||$s(this.query))for(;u.size>this.query.limit;){const t=Ks(this.query)?u.last():u.first();u=u.delete(t.key),c=c.delete(t.key),a.track({type:1,doc:t})}return{Ao:u,Po:a,Ln:l,mutatedKeys:c}}vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){var r=this.Ao;this.Ao=t.Ao,this.mutatedKeys=t.mutatedKeys;const s=t.Po.eo();s.sort((t,e)=>function(t,e){var n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ir()}};return n(t)-n(e)}(t.type,e.type)||this.Io(t.doc,e.doc)),this.Vo(n);var i=e?this.So():[],o=0===this.Eo.size&&this.current?1:0,a=o!==this.To;return this.To=o,0!==s.length||a?{snapshot:new Cc(this.query,t.Ao,r,s,t.mutatedKeys,0==o,a,!1),Do:i}:{Do:i}}io(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ao:this.Ao,Po:new Dc,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{Do:[]}}Co(t){return!this.po.has(t)&&!!this.Ao.has(t)&&!this.Ao.get(t).hasLocalMutations}Vo(t){t&&(t.addedDocuments.forEach(t=>this.po=this.po.add(t)),t.modifiedDocuments.forEach(t=>{}),t.removedDocuments.forEach(t=>this.po=this.po.delete(t)),this.current=t.current)}So(){if(!this.current)return[];const e=this.Eo;this.Eo=Ki(),this.Ao.forEach(t=>{this.Co(t.key)&&(this.Eo=this.Eo.add(t.key))});const n=[];return e.forEach(t=>{this.Eo.has(t)||n.push(new Bc(t))}),this.Eo.forEach(t=>{e.has(t)||n.push(new qc(t))}),n}No(t){this.po=t.Gn,this.Eo=Ki();var e=this.bo(t.documents);return this.applyChanges(e,!0)}xo(){return Cc.fromInitialDocuments(this.query,this.Ao,this.mutatedKeys,0===this.To)}}class Kc{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class $c{constructor(t){this.key=t,this.ko=!1}}class Gc{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.$o={},this.Oo=new Xa(t=>Js(t),Xs),this.Fo=new Map,this.Mo=new Set,this.Lo=new Oi(is.comparator),this.Bo=new Map,this.Uo=new Ah,this.qo={},this.Ko=new Map,this.jo=Ua.ie(),this.onlineState="Unknown",this.Qo=void 0}get isPrimaryClient(){return!0===this.Qo}}async function Hc(n,t,e,r){n.Wo=(t,i,e)=>async function(t,e,n){let r=e.view.bo(i);r.Ln&&(r=await Ih(t.localStore,e.query,!1).then(({documents:t})=>e.view.bo(t,r)));var s=n&&n.targetChanges.get(e.targetId),s=e.view.applyChanges(r,t.isPrimaryClient,s);return eu(t,e.targetId,s.Do),s.snapshot}(n,t,e);const s=await Ih(n.localStore,t,!0),i=new jc(t,s.Gn),o=i.bo(s.documents),a=Hi.createSynthesizedTargetChangeForCurrentChange(e,r&&"Offline"!==n.onlineState),h=i.applyChanges(o,n.isPrimaryClient,a);eu(n,e,h.Do);var c=new Kc(t,e,i);return n.Oo.set(t,c),n.Fo.has(e)?n.Fo.get(e).push(t):n.Fo.set(e,[t]),h.snapshot}async function zc(t,e,n){const r=hu(t);try{const t=await function(t,r){const s=t,i=Ur.now(),e=r.reduce((t,e)=>t.add(e.key),Ki());let o;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Qn.Pn(n,e).next(t=>{o=t;const e=[];for(const n of r){const r=function(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=oi(r.transform,t||null);null!=s&&(null==n&&(n=ws.empty()),n.set(r.field,s))}return n||null}(n,o.get(n.key));null!=r&&e.push(new Si(n.key,r,function r(t){const s=[];return jr(t.fields,(t,e)=>{const n=new zr([t]);if(ys(e)){const t=r(e.mapValue).fields;if(0===t.length)s.push(n);else for(const e of t)s.push(n.child(e))}else s.push(n)}),new Qr(s)}(r.value.mapValue),yi.exists(!0)))}return s.In.addMutationBatch(n,i,e,r)})).then(t=>(t.applyToLocalDocumentSet(o),{batchId:t.batchId,changes:o}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.qo[t.currentUser.toKey()];r=r||new Oi(Fr),r=r.insert(e,n),t.qo[t.currentUser.toKey()]=r}(r,t.batchId,n),await ru(r,t.changes),await wc(r.remoteStore)}catch(t){const e=Nc(t,"Failed to persist write");n.reject(e)}}async function Qc(t,e){const r=t;try{const t=await wh(r.localStore,e);e.targetChanges.forEach((t,e)=>{const n=r.Bo.get(e);n&&(_r(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),0<t.addedDocuments.size?n.ko=!0:0<t.modifiedDocuments.size?_r(n.ko):0<t.removedDocuments.size&&(_r(n.ko),n.ko=!1))}),await ru(r,t,e)}catch(t){await $a(t)}}function Wc(r,s,t){const e=r;if(e.isPrimaryClient&&0===t||!e.isPrimaryClient&&1===t){const r=[];e.Oo.forEach((t,e)=>{var n=e.view.io(s);n.snapshot&&r.push(n.snapshot)}),function(t,n){const e=t;e.onlineState=n;let r=!1;e.queries.forEach((t,e)=>{for(const t of e.listeners)t.io(n)&&(r=!0)}),r&&Oc(e)}(e.eventManager,s),r.length&&e.$o.Rr(r),e.onlineState=s,e.isPrimaryClient&&e.sharedClientState.setOnlineState(s)}}async function Yc(t,e){const n=t,r=e.batch.batchId;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",t=>{const e=r.batch.keys(),n=s.jn.newChangeBuffer({trackRemovals:!0});return function(t,e,r,s){const i=r.batch,n=i.keys();let o=Xo.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(e,n)).next(t=>{var e=r.docVersions.get(n);_r(null!==e),t.version.compareTo(e)<0&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&s.addEntry(t,r.commitVersion))})}),o.next(()=>t.In.removeMutationBatch(e,i))}(s,t,r,n).next(()=>n.apply(t)).next(()=>s.In.performConsistencyCheck(t)).next(()=>s.Qn.Pn(t,e))})}(n.localStore,e);Jc(n,r,null),Xc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ru(n,t)}catch(t){await $a(t)}}function Xc(t,e){(t.Ko.get(e)||[]).forEach(t=>{t.resolve()}),t.Ko.delete(e)}function Jc(t,e,n){const r=t;let s=r.qo[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.qo[r.currentUser.toKey()]=s}}function Zc(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Fo.get(t))e.Oo.delete(r),n&&e.$o.Go(r,n);e.Fo.delete(t),e.isPrimaryClient&&e.Uo.cs(t).forEach(t=>{e.Uo.containsKey(t)||tu(e,t)})}function tu(t,e){t.Mo.delete(e.path.canonicalString());var n=t.Lo.get(e);null!==n&&(uc(t.remoteStore,n),t.Lo=t.Lo.remove(e),t.Bo.delete(n),nu(t))}function eu(t,e,n){for(const r of n)r instanceof qc?(t.Uo.addReference(r.key,e),function(t,e){const n=e.key,r=n.path.canonicalString();t.Lo.get(n)||t.Mo.has(r)||(wr("SyncEngine","New document in limbo: "+n),t.Mo.add(r),nu(t))}(t,r)):r instanceof Bc?(wr("SyncEngine","Document no longer in limbo: "+r.key),t.Uo.removeReference(r.key,e),t.Uo.containsKey(r.key)||tu(t,r.key)):Ir()}function nu(t){for(;0<t.Mo.size&&t.Lo.size<t.maxConcurrentLimboResolutions;){var e=t.Mo.values().next().value;t.Mo.delete(e);var n=new is(Gr.fromString(e)),e=t.jo.next();t.Bo.set(e,new $c(n)),t.Lo=t.Lo.insert(n,e),cc(t.remoteStore,new la(Ws(js(n.path)),e,2,Or.T))}}async function ru(t,e,r){const s=t,i=[],o=[],a=[];s.Oo.isEmpty()||(s.Oo.forEach((t,n)=>{a.push(s.Wo(n,e,r).then(t=>{var e;t&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(n.targetId,t.fromCache?"not-current":"current"),i.push(t),e=fh.kn(n.targetId,t),o.push(e))}))}),await Promise.all(a),s.$o.Rr(i),await async function(t,e){const r=t;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>Xo.forEach(e,e=>Xo.forEach(e.Nn,t=>r.persistence.referenceDelegate.addReference(n,e.targetId,t)).next(()=>Xo.forEach(e.xn,t=>r.persistence.referenceDelegate.removeReference(n,e.targetId,t)))))}catch(t){if(!na(t))throw t;wr("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=r.Un.get(e),n=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(n);r.Un=r.Un.insert(e,s)}}}(s.localStore,o))}async function su(r,t){const s=r;if(au(s),hu(s),!0===t&&!0!==s.Qo){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await iu(s,r.toArray());s.Qo=!0,await Tc(s.remoteStore,!0);for(const r of t)cc(s.remoteStore,r)}else if(!1===t&&!1!==s.Qo){const r=[];let n=Promise.resolve();s.Fo.forEach((t,e)=>{s.sharedClientState.isLocalQueryTarget(e)?r.push(e):n=n.then(()=>(Zc(s,e),Th(s.localStore,e,!0))),uc(s.remoteStore,e)}),await n,await iu(s,r),function(){const n=s;n.Bo.forEach((t,e)=>{uc(n.remoteStore,e)}),n.Uo.us(),n.Bo=new Map,n.Lo=new Oi(is.comparator)}(),s.Qo=!1,await Tc(s.remoteStore,!1)}}async function iu(e,n){const r=e,s=[],i=[];for(const e of n){let t;const u=r.Fo.get(e);if(u&&0!==u.length){t=await Eh(r.localStore,Ws(u[0]));for(const e of u){const n=r.Oo.get(e),u=(o=r,a=n,c=h=void 0,c=await Ih((h=o).localStore,a.query,!0),c=a.view.No(c),h.isPrimaryClient&&eu(h,a.targetId,c.Do),await c);u.snapshot&&i.push(u.snapshot)}}else{const u=await _h(r.localStore,e);t=await Eh(r.localStore,u),await Hc(r,ou(u),e,!1)}s.push(t)}var o,a,h,c;return r.$o.Rr(i),s}function ou(t){return Bs(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function au(t){const e=t;return e.remoteStore.remoteSyncer.applyRemoteEvent=Qc.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=(function(t,e){const n=t,r=n.Bo.get(e);if(r&&r.ko)return Ki().add(r.key);{let t=Ki();const r=n.Fo.get(e);if(!r)return t;for(const e of r){const r=n.Oo.get(e);t=t.unionWith(r.view.Ro)}return t}}).bind(null,e),e.remoteStore.remoteSyncer.rejectListen=(async function(t,e,n){const r=t;r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Bo.get(e),i=s&&s.key;if(i){let t=new Oi(is.comparator);t=t.insert(i,bs.newNoDocument(i,qr.min()));const n=Ki().add(i),s=new Gi(qr.min(),new Map,new Pi(Fr),t,n);await Qc(r,s),r.Lo=r.Lo.remove(i),r.Bo.delete(e),nu(r)}else await Th(r.localStore,e,!1).then(()=>Zc(r,e,n)).catch($a)}).bind(null,e),e.$o.Rr=(function(t,e){const n=t;let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.ro(t)&&(r=!0);s.no=t}}r&&Oc(n)}).bind(null,e.eventManager),e.$o.Go=(function(t,e,n){const r=t,s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}).bind(null,e.eventManager),e}function hu(t){const e=t;return e.remoteStore.remoteSyncer.applySuccessfulWrite=Yc.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=(async function(t,e,n){const r=t;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return s.In.lookupMutationBatch(e,r).next(t=>(_r(null!==t),n=t.keys(),s.In.removeMutationBatch(e,t))).next(()=>s.In.performConsistencyCheck(e)).next(()=>s.Qn.Pn(e,n))})}(r.localStore,e);Jc(r,e,n),Xc(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await ru(r,t)}catch(n){await $a(n)}}).bind(null,e),e}class cu{constructor(){this.synchronizeTabs=!1}async initialize(t){this.N=Zh(t.databaseInfo.databaseId),this.sharedClientState=this.Ho(t),this.persistence=this.Jo(t),await this.persistence.start(),this.gcScheduler=this.Yo(t),this.localStore=this.Xo(t)}Yo(t){return null}Xo(t){return ph(this.persistence,new gh,t.initialUser,this.N)}Jo(t){return new Lh(Mh.Ns,this.N)}Ho(t){return new Gh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class uu extends cu{constructor(t,e,n){super(),this.Zo=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=t;return e.persistence.runTransaction("Synchronize last document change read time","readonly",e=>function(){const t=nh(e);let r=qr.min();return t.Kt({index:Uo.readTimeIndex,reverse:!0},(t,e,n)=>{e.readTime&&(r=pa(e.readTime)),n.done()}).next(()=>r)}()).then(t=>{e.Kn=t})}(this.localStore),await this.Zo.initialize(this,t),await hu(this.Zo.syncEngine),await wc(this.Zo.remoteStore),await this.persistence.nn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Xo(t){return ph(this.persistence,new gh,t.initialUser,this.N)}Yo(t){var e=this.persistence.referenceDelegate.garbageCollector;return new za(e,t.asyncQueue)}Jo(t){var e=uh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ka.withCacheSize(this.cacheSizeBytes):ka.DEFAULT;return new ah(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Xh(),Jh(),this.N,this.sharedClientState,!!this.forceOwnership)}Ho(t){return new Gh}}class lu extends uu{constructor(t,e){super(t,e,!1),this.Zo=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);var e=this.Zo.syncEngine;this.sharedClientState instanceof $h&&(this.sharedClientState.syncEngine={_i:(async function(t,e,n,r){var s=t,i=await function(t,n){const r=t,s=r.In;return r.persistence.runTransaction("Lookup mutation documents","readonly",e=>s.Xt(e,n).next(t=>t?r.Qn.Pn(e,t):Xo.resolve(null)))}(s.localStore,e);null!==i?("pending"===n?await wc(s.remoteStore):"acknowledged"===n||"rejected"===n?(Jc(s,e,r||null),Xc(s,e),s.localStore.In.te(e)):Ir(),await ru(s,i)):wr("SyncEngine","Cannot apply mutation batch with id: "+e)}).bind(null,e),mi:(async function(t,e,n,r){const s=t;if(s.Qo)wr("SyncEngine","Ignoring unexpected query state notification.");else if(s.Fo.has(e))switch(n){case"current":case"not-current":{const t=await Sh(s.localStore),r=Gi.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await ru(s,t,r);break}case"rejected":await Th(s.localStore,e,!0),Zc(s,e,r);break;default:Ir()}}).bind(null,e),gi:(async function(t,e,n){const r=au(t);if(r.Qo){for(const t of e)if(r.Fo.has(t))wr("SyncEngine","Adding an already active target "+t);else{const e=await _h(r.localStore,t),n=await Eh(r.localStore,e);await Hc(r,ou(e),n.targetId,!1),cc(r.remoteStore,n)}for(const t of n)r.Fo.has(t)&&await Th(r.localStore,t,!1).then(()=>{uc(r.remoteStore,t),Zc(r,t)}).catch($a)}}).bind(null,e),pn:(function(t){return t.localStore.persistence.pn()}).bind(null,e),wi:(async function(t){const e=t;return Sh(e.localStore).then(t=>ru(e,t))}).bind(null,e)},await this.sharedClientState.start()),await this.persistence.nn(async t=>{await su(this.Zo.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())})}Ho(t){var e=Xh();if(!$h.bt(e))throw new Nr(Sr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=uh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new $h(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class du{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Wc(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=(async function(t,e){const n=t;if(!n.currentUser.isEqual(e)){wr("SyncEngine","User change. New user:",e.toKey());const r=await yh(n.localStore,e);n.currentUser=e,(t=n).Ko.forEach(t=>{t.forEach(t=>{t.reject(new Nr(Sr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),t.Ko.clear(),n.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),await ru(n,r.Wn)}}).bind(null,this.syncEngine),await Tc(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new kc}createDatastore(t){var e,n,r,s=Zh(t.databaseInfo.databaseId),e=(e=t.databaseInfo,new Yh(e));return n=t.credentials,r=e,t=s,new sc(n,r,t)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Wc(this.syncEngine,t,0),i=new(zh.bt()?zh:Hh),new oc(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Gc(t,e,n,r,s,i);return o&&(a.Qo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=t;wr("RemoteStore","RemoteStore shutting down."),e.Wr.add(5),await hc(e),e.zr.shutdown(),e.Hr.set("Unknown")}(this.remoteStore)}}function fu(e,n=10240){let r=0;return{async read(){if(r<e.byteLength){var t={value:e.slice(r,r+n),done:!1};return r+=n,t}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class gu{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.tc(this.observer.next,t)}error(t){this.observer.error?this.tc(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}ec(){this.muted=!0}tc(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}class mu{constructor(t,e){this.nc=t,this.N=e,this.metadata=new Ar,this.buffer=new Uint8Array,this.sc=new TextDecoder("utf-8"),this.ic().then(t=>{t&&t.wo()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))},t=>this.metadata.reject(t))}close(){return this.nc.cancel()}async getMetadata(){return this.metadata.promise}async zo(){return await this.getMetadata(),this.ic()}async ic(){var t=await this.rc();if(null===t)return null;var e=this.sc.decode(t),n=Number(e);isNaN(n)&&this.oc(`length string (${e}) is not valid number`);e=await this.cc(n);return new Fc(JSON.parse(e),t.length+n)}ac(){return this.buffer.findIndex(t=>t==="{".charCodeAt(0))}async rc(){for(;this.ac()<0&&!await this.uc(););if(0===this.buffer.length)return null;var t=this.ac();t<0&&this.oc("Reached the end of bundle when a length string is expected.");var e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async cc(t){for(;this.buffer.length<t;)await this.uc()&&this.oc("Reached the end of bundle when more is expected.");var e=this.sc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}oc(t){throw this.nc.cancel(),new Error(`Invalid bundle format: ${t}`)}async uc(){var t=await this.nc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class pu{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Nr(Sr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const r=t,n=fo(r.N)+"/documents",s={documents:e.map(t=>ho(r.N,t))},i=await r.Ki("BatchGetDocuments",n,s),o=new Map;i.forEach(t=>{const e=(n=r.N,"found"in(t=t)?function(t,e){_r(!!e.found),e.found.name,e.found.updateTime;var n=co(t,e.found.name),r=io(e.found.updateTime),s=new ws({mapValue:{fields:e.found.fields}});return bs.newFoundDocument(n,r,s)}(n,t):"missing"in t?function(t,e){_r(!!e.missing),_r(!!e.readTime);var n=co(t,e.missing),r=io(e.readTime);return bs.newNoDocument(n,r)}(n,t):Ir());var n;o.set(e.key.toString(),e)});const a=[];return e.forEach(t=>{var e=o.get(t.toString());_r(!!e),a.push(e)}),a}(this.datastore,t);return e.forEach(t=>this.recordVersion(t)),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Ci(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,e)=>{var n=is.fromPath(e);this.mutations.push(new xi(n,this.precondition(n)))}),await async function(t,e){const n=t,r=fo(n.N)+"/documents",s={writes:e.map(t=>yo(n.N,t))};await n.Li("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ir();e=qr.min()}var n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Nr(Sr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){var e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?yi.updateTime(e):yi.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(this.writtenDocs.has(t.toString())||!e)return yi.exists(!0);if(e.isEqual(qr.min()))throw new Nr(Sr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return yi.updateTime(e)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class yu{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.hc=5,this.ar=new tc(this.asyncQueue,"transaction_retry")}run(){--this.hc,this.lc()}lc(){this.ar.Xi(async()=>{const e=new pu(this.datastore),t=this.fc(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(t=>{this.dc(t)}))}).catch(t=>{this.dc(t)})})}fc(t){try{var e=this.updateFunction(t);return!ns(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}dc(t){0<this.hc&&this.wc(t)?(--this.hc,this.asyncQueue.enqueueAndForget(()=>(this.lc(),Promise.resolve()))):this.deferred.reject(t)}wc(t){if("FirebaseError"!==t.name)return!1;var e=t.code;return"aborted"===e||"failed-precondition"===e||!Ri(e)}}class vu{constructor(t,e,n){this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=mr.UNAUTHENTICATED,this.clientId=Mr.I(),this.credentialListener=()=>Promise.resolve(),this.credentials.start(e,async t=>{wr("FirestoreClient","Received user=",t.uid),await this.credentialListener(t),this.user=t})}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.credentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Nr(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Ar;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),n.resolve()}catch(t){var e=Nc(t,"Failed to shutdown persistence");n.reject(e)}}),n.promise}}async function wu(t,e){t.asyncQueue.verifyOperationInProgress(),wr("FirestoreClient","Initializing OfflineComponentProvider");var n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener(async t=>{r.isEqual(t)||(await yh(e.localStore,t),r=t)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t.offlineComponents=e}async function bu(t,e){t.asyncQueue.verifyOperationInProgress();var n=await Eu(t);wr("FirestoreClient","Initializing OnlineComponentProvider");var r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener(t=>async function(t,e){const n=t;n.asyncQueue.verifyOperationInProgress(),wr("RemoteStore","RemoteStore received new credentials");var r=mc(n);n.Wr.add(3),await hc(n),r&&n.Hr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Wr.delete(3),await ac(n)}(e.remoteStore,t)),t.onlineComponents=e}async function Eu(t){return t.offlineComponents||(wr("FirestoreClient","Using default OfflineComponentProvider"),await wu(t,new cu)),t.offlineComponents}async function Tu(t){return t.onlineComponents||(wr("FirestoreClient","Using default OnlineComponentProvider"),await bu(t,new du)),t.onlineComponents}function Iu(t){return Eu(t).then(t=>t.persistence)}function _u(t){return Eu(t).then(t=>t.localStore)}function Su(t){return Tu(t).then(t=>t.remoteStore)}function Nu(t){return Tu(t).then(t=>t.syncEngine)}async function Au(t){const e=await Tu(t),n=e.eventManager;return n.onListen=(async function(t,e){const n=au(t);let r,s;const i=n.Oo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const t=await Eh(n.localStore,Ws(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Hc(n,e,r,"current"===i),n.isPrimaryClient&&cc(n.remoteStore,t)}return s}).bind(null,e.syncEngine),n.onUnlisten=(async function(t,e){const n=t,r=n.Oo.get(e),s=n.Fo.get(r.targetId);if(1<s.length)return n.Fo.set(r.targetId,s.filter(t=>!Xs(t,e))),void n.Oo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Th(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),uc(n.remoteStore,r.targetId),Zc(n,r.targetId)}).catch($a)):(Zc(n,r.targetId),await Th(n.localStore,r.targetId,!0))}).bind(null,e.syncEngine),n}function Du(t,e,n={}){const r=new Ar;return t.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,o){const t=new gu({next:t=>{r.enqueueAndForget(()=>Lc(n,a));var e=t.docs.has(s);!e&&t.fromCache?o.reject(new Nr(Sr.UNAVAILABLE,"Failed to get document because the client is offline.")):e&&t.fromCache&&i&&"server"===i.source?o.reject(new Nr(Sr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(t)},error:t=>o.reject(t)}),a=new Mc(js(s.path),t,{includeMetadataChanges:!0,fo:!0});return Rc(n,a)}(await Au(t),t.asyncQueue,e,n,r)),r.promise}function Cu(t,e,n={}){const r=new Ar;return t.asyncQueue.enqueueAndForget(async()=>function(e,n,t,r,s){const i=new gu({next:t=>{n.enqueueAndForget(()=>Lc(e,o)),t.fromCache&&"server"===r.source?s.reject(new Nr(Sr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(t)},error:t=>s.reject(t)}),o=new Mc(t,i,{includeMetadataChanges:!0,fo:!0});return Rc(e,o)}(await Au(t),t.asyncQueue,e,n,r)),r.promise}function xu(t,e,n,r){const s=(n=n,e=Zh(e),i="string"==typeof n?(new TextEncoder).encode(n):n,n=function(t){if(t instanceof Uint8Array)return fu(t,void 0);if(t instanceof ArrayBuffer)return fu(new Uint8Array(t),void 0);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(i),e=e,new mu(n,e));var i;t.asyncQueue.enqueueAndForget(async()=>{!function(t,e,n){const r=t;!async function(e,n,r){try{var s=await n.getMetadata();if(await function(t,e){const n=t,r=io(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",t=>n.Je.getBundleMetadata(t,e.id)).then(t=>!!t&&0<=t.createTime.compareTo(r))}(e.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(Uc(s));const o=new Vc(s,e.localStore,n.N);let t=await n.zo();for(;t;){const e=await o.mo(t);e&&r._updateProgress(e),t=await n.zo()}var i=await o.complete();await ru(e,i.En,void 0),await function(t,e){const n=t;return n.persistence.runTransaction("Save bundle","readwrite",t=>n.Je.saveBundleMetadata(t,e))}(e.localStore,s),r._completeWith(i.progress)}catch(e){Er("SyncEngine",`Loading bundle failed with ${e}`),r._failWith(e)}}(r,e,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}(await Nu(t),s,r)})}class ku{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Ru{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Ru&&t.projectId===this.projectId&&t.database===this.database}}const Lu=new Map;function Ou(t,e,n){if(!n)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Mu(t,e,n,r){if(!0===e&&!0===r)throw new Nr(Sr.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Fu(t){if(!is.isDocumentKey(t))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Pu(t){if(is.isDocumentKey(t))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Vu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":Ir();if(t instanceof Array)return"an array";var e=(t=t).constructor?t.constructor.name:null;return e?`a custom ${e} object`:"an object"}function Uu(t,e){if((t="_delegate"in t?t._delegate:t)instanceof e)return t;if(e.name===t.constructor.name)throw new Nr(Sr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Vu(t);throw new Nr(Sr.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}function qu(t,e){if(e<=0)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Bu{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Nr(Sr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Nr(Sr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Mu("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class ju{constructor(t,e){this._credentials=e,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bu({}),this._settingsFrozen=!1,t instanceof Ru?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Nr(Sr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ru(t.options.projectId)}(t))}get app(){if(!this._app)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bu(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new Cr;switch(t.type){case"gapi":var e=t.client;return _r(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Lr(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Nr(Sr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Lu.get(t);e&&(wr("ComponentProvider","Removing Datastore"),Lu.delete(t),e.terminate())}(this),Promise.resolve()}}function Ku(n,t,e,r={}){var s;const i=(n=Uu(n,ju))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&Er("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${e}`,ssl:!1})),r.mockUserToken){let t,e;if("string"==typeof r.mockUserToken)t=r.mockUserToken,e=mr.MOCK_USER;else{t=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=e||"demo-project",r=t.iat||0,s=t.sub||t.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return s=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},t),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(s)),""].join(".")}(r.mockUserToken,null===(s=n._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Nr(Sr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");e=new mr(i)}n._credentials=new xr(new Dr(t,e))}}class $u{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Hu(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new $u(this.firestore,t,this._key)}}class Gu{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Gu(this.firestore,t,this._query)}}class Hu extends Gu{constructor(t,e,n){super(t,e,js(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new $u(this.firestore,null,new is(t))}withConverter(t){return new Hu(this.firestore,t,this._path)}}function zu(t,e,...n){if(t=m(t),Ou("collection","path",e),t instanceof ju){var r=Gr.fromString(e,...n);return Pu(r),new Hu(t,null,r)}if(!(t instanceof $u||t instanceof Hu))throw new Nr(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=t._path.child(Gr.fromString(e,...n));return Pu(r),new Hu(t.firestore,null,r)}function Qu(t,e,...n){if(t=m(t),Ou("doc","path",e=1===arguments.length?Mr.I():e),t instanceof ju){var r=Gr.fromString(e,...n);return Fu(r),new $u(t,null,new is(r))}if(!(t instanceof $u||t instanceof Hu))throw new Nr(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=t._path.child(Gr.fromString(e,...n));return Fu(r),new $u(t.firestore,t instanceof Hu?t.converter:null,new is(r))}function Wu(t,e){return t=m(t),e=m(e),(t instanceof $u||t instanceof Hu)&&(e instanceof $u||e instanceof Hu)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Yu(t,e){return t=m(t),e=m(e),t instanceof Gu&&e instanceof Gu&&t.firestore===e.firestore&&Xs(t._query,e._query)&&t.converter===e.converter}class Xu{constructor(){this._c=Promise.resolve(),this.mc=[],this.gc=!1,this.yc=[],this.Tc=null,this.Ec=!1,this.Ic=!1,this.Ac=[],this.ar=new tc(this,"async_queue_retry"),this.Rc=()=>{var t=Jh();t&&wr("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ar.tr()};const t=Jh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Rc)}get isShuttingDown(){return this.gc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.bc(),this.Pc(t)}enterRestrictedMode(t){if(!this.gc){this.gc=!0,this.Ic=t||!1;const e=Jh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Rc)}}enqueue(t){if(this.bc(),this.gc)return new Promise(()=>{});const e=new Ar;return this.Pc(()=>this.gc&&this.Ic?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.mc.push(t),this.vc()))}async vc(){if(0!==this.mc.length){try{await this.mc[0](),this.mc.shift(),this.ar.reset()}catch(t){if(!na(t))throw t;wr("AsyncQueue","Operation failed with retryable error: "+t)}0<this.mc.length&&this.ar.Xi(()=>this.vc())}}Pc(t){var e=this._c.then(()=>(this.Ec=!0,t().catch(t=>{throw this.Tc=t,this.Ec=!1,br("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t}).then(t=>(this.Ec=!1,t))));return this._c=e}enqueueAfterDelay(t,e,n){this.bc(),-1<this.Ac.indexOf(t)&&(e=0);var r=Sc.createAndSchedule(this,t,e,n,t=>this.Vc(t));return this.yc.push(r),r}bc(){this.Tc&&Ir()}verifyOperationInProgress(){}async Sc(){for(var t;await(t=this._c),t!==this._c;);}Dc(t){for(const e of this.yc)if(e.timerId===t)return!0;return!1}Cc(e){return this.Sc().then(()=>{this.yc.sort((t,e)=>t.targetTimeMs-e.targetTimeMs);for(const t of this.yc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Sc()})}Nc(t){this.Ac.push(t)}Vc(t){var e=this.yc.indexOf(t);this.yc.splice(e,1)}}function Ju(t){return function(t){if("object"==typeof t&&null!==t){var e=t;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return 1}}(t)}class Zu{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ar,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}var tl,el,nl;class rl extends ju{constructor(t,e){super(t,e),this.type="firestore",this._queue=new Xu,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||il(this),this._firestoreClient.terminate()}}function sl(t){return t._firestoreClient||il(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function il(t){var e,n,r,s,i,o=t._freezeSettings(),o=(n=t._databaseId,r=(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",s=t._persistenceKey,i=o,new ku(n,r,s,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams));t._firestoreClient=new vu(t._credentials,t._queue,o)}function ol(t,n,r){const s=new Ar;return t.asyncQueue.enqueue(async()=>{try{await wu(t,r),await bu(t,n),s.resolve()}catch(t){if(!("FirebaseError"===(e=t).name?e.code===Sr.FAILED_PRECONDITION||e.code===Sr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}var e}).then(()=>s.promise)}function al(t){return function(t){const e=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e){const n=t;mc(n.remoteStore)||wr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(){const e=n.localStore;return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.In.getHighestUnacknowledgedBatchId(t))}();if(-1===t)return void e.resolve();const r=n.Ko.get(t)||[];r.push(e),n.Ko.set(t,r)}catch(t){const n=Nc(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Nu(t),e)),e.promise}(sl(t=Uu(t,rl)))}function hl(t){return(n=sl(t=Uu(t,rl))).asyncQueue.enqueue(async()=>{const t=await Iu(n),e=await Su(n);return t.setNetworkEnabled(!0),function(){const t=e;return t.Wr.delete(0),ac(t)}()});var n}function cl(t){return(n=sl(t=Uu(t,rl))).asyncQueue.enqueue(async()=>{const t=await Iu(n),e=await Su(n);return t.setNetworkEnabled(!1),async function(){const t=e;t.Wr.add(0),await hc(t),t.Hr.set("Offline")}()});var n}function ul(e,t){return n=sl(e=Uu(e,rl)),r=t,n.asyncQueue.enqueue(async()=>function(t,e){const n=t;return n.persistence.runTransaction("Get named query","readonly",t=>n.Je.getNamedQuery(t,e))}(await _u(n),r)).then(t=>t?new Gu(e,null,t.query):null);var n,r}function ll(t){if(t._initialized||t._terminated)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class dl{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new zr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class fl{constructor(t){this._byteString=t}static fromBase64String(t){try{return new fl(Wr.fromBase64String(t))}catch(t){throw new Nr(Sr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new fl(Wr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class gl{constructor(t){this._methodName=t}}class ml{constructor(t,e){if(!isFinite(t)||t<-90||90<t)throw new Nr(Sr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Nr(Sr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Fr(this._lat,t._lat)||Fr(this._long,t._long)}}const pl=/^__.*__$/;class yl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Si(t,this.data,this.fieldMask,e,this.fieldTransforms):new _i(t,this.data,e,this.fieldTransforms)}}class vl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Si(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function wl(t){switch(t){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Ir()}}class bl{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.N=n,this.ignoreUndefinedProperties=r,void 0===s&&this.xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get kc(){return this.settings.kc}$c(t){return new bl(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Oc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.Mc(t),r}Lc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$c({path:n,Fc:!1});return r.xc(),r}Bc(t){return this.$c({path:void 0,Fc:!0})}Uc(t){return ql(t,this.settings.methodName,this.settings.qc||!1,this.path,this.settings.Kc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.Mc(this.path.get(t))}Mc(t){if(0===t.length)throw this.Uc("Document fields must not be empty");if(wl(this.kc)&&pl.test(t))throw this.Uc('Document fields cannot begin and end with "__"')}}class El{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.N=n||Zh(t)}jc(t,e,n,r=!1){return new bl({kc:t,methodName:e,Kc:n,path:zr.emptyPath(),Fc:!1,qc:r},this.databaseId,this.N,this.ignoreUndefinedProperties)}}function Tl(t){var e=t._freezeSettings(),n=Zh(t._databaseId);return new El(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Il(t,e,n,r,s,i={}){const o=t.jc(i.merge||i.mergeFields?2:0,e,n,s);Fl("Data must be an object, but it was:",o,r);var a=Ol(r,o);let h,c;if(i.merge)h=new Qr(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Pl(e,r,n);if(!o.contains(s))throw new Nr(Sr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Bl(t,s)||t.push(s)}h=new Qr(t),c=o.fieldTransforms.filter(t=>h.covers(t.field))}else h=null,c=o.fieldTransforms;return new yl(new ws(a),h,c)}class _l extends gl{_toFieldTransform(t){if(2!==t.kc)throw 1===t.kc?t.Uc(`${this._methodName}() can only appear at the top level of your update data`):t.Uc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof _l}}function Sl(t,e,n){return new bl({kc:3,Kc:e.settings.Kc,methodName:t._methodName,Fc:n},e.databaseId,e.N,e.ignoreUndefinedProperties)}class Nl extends gl{_toFieldTransform(t){return new mi(t.path,new ai)}isEqual(t){return t instanceof Nl}}class Al extends gl{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=Sl(this,t,!0),n=this.Qc.map(t=>Ll(t,e)),r=new hi(n);return new mi(t.path,r)}isEqual(t){return this===t}}class Dl extends gl{constructor(t,e){super(t),this.Qc=e}_toFieldTransform(t){const e=Sl(this,t,!0),n=this.Qc.map(t=>Ll(t,e)),r=new ui(n);return new mi(t.path,r)}isEqual(t){return this===t}}class Cl extends gl{constructor(t,e){super(t),this.Wc=e}_toFieldTransform(t){var e=new di(t.N,si(t.N,this.Wc));return new mi(t.path,e)}isEqual(t){return this===t}}function xl(t,s,i,e){const o=t.jc(1,s,i);Fl("Data must be an object, but it was:",o,e);const a=[],h=ws.empty();jr(e,(t,e)=>{var n=Ul(s,t,i);e=m(e);var r=o.Lc(n);if(e instanceof _l)a.push(n);else{const t=Ll(e,r);null!=t&&(a.push(n),h.set(n,t))}});var n=new Qr(a);return new vl(h,n,o.fieldTransforms)}function kl(t,e,n,r,s,i){const o=t.jc(1,e,n),a=[Pl(e,r,n)],h=[s];if(i.length%2!=0)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let f=0;f<i.length;f+=2)a.push(Pl(e,i[f])),h.push(i[f+1]);const c=[],u=ws.empty();for(let g=a.length-1;0<=g;--g)if(!Bl(c,a[g])){const e=a[g];var l=m(l=h[g]);const r=o.Lc(e);if(l instanceof _l)c.push(e);else{const t=Ll(l,r);null!=t&&(c.push(e),u.set(e,t))}}var d=new Qr(c);return new vl(u,d,o.fieldTransforms)}function Rl(t,e,n,r=!1){return Ll(n,t.jc(r?4:3,e))}function Ll(i,t){if(Ml(i=m(i)))return Fl("Unsupported field value:",t,i),Ol(i,t);if(i instanceof gl)return function(t,e){if(!wl(e.kc))throw e.Uc(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Uc(`${t._methodName}() is not currently supported inside arrays`);var n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(i,t),null;if(void 0===i&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),i instanceof Array){if(t.settings.Fc&&4!==t.kc)throw t.Uc("Nested arrays are not supported");return function(e){const n=[];let r=0;for(const s of i){let t=Ll(s,e.Bc(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t)}return function(t,e){if(null===(t=m(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return si(e.N,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var n=Ur.fromDate(t);return{timestampValue:ro(e.N,n)}}if(t instanceof Ur){n=new Ur(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:ro(e.N,n)}}if(t instanceof ml)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof fl)return{bytesValue:so(e.N,t._byteString)};if(t instanceof $u){const r=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(r))throw e.Uc(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:oo(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Uc(`Unsupported field value: ${Vu(t)}`)}(0,t)}function Ol(t,r){const s={};return Kr(t)?r.path&&0<r.path.length&&r.fieldMask.push(r.path):jr(t,(t,e)=>{var n=Ll(e,r.Oc(t));null!=n&&(s[t]=n)}),{mapValue:{fields:s}}}function Ml(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ur||t instanceof ml||t instanceof fl||t instanceof $u||t instanceof gl)}function Fl(t,e,n){if(!Ml(n)||("object"!=typeof(s=n)||null===s||Object.getPrototypeOf(s)!==Object.prototype&&null!==Object.getPrototypeOf(s))){var r=Vu(n);throw"an object"===r?e.Uc(t+" a custom object"):e.Uc(t+" "+r)}var s}function Pl(t,e,n){if((e=m(e))instanceof dl)return e._internalPath;if("string"==typeof e)return Ul(t,e);throw ql("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Vl=new RegExp("[~\\*/\\[\\]]");function Ul(e,n,r){if(0<=n.search(Vl))throw ql(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new dl(...n.split("."))._internalPath}catch(t){throw ql(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function ql(t,e,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let h="";return(i||o)&&(h+=" (found",i&&(h+=` in field ${r}`),o&&(h+=` in document ${s}`),h+=")"),new Nr(Sr.INVALID_ARGUMENT,a+t+h)}function Bl(t,e){return t.some(t=>t.isEqual(e))}class jl{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new $u(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var t=new Kl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){var e=this._document.data.field($l("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Kl extends jl{data(){return super.data()}}function $l(t,e){return"string"==typeof e?Ul(t,e):(e instanceof dl?e:e._delegate)._internalPath}class Gl{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Hl extends jl{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){var e=new zl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){var n=this._document.data.field($l("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class zl extends Hl{data(t={}){return super.data(t)}}class Ql{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Gl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,n){this._snapshot.docs.forEach(t=>{e.call(n,new zl(this._firestore,this._userDataWriter,t.key,t,new Gl(this._snapshot.mutatedKeys.has(t.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){var e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Nr(Sr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,e){if(i._snapshot.oldDocs.isEmpty()){let e=0;return i._snapshot.docChanges.map(t=>({type:"added",doc:new zl(i._firestore,i._userDataWriter,t.doc.key,t.doc,new Gl(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:e++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(t=>e||3!==t.type).map(t=>{var e=new zl(i._firestore,i._userDataWriter,t.doc.key,t.doc,new Gl(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==t.type&&(n=s.indexOf(t.doc.key),s=s.delete(t.doc.key)),1!==t.type&&(s=s.add(t.doc),r=s.indexOf(t.doc.key)),{type:function(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ir()}}(t.type),doc:e,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Wl(t,e){return t instanceof Hl&&e instanceof Hl?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Ql&&e instanceof Ql&&t._firestore===e._firestore&&Yu(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Yl(t){if($s(t)&&0===t.explicitOrderBy.length)throw new Nr(Sr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Xl{}function Jl(t,...e){for(const n of e)t=n._apply(t);return t}class Zl extends Xl{constructor(t,e,n){super(),this.Gc=t,this.zc=e,this.Hc=n,this.type="where"}_apply(t){var e=Tl(t.firestore),e=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){od(o,i);const e=[];for(const n of o)e.push(id(r,t,n));a={arrayValue:{values:e}}}else a=id(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||od(o,i),a=Rl(n,e,o,"in"===i||"not-in"===i);var h=Ns.create(s,i,a);return function(t,e){if(e.v()){const r=Hs(t);if(null!==r&&!r.isEqual(e.field))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${e.field.toString()}'`);var n=Gs(t);null!==n&&ad(0,e.field,n)}const r=function(t,e){for(const n of t.filters)if(0<=e.indexOf(n.op))return n.op;return null}(t,function(){switch(e.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===e.op?new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${r.toString()}' filters.`)}(t,h),h}(t._query,"where",e,t.firestore._databaseId,this.Gc,this.zc,this.Hc);return new Gu(t.firestore,t.converter,(t=t._query,e=t.filters.concat([e]),new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),e,t.limit,t.limitType,t.startAt,t.endAt)))}}class td extends Xl{constructor(t,e){super(),this.Gc=t,this.Jc=e,this.type="orderBy"}_apply(t){var e=function(t,e,n){if(null!==t.startAt)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,s=new Ps(e,n);return n=s,null!==Gs(t=t)||null!==(r=Hs(t))&&ad(0,r,n.field),s}(t._query,this.Gc,this.Jc);return new Gu(t.firestore,t.converter,(t=t._query,e=t.explicitOrderBy.concat([e]),new qs(t.path,t.collectionGroup,e,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)))}}class ed extends Xl{constructor(t,e,n){super(),this.type=t,this.Yc=e,this.Xc=n}_apply(t){return new Gu(t.firestore,t.converter,Ys(t._query,this.Yc,this.Xc))}}class nd extends Xl{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){var e,n=sd(t,this.type,this.Zc,this.ta);return new Gu(t.firestore,t.converter,(e=t._query,t=n,new qs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)))}}class rd extends Xl{constructor(t,e,n){super(),this.type=t,this.Zc=e,this.ta=n}_apply(t){var e,n=sd(t,this.type,this.Zc,this.ta);return new Gu(t.firestore,t.converter,(e=t._query,t=n,new qs(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)))}}function sd(t,e,n,r){if(n[0]=m(n[0]),n[0]instanceof jl)return function(t,e,n,r,s){if(!r)throw new Nr(Sr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Qs(t))if(n.field.isKeyField())i.push(ds(e,r.key));else{const t=r.data.field(n.field);if(ts(t))throw new Nr(Sr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Ms(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);var s=Tl(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new Nr(Sr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let h=0;h<s.length;h++){const c=s[h];if(o[h].field.isKeyField()){if("string"!=typeof c)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!zs(t)&&-1!==c.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(Gr.fromString(c));if(!is.isDocumentKey(n))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new is(n);a.push(ds(e,s))}else{const t=Rl(n,r,c);a.push(t)}}return new Ms(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}function id(t,e,n){if("string"==typeof(n=m(n))){if(""===n)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!zs(e)&&-1!==n.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=e.path.child(Gr.fromString(n));if(!is.isDocumentKey(r))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return ds(t,new is(r))}if(n instanceof $u)return ds(t,n._key);throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${Vu(n)}.`)}function od(t,e){if(!Array.isArray(t)||0===t.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(10<t.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function ad(t,e,n){if(!n.isEqual(e))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class hd{convertValue(t,e="none"){switch(os(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Jr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Zr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ir()}}convertObject(t,n){const r={};return jr(t.fields,(t,e)=>{r[t]=this.convertValue(e,n)}),r}convertGeoPoint(t){return new ml(Jr(t.latitude),Jr(t.longitude))}convertArray(t,e){return(t.values||[]).map(t=>this.convertValue(t,e))}convertServerTimestamp(t,e){switch(e){case"previous":var n=function t(e){var n=e.mapValue.fields.__previous_value__;return ts(n)?t(n):n}(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(es(t));default:return null}}convertTimestamp(t){var e=Xr(t);return new Ur(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Gr.fromString(t);_r(Do(n));const r=new Ru(n.get(1),n.get(3)),s=new is(n.popFirst(5));return r.isEqual(e)||br(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function cd(t,e,n){return t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}class ud extends hd{constructor(t){super(),this.firestore=t}convertBytes(t){return new fl(t)}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new $u(this.firestore,null,e)}}class ld{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Tl(t)}set(t,e,n){this._verifyNotCommitted();const r=dd(t,this._firestore),s=cd(r.converter,e,n),i=Il(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,yi.none())),this}update(t,e,n,...r){this._verifyNotCommitted();var s=dd(t,this._firestore);let i;return i="string"==typeof(e=m(e))||e instanceof dl?kl(this._dataReader,"WriteBatch.update",s._key,e,n,r):xl(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,yi.exists(!0))),this}delete(t){this._verifyNotCommitted();var e=dd(t,this._firestore);return this._mutations=this._mutations.concat(new Ci(e._key,yi.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Nr(Sr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function dd(t,e){if((t=m(t)).firestore!==e)throw new Nr(Sr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class fd extends hd{constructor(t){super(),this.firestore=t}convertBytes(t){return new fl(t)}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return new $u(this.firestore,null,e)}}function gd(e){e=Uu(e,$u);const n=Uu(e.firestore,rl),t=sl(n),r=new fd(n);return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const s=await function(e){const n=t;return n.persistence.runTransaction("read document","readonly",t=>n.Qn.An(t,e))}(e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Nr(Sr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){var r=Nc(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await _u(t),e,n)),n.promise}(t,e._key).then(t=>new Hl(n,r,e._key,t,new Gl(null!==t&&t.hasLocalMutations,!0),e.converter))}function md(e){e=Uu(e,Gu);const n=Uu(e.firestore,rl),t=sl(n),r=new fd(n);return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const s=await Ih(t,e,!0),i=new jc(e,s.Gn),o=i.bo(s.documents),a=i.applyChanges(o,!1);n.resolve(a.snapshot)}catch(t){var r=Nc(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await _u(t),e,n)),n.promise}(t,e._query).then(t=>new Ql(n,r,e,t))}function pd(t,e,n){t=Uu(t,$u);var r=Uu(t.firestore,rl),s=cd(t.converter,e,n);return bd(r,[Il(Tl(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,yi.none())])}function yd(t,e,n,...r){t=Uu(t,$u);var s=Uu(t.firestore,rl),i=Tl(s);let o;return o="string"==typeof(e=m(e))||e instanceof dl?kl(i,"updateDoc",t._key,e,n,r):xl(i,"updateDoc",t._key,e),bd(s,[o.toMutation(t._key,yi.exists(!0))])}function vd(e,...n){var t;e=m(e);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||Ju(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(Ju(n[s])){const e=n[s];n[s]=null===(t=e.next)||void 0===t?void 0:t.bind(e),n[s+1]=null===(t=e.error)||void 0===t?void 0:t.bind(e),n[s+2]=null===(t=e.complete)||void 0===t?void 0:t.bind(e)}let o,a,h;if(e instanceof $u)a=Uu(e.firestore,rl),h=js(e._key.path),o={next:t=>{n[s]&&n[s](Ed(a,e,t))},error:n[s+1],complete:n[s+2]};else{const c=Uu(e,Gu);a=Uu(c.firestore,rl),h=c._query;const u=new fd(a);o={next:t=>{n[s]&&n[s](new Ql(a,u,c,t))},error:n[s+1],complete:n[s+2]},Yl(e._query)}return function(t,e,n,r){const s=new gu(r),i=new Mc(e,s,n);return t.asyncQueue.enqueueAndForget(async()=>Rc(await Au(t),i)),()=>{s.ec(),t.asyncQueue.enqueueAndForget(async()=>Lc(await Au(t),i))}}(sl(a),h,i,o)}function wd(t,e){return function(t,e){const n=new gu(e);return t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.so.add(e),e.next()}(await Au(t),n)),()=>{n.ec(),t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.so.delete(e)}(await Au(t),n))}}(sl(t=Uu(t,rl)),Ju(e)?e:{next:e})}function bd(t,e){return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>zc(await Nu(t),e,n)),n.promise}(sl(t),e)}function Ed(t,e,n){var r=n.docs.get(e._key),s=new fd(t);return new Hl(t,s,e._key,r,new Gl(n.hasPendingWrites,n.fromCache),e.converter)}class Td extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Tl(t)}get(t){const n=dd(t,this._firestore),r=new ud(this._firestore);return this._transaction.lookup([n._key]).then(t=>{if(!t||1!==t.length)return Ir();const e=t[0];if(e.isFoundDocument())return new jl(this._firestore,r,e.key,e,n.converter);if(e.isNoDocument())return new jl(this._firestore,r,n._key,null,n.converter);throw Ir()})}set(t,e,n){var r=dd(t,this._firestore),s=cd(r.converter,e,n),s=Il(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(t,e,n,...r){var s=dd(t,this._firestore),i="string"==typeof(e=m(e))||e instanceof dl?kl(this._dataReader,"Transaction.update",s._key,e,n,r):xl(this._dataReader,"Transaction.update",s._key,e);return this._transaction.update(s._key,i),this}delete(t){var e=dd(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=dd(t,this._firestore),n=new fd(this._firestore);return super.get(t).then(t=>new Hl(this._firestore,n,e._key,t._document,new Gl(!1,!1),e.converter))}}function Id(e,n){return function(e,n){const r=new Ar;return e.asyncQueue.enqueueAndForget(async()=>{var t=await Tu(e).then(t=>t.datastore);new yu(e.asyncQueue,t,n,r).run()}),r.promise}(sl(e=Uu(e,rl)),t=>n(new Td(e,t)))}tl=Yd.SDK_VERSION,pr=tl,Yd._registerComponent(new i("firestore",(t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new rl(n,new kr(t.getProvider("auth-internal")));return e=Object.assign({useFetchStreams:!0},e),r._setSettings(e),r},"PUBLIC")),Yd.registerVersion(gr,"3.3.1",void 0),Yd.registerVersion(gr,"3.3.1","esm2017");function _d(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new Nr("invalid-argument",`Invalid options passed to function ${t}(): You cannot `+'specify both "merge" and "mergeFields".');return e}function Sd(){if("undefined"==typeof Uint8Array)throw new Nr("unimplemented","Uint8Arrays are not available in this environment.")}function Nd(){if("undefined"==typeof atob)throw new Nr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Ad{constructor(t){this._delegate=t}static fromBase64String(t){return Nd(),new Ad(fl.fromBase64String(t))}static fromUint8Array(t){return Sd(),new Ad(fl.fromUint8Array(t))}toBase64(){return Nd(),this._delegate.toBase64()}toUint8Array(){return Sd(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Dd(t){return function(t,e){if("object"!=typeof t||null===t)return;var n=t;for(const r of e)if(r in n&&"function"==typeof n[r])return 1;return}(t,["next","error","complete"])}class Cd{enableIndexedDbPersistence(t,e){return function(t,e){ll(t=Uu(t,rl));var n=sl(t),r=t._freezeSettings(),s=new du;return ol(n,s,new uu(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return function(t){ll(t=Uu(t,rl));var e=sl(t),n=t._freezeSettings(),r=new du;return ol(e,r,new lu(r,n.cacheSizeBytes))}(t._delegate)}clearIndexedDbPersistence(t){return function(t){if(t._initialized&&!t._terminated)throw new Nr(Sr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ar;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(t){if(!Zo.bt())return Promise.resolve();var e=t+"main";await Zo.delete(e)}(uh(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}}),e.promise}(t._delegate)}}class xd{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Ru||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){var e=this._delegate._getSettings();t.merge||e.host===t.host||Er("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)}useEmulator(t,e,n={}){Ku(this._delegate,t,e,n)}enableNetwork(){return hl(this._delegate)}disableNetwork(){return cl(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Mu("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return al(this._delegate)}onSnapshotsInSync(t){return wd(this._delegate,t)}get app(){if(!this._appCompat)throw new Nr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new $d(this,zu(this._delegate,t))}catch(t){throw Fd(t,"collection()","Firestore.collection()")}}doc(t){try{return new Md(this,Qu(this._delegate,t))}catch(t){throw Fd(t,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new Bd(this,function(t,e){if(t=Uu(t,ju),Ou("collectionGroup","collection id",e),0<=e.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Gu(t,null,(e=e,new qs(Gr.emptyPath(),e)))}(this._delegate,t))}catch(t){throw Fd(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return Id(this._delegate,t=>e(new Rd(this,t)))}batch(){return sl(this._delegate),new Ld(new ld(this._delegate,t=>bd(this._delegate,t)))}loadBundle(t){return e=this._delegate,t=t,n=sl(e=Uu(e,rl)),r=new Zu,xu(n,e._databaseId,t,r),r;var e,n,r}namedQuery(t){return ul(this._delegate,t).then(t=>t?new Bd(this,t):null)}}class kd extends hd{constructor(t){super(),this.firestore=t}convertBytes(t){return new Ad(new fl(t))}convertReference(t){var e=this.convertDocumentKey(t,this.firestore._databaseId);return Md.forKey(e,this.firestore,null)}}class Rd{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new kd(t)}get(t){const e=Gd(t);return this._delegate.get(e).then(t=>new Ud(this._firestore,new Hl(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,e.converter)))}set(t,e,n){var r=Gd(t);return n?(_d("Transaction.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this}update(t,e,n,...r){var s=Gd(t);return 2===arguments.length?this._delegate.update(s,e):this._delegate.update(s,e,n,...r),this}delete(t){var e=Gd(t);return this._delegate.delete(e),this}}class Ld{constructor(t){this._delegate=t}set(t,e,n){var r=Gd(t);return n?(_d("WriteBatch.set",n),this._delegate.set(r,e,n)):this._delegate.set(r,e),this}update(t,e,n,...r){var s=Gd(t);return 2===arguments.length?this._delegate.update(s,e):this._delegate.update(s,e,n,...r),this}delete(t){var e=Gd(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class Od{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){var n=new zl(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new qd(this._firestore,n),null!=e?e:{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){const n=Od.INSTANCES;let r=n.get(t);r||(r=new WeakMap,n.set(t,r));let s=r.get(e);return s||(s=new Od(t,new kd(t),e),r.set(e,s)),s}}Od.INSTANCES=new WeakMap;class Md{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new kd(t)}static forPath(t,e,n){if(t.length%2!=0)throw new Nr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${t.canonicalString()} has ${t.length}`);return new Md(e,new $u(e._delegate,n,new is(t)))}static forKey(t,e,n){return new Md(e,new $u(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new $d(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new $d(this.firestore,zu(this._delegate,t))}catch(t){throw Fd(t,"collection()","DocumentReference.collection()")}}isEqual(t){return(t=m(t))instanceof $u&&Wu(this._delegate,t)}set(t,e){e=_d("DocumentReference.set",e);try{return e?pd(this._delegate,t,e):pd(this._delegate,t)}catch(t){throw Fd(t,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return 1===arguments.length?yd(this._delegate,t):yd(this._delegate,t,e,...n)}catch(t){throw Fd(t,"updateDoc()","DocumentReference.update()")}}delete(){return bd(Uu((t=this._delegate).firestore,rl),[new Ci(t._key,yi.none())]);var t}onSnapshot(...t){var e=Pd(t),n=Vd(t,t=>new Ud(this.firestore,new Hl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)));return vd(this._delegate,e,n)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?gd:"server"===(null==t?void 0:t.source)?function(e){e=Uu(e,$u);const n=Uu(e.firestore,rl);return Du(sl(n),e._key,{source:"server"}).then(t=>Ed(n,e,t))}:function(e){e=Uu(e,$u);const n=Uu(e.firestore,rl);return Du(sl(n),e._key).then(t=>Ed(n,e,t))})(this._delegate),e.then(t=>new Ud(this.firestore,new Hl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)))}withConverter(t){return new Md(this.firestore,t?this._delegate.withConverter(Od.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function Fd(t,e,n){return t.message=t.message.replace(e,n),t}function Pd(t){for(const e of t)if("object"==typeof e&&!Dd(e))return e;return{}}function Vd(t,e){var n;let r;return r=Dd(t[0])?t[0]:Dd(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]},{next:t=>{r.next&&r.next(e(t))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Ud{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new Md(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Wl(this._delegate,t._delegate)}}class qd extends Ud{data(t){var e=this._delegate.data(t);return void 0!==e||Ir(),e}}class Bd{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new kd(t)}where(t,e,n){try{return new Bd(this.firestore,Jl(this._delegate,(r=n,s=e,i=$l("where",t),new Zl(i,s,r))))}catch(t){throw Fd(t,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(t,e){try{return new Bd(this.firestore,Jl(this._delegate,([n,r="asc"]=[t,e],s=r,i=$l("orderBy",n),new td(i,s))))}catch(t){throw Fd(t,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(t){try{return new Bd(this.firestore,Jl(this._delegate,(qu("limit",e=t),new ed("limit",e,"F"))))}catch(t){throw Fd(t,"limit()","Query.limit()")}var e}limitToLast(t){try{return new Bd(this.firestore,Jl(this._delegate,(qu("limitToLast",e=t),new ed("limitToLast",e,"L"))))}catch(t){throw Fd(t,"limitToLast()","Query.limitToLast()")}var e}startAt(...t){try{return new Bd(this.firestore,Jl(this._delegate,function(...t){return new nd("startAt",t,!0)}(...t)))}catch(t){throw Fd(t,"startAt()","Query.startAt()")}}startAfter(...t){try{return new Bd(this.firestore,Jl(this._delegate,function(...t){return new nd("startAfter",t,!1)}(...t)))}catch(t){throw Fd(t,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new Bd(this.firestore,Jl(this._delegate,function(...t){return new rd("endBefore",t,!0)}(...t)))}catch(t){throw Fd(t,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new Bd(this.firestore,Jl(this._delegate,function(...t){return new rd("endAt",t,!1)}(...t)))}catch(t){throw Fd(t,"endAt()","Query.endAt()")}}isEqual(t){return Yu(this._delegate,t._delegate)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?md:"server"===(null==t?void 0:t.source)?function(e){e=Uu(e,Gu);const n=Uu(e.firestore,rl),t=sl(n),r=new fd(n);return Cu(t,e._query,{source:"server"}).then(t=>new Ql(n,r,e,t))}:function(e){e=Uu(e,Gu);const n=Uu(e.firestore,rl),t=sl(n),r=new fd(n);return Yl(e._query),Cu(t,e._query).then(t=>new Ql(n,r,e,t))})(this._delegate),e.then(t=>new Kd(this.firestore,new Ql(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)))}onSnapshot(...t){var e=Pd(t),n=Vd(t,t=>new Kd(this.firestore,new Ql(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)));return vd(this._delegate,e,n)}withConverter(t){return new Bd(this.firestore,t?this._delegate.withConverter(Od.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}class jd{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new qd(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Kd{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new Bd(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new qd(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(t=>new jd(this._firestore,t))}forEach(e,n){this._delegate.forEach(t=>{e.call(n,new qd(this._firestore,t))})}isEqual(t){return Wl(this._delegate,t._delegate)}}class $d extends Bd{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var t=this._delegate.parent;return t?new Md(this.firestore,t):null}doc(t){try{return void 0===t?new Md(this.firestore,Qu(this._delegate)):new Md(this.firestore,Qu(this._delegate,t))}catch(t){throw Fd(t,"doc()","CollectionReference.doc()")}}add(t){return function(t,e){const n=Uu(t.firestore,rl),r=Qu(t),s=cd(t.converter,e);return bd(n,[Il(Tl(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,yi.exists(!1))]).then(()=>r)}(this._delegate,t).then(t=>new Md(this.firestore,t))}isEqual(t){return Wu(this._delegate,t._delegate)}withConverter(t){return new $d(this.firestore,t?this._delegate.withConverter(Od.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function Gd(t){return Uu(t,$u)}const Hd={Firestore:xd,GeoPoint:ml,Timestamp:Ur,Blob:Ad,Transaction:Rd,WriteBatch:Ld,DocumentReference:Md,DocumentSnapshot:Ud,Query:Bd,QueryDocumentSnapshot:qd,QuerySnapshot:Kd,CollectionReference:$d,FieldPath:class zd{constructor(...t){this._delegate=new dl(...t)}static documentId(){return new zd(zr.keyField().canonicalString())}isEqual(t){return(t=m(t))instanceof dl&&this._delegate._internalPath.isEqual(t._internalPath)}},FieldValue:class Qd{constructor(t){this._delegate=t}static serverTimestamp(){const t=new Nl("serverTimestamp");return t._methodName="FieldValue.serverTimestamp",new Qd(t)}static delete(){const t=new _l("deleteField");return t._methodName="FieldValue.delete",new Qd(t)}static arrayUnion(...t){const e=function(...t){return new Al("arrayUnion",t)}(...t);return e._methodName="FieldValue.arrayUnion",new Qd(e)}static arrayRemove(...t){const e=function(...t){return new Dl("arrayRemove",t)}(...t);return e._methodName="FieldValue.arrayRemove",new Qd(e)}static increment(t){const e=new Cl("increment",t);return e._methodName="FieldValue.increment",new Qd(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}},setLogLevel:function(t){t=t,yr.setLogLevel(t)},CACHE_SIZE_UNLIMITED:-1};el=e.default,nl=(t,e)=>new xd(t,e,new Cd),el.INTERNAL.registerComponent(new i("firestore-compat",t=>{var e=t.getProvider("app-compat").getImmediate(),n=t.getProvider("firestore").getImmediate();return nl(e,n)},"PUBLIC").setServiceProps(Object.assign({},Hd))),el.registerVersion("@firebase/firestore-compat","0.1.8")}).apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
